<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Samar State University</title>
  <link rel="icon"
    href="images/logo-removebg-preview.png" />
  <style>
    :root {
      --ssu-primary: #0297D4;
      --ssu-accent: #F2B632;
      --ssu-bg: #F5F7FA;
      --ssu-surface: #FFFFFF;
      --ssu-heading: #102840;
      --ssu-text: #4B5563;
      --ssu-border: #D3D7DF;
      --ssu-muted: #9CA3AF;
      --ssu-danger: #DC2626;
      --ssu-success: #059669;

      --radius-md: 10px;
      --radius-lg: 16px;
      --shadow-soft: 0 10px 25px rgba(16, 40, 64, 0.12);
      --shadow-strong: 0 18px 38px rgba(16, 40, 64, 0.16);
      --glass: rgba(255, 255, 255, 0.9);
      --transition-fast: 0.2s ease;
      --header-height: 64px;
      --sidebar-width: 260px;


      --gamer-primary: #7c3aed;
      --gamer-accent: #00f5ff;
      --gamer-hot: #f472b6;
      --gamer-bg: #080b1a;
      --gamer-surface: #0f162d;
      --gamer-glow: 0 0 24px rgba(124, 58, 237, 0.45), 0 0 18px rgba(0, 245, 255, 0.25);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, rgba(2, 151, 212, 0.08), transparent 60%), var(--ssu-bg);
      color: var(--ssu-text);
      min-height: 100vh;
      line-height: 1.55;
    }

    a {
      color: var(--ssu-primary);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    button {
      font-family: inherit;
      cursor: pointer;
    }


    .hidden {
      display: none !important;
    }

    .text-muted {
      color: var(--ssu-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .badge-pill-primary {
      background: rgba(2, 151, 212, 0.08);
      color: var(--ssu-primary);
    }

    .badge-pill-accent {
      background: rgba(242, 182, 50, 0.12);
      color: #B7791F;
    }

    .badge-pill-danger {
      background: rgba(220, 38, 38, 0.08);
      color: var(--ssu-danger);
    }

    .badge-pill-success {
      background: rgba(5, 150, 105, 0.08);
      color: var(--ssu-success);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      border: 1px solid var(--ssu-border);
      font-size: 0.75rem;
      background: #fff;
      color: var(--ssu-muted);
      gap: 0.25rem;
    }


    body.gamer-mode .tag {
      background: linear-gradient(120deg, rgba(124, 58, 237, 0.22), rgba(0, 245, 255, 0.18));
      border-color: rgba(0, 245, 255, 0.45);
      color: #e8ecff;
      box-shadow: 0 8px 18px rgba(0, 245, 255, 0.18);
    }

    body.gamer-mode .tag .tag-dot {
      background: #00f5ff;
      box-shadow: 0 0 0 6px rgba(0, 245, 255, 0.2);
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--ssu-primary);
    }


    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.6rem 1.1rem;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.01em;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--ssu-primary), #03aee0);
      color: #fff;
      box-shadow: 0 8px 18px rgba(2, 151, 212, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(2, 151, 212, 0.35);
    }

    .btn-accent {
      background: linear-gradient(135deg, var(--ssu-accent), #ffd452);
      color: #1f2933;
      box-shadow: 0 8px 18px rgba(242, 182, 50, 0.3);
    }

    .btn-outline {
      background: transparent;
      color: var(--ssu-primary);
      border: 1px solid rgba(2, 151, 212, 0.5);
    }

    .btn-outline:hover {
      background: rgba(2, 151, 212, 0.04);
    }

    .btn-ghost {
      background: transparent;
      border: none;
      color: var(--ssu-muted);
      padding: 0.4rem 0.8rem;
    }

    .btn-ghost:hover {
      background: rgba(16, 40, 64, 0.06);
    }

    .btn:disabled,
    .btn[disabled] {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-sm {
      padding: 0.35rem 0.8rem;
      font-size: 0.8rem;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 0.9rem;
    }

    .input-group label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--ssu-heading);
    }

    .input,
    select,
    textarea {
      border-radius: 999px;
      border: 1px solid var(--ssu-border);
      padding: 0.55rem 0.9rem;
      font-size: 0.9rem;
      outline: none;
      background: #fff;
      transition: border var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    ::placeholder {
      color: var(--ssu-muted);
      opacity: 0.8;
    }

    textarea {
      border-radius: 10px;
      min-height: 80px;
      resize: vertical;
    }

    .input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(2, 151, 212, 0.75);
      box-shadow: 0 0 0 1px rgba(2, 151, 212, 0.15);
      background: #fff;
    }

    .input-error {
      border-color: var(--ssu-danger);
    }

    .helper-text {
      font-size: 0.75rem;
      color: var(--ssu-muted);
    }


    body.gamer-mode .input,
    body.gamer-mode select,
    body.gamer-mode textarea {
      background: linear-gradient(135deg, rgba(18, 24, 45, 0.9), rgba(11, 17, 35, 0.92));
      border: 1px solid rgba(0, 245, 255, 0.35);
      color: #e8ecff;
      box-shadow: 0 8px 18px rgba(0, 245, 255, 0.12);
    }

    body.gamer-mode select option {
      background: #0f162d;
      color: #e8ecff;
    }

    body.gamer-mode select option:disabled {
      color: #7f8bae;
    }

    body.gamer-mode .input:disabled,
    body.gamer-mode select:disabled,
    body.gamer-mode textarea:disabled {
      background: rgba(18, 24, 45, 0.6);
      color: #9aa5c8;
      border-color: rgba(124, 58, 237, 0.25);
    }

    body.gamer-mode .input:focus,
    body.gamer-mode select:focus,
    body.gamer-mode textarea:focus {
      border-color: rgba(0, 245, 255, 0.6);
      box-shadow: 0 0 0 1px rgba(0, 245, 255, 0.35), 0 12px 24px rgba(0, 245, 255, 0.2);
      background: linear-gradient(135deg, rgba(24, 31, 58, 0.95), rgba(11, 17, 35, 0.95));
    }

    body.gamer-mode label {
      color: #dbe4ff;
      letter-spacing: 0.01em;
    }

    .alert {
      border-radius: 12px;
      padding: 0.6rem 0.9rem;
      font-size: 0.85rem;
      display: flex;
      align-items: flex-start;
      gap: 0.45rem;
      margin-bottom: 0.8rem;
    }

    .alert-icon {
      margin-top: 2px;
      font-size: 1.1rem;
    }

    .alert-success {
      background: rgba(5, 150, 105, 0.06);
      border: 1px solid rgba(5, 150, 105, 0.4);
      color: var(--ssu-success);
    }

    .alert-error {
      background: rgba(220, 38, 38, 0.05);
      border: 1px solid rgba(220, 38, 38, 0.4);
      color: var(--ssu-danger);
    }

    .alert-info {
      background: rgba(2, 151, 212, 0.08);
      border: 1px solid rgba(2, 151, 212, 0.35);
      color: var(--ssu-primary);
    }

    .chip-switch {
      display: inline-flex;
      border-radius: 999px;
      padding: 3px;
      background: rgba(16, 40, 64, 0.06);
      gap: 2px;
    }

    .chip-switch button {
      border-radius: 999px;
      border: none;
      padding: 0.3rem 0.8rem;
      font-size: 0.8rem;
      background: transparent;
      color: var(--ssu-muted);
    }

    .chip-switch button.active {
      background: #fff;
      color: var(--ssu-heading);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.15);
    }


    .hero-image-wrapper {
      position: relative;
      width: 100%;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.55);
      background: rgba(15, 23, 42, 0.4);
      aspect-ratio: 16 / 9;
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.45);
    }

    .hero-image {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }


    #auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
    }

    .auth-shell {
      max-width: 1080px;
      width: 100%;
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap: 2.5rem;
      background: linear-gradient(135deg, var(--glass), rgba(2, 151, 212, 0.04));
      border-radius: 26px;
      padding: 2.2rem 2.4rem;
      box-shadow: var(--shadow-strong);
      border: 1px solid rgba(211, 215, 223, 0.85);
      backdrop-filter: blur(6px);
    }

    .auth-brand {
      border-radius: 20px;
      padding: 1.8rem 1.5rem;
      background: linear-gradient(145deg, #07192f, #0e3056);
      color: #f9fafb;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }

    .auth-brand::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(2, 151, 212, 0.45), transparent 60%),
        radial-gradient(circle at 100% 0%, rgba(242, 182, 50, 0.3), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .auth-brand-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 1.8rem;
      height: 100%;
    }

    .auth-logo-circle {
      width: 52px;
      height: 52px;
      border-radius: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.7);
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 0.8rem;
      text-transform: uppercase;
    }

    .auth-heading {
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1.3;
    }

    .auth-subtitle {
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .auth-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .auth-pill {
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .auth-pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .auth-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: #cbd5f5;
      margin-top: auto;
    }

    .auth-meta span strong {
      color: #e5e7eb;
    }

    .auth-panel {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .auth-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 1rem;
    }

    .auth-panel-header h1 {
      font-size: 1.4rem;
      color: var(--ssu-heading);
    }

    .auth-panel-header p {
      font-size: 0.85rem;
      color: var(--ssu-muted);
    }

    .auth-switch-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.4rem;
      margin-bottom: 0.4rem;
    }

    .auth-form-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 1.3rem 1.5rem;
      border: 1px solid rgba(211, 215, 223, 0.9);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.94), #ffffff);
    }

    .auth-form-footer {
      margin-top: 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }

    .role-card-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.7rem;
      margin-top: 0.3rem;
      margin-bottom: 0.4rem;
    }

    .role-card {
      border-radius: 14px;
      border: 1px solid var(--ssu-border);
      padding: 0.7rem 0.7rem;
      background: linear-gradient(145deg, #ffffff, #f8fbff);
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      cursor: pointer;
      transition: border var(--transition-fast), box-shadow var(--transition-fast), transform var(--transition-fast), background var(--transition-fast);
    }

    .role-card span.role-label {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--ssu-heading);
    }

    .role-card span.role-desc {
      font-size: 0.7rem;
      color: var(--ssu-muted);
    }

    .role-card-selected {
      border-color: var(--ssu-primary);
      box-shadow: 0 12px 22px rgba(2, 151, 212, 0.22);
      transform: translateY(-1px);
      background: linear-gradient(145deg, rgba(2, 151, 212, 0.04), #ffffff);
    }

    .role-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.7rem;
      color: #6b7280;
      background: rgba(15, 23, 42, 0.01);
    }

    .role-pill-dot-teacher {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--ssu-primary);
    }

    .role-pill-dot-cashier {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--ssu-accent);
    }

    .role-pill-dot-registrar {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #6366f1;
    }


    .module {
      min-height: 100vh;
      display: flex;
      background: var(--ssu-bg);
    }

    .module-shell {
      display: grid;
      grid-template-columns: var(--sidebar-width) minmax(0, 1fr);
      width: 100%;
      min-height: 100vh;
    }


    body.gamer-mode .module,
    body.gamer-mode .module-shell,
    body.gamer-mode .module-content,
    body.gamer-mode .module-body {
      background: transparent;
    }

    body.gamer-mode #teacher-module,
    body.gamer-mode #cashier-module,
    body.gamer-mode #registrar-module {
      background: transparent;
    }

    body.gamer-mode .module-body {
      padding: 1.5rem;
      background:
        linear-gradient(140deg, rgba(12, 15, 30, 0.75), rgba(8, 10, 22, 0.9));
      border-radius: 20px;
      box-shadow: 0 18px 34px rgba(0, 245, 255, 0.12);
    }

    .sidebar {
      background: linear-gradient(180deg, #071425, #102840);
      color: #e5e7eb;
      padding: 1.3rem 1.1rem;
      display: flex;
      flex-direction: column;
      gap: 1.3rem;
      box-shadow: 8px 0 22px rgba(15, 23, 42, 0.4);
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 0.55rem;
    }

    .sidebar-logo {
      width: 36px;
      height: 36px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .sidebar-title {
      display: flex;
      flex-direction: column;
    }

    .sidebar-title span:first-child {
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .sidebar-title span:last-child {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .sidebar-role {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .sidebar-nav {
      margin-top: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .sidebar-nav button {
      width: 100%;
      text-align: left;
      border-radius: 12px;
      padding: 0.5rem 0.7rem;
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.04);
      color: #cbd5f5;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      transition: transform var(--transition-fast), background var(--transition-fast);
    }

    .sidebar-nav button span.label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .sidebar-nav button:hover {
      background: rgba(2, 151, 212, 0.12);
      border-color: rgba(2, 151, 212, 0.35);
      transform: translateX(2px);
    }

    .sidebar-nav button.active {
      background: linear-gradient(135deg, rgba(2, 151, 212, 0.35), rgba(2, 151, 212, 0.08));
      color: #f9fafb;
      border-color: rgba(2, 151, 212, 0.45);
    }

    .sidebar-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .sidebar-footer .user-name {
      font-weight: 600;
      color: #e5e7eb;
    }

    .module-content {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .module-header-bar {
      min-height: var(--header-height);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.6rem;
      padding: 0.75rem 1.5rem;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(209, 213, 219, 0.8);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .module-header-main {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .module-header-main h2 {
      font-size: 1.1rem;
      color: var(--ssu-heading);
    }

    .module-header-main p {
      font-size: 0.8rem;
      color: var(--ssu-muted);
    }

    .module-header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }


    .mobile-nav {
      display: none;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem 0.25rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    .mobile-nav button {
      border: 1px solid var(--ssu-border);
      background: #fff;
      color: var(--ssu-heading);
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: 0.01em;
      white-space: nowrap;
      box-shadow: 0 8px 16px rgba(16, 40, 64, 0.08);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border var(--transition-fast);
    }

    .mobile-nav button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(16, 40, 64, 0.1);
    }

    .mobile-nav button.active {
      background: linear-gradient(135deg, var(--ssu-primary), #03aee0);
      color: #fff;
      border-color: rgba(2, 151, 212, 0.5);
    }

    .module-body {
      padding: 1.2rem 1.5rem 1.6rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      animation: fadeUp 0.45s ease;
    }

    .panel {
      background: var(--ssu-surface);
      border-radius: 18px;
      padding: 1rem 1.1rem;
      border: 1px solid rgba(209, 213, 219, 0.8);
      box-shadow: 0 18px 34px rgba(15, 23, 42, 0.06);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border var(--transition-fast);
      background: linear-gradient(180deg, #ffffff, rgba(249, 250, 251, 0.8));
    }

    .panel:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.08);
      border-color: rgba(2, 151, 212, 0.18);
    }


    body.gamer-mode {
      background:
        radial-gradient(circle at 25% 18%, rgba(124, 58, 237, 0.24), transparent 32%),
        radial-gradient(circle at 75% 22%, rgba(0, 245, 255, 0.22), transparent 38%),
        radial-gradient(circle at 50% 78%, rgba(244, 114, 182, 0.16), transparent 46%),
        linear-gradient(145deg, #060713, #0b0f1f);
      color: #e8ecff;
    }

    body.gamer-mode .auth-shell,
    body.gamer-mode .panel,
    body.gamer-mode .auth-form-card,
    body.gamer-mode .sidebar {
      background: linear-gradient(145deg, rgba(18, 24, 45, 0.94), rgba(11, 17, 35, 0.98));
      border-color: rgba(124, 58, 237, 0.45);
      box-shadow: var(--gamer-glow);
      color: #e8ecff;
      backdrop-filter: blur(10px);
    }

    body.gamer-mode .sidebar {
      background: linear-gradient(180deg, rgba(12, 15, 30, 0.95), rgba(8, 10, 22, 0.98));
    }

    body.gamer-mode .module-header-bar {
      background: linear-gradient(90deg, rgba(16, 22, 40, 0.9), rgba(17, 24, 59, 0.9));
      border-color: rgba(0, 245, 255, 0.35);
      color: #f8fafc;
      box-shadow: 0 8px 24px rgba(0, 245, 255, 0.15);
    }

    body.gamer-mode .module-header-main h2 {
      color: #e8ecff;
      text-shadow: 0 0 12px rgba(0, 245, 255, 0.35);
      letter-spacing: 0.01em;
    }

    body.gamer-mode .module-header-main p {
      color: #dbe4ff;
    }

    body.gamer-mode .btn-primary {
      background: linear-gradient(135deg, var(--gamer-primary), var(--gamer-accent));
      box-shadow: 0 12px 26px rgba(0, 245, 255, 0.35), 0 0 12px rgba(124, 58, 237, 0.35);
      color: #0b0f1f;
      border: 1px solid rgba(0, 245, 255, 0.5);
    }

    body.gamer-mode .btn-outline {
      border-color: rgba(0, 245, 255, 0.7);
      color: #9aefff;
    }

    body.gamer-mode .badge-pill-primary,
    body.gamer-mode .badge-pill-accent {
      background: linear-gradient(90deg, rgba(124, 58, 237, 0.2), rgba(0, 245, 255, 0.2));
      color: #c7d2ff;
    }

    body.gamer-mode .panel-title,
    body.gamer-mode .panel-subtitle,
    body.gamer-mode .auth-heading,
    body.gamer-mode .auth-subtitle {
      color: #e5e7eb;
    }

    body.gamer-mode .sidebar-nav button {
      background: linear-gradient(90deg, rgba(19, 24, 45, 0.6), rgba(12, 16, 32, 0.7));
      border: 1px solid rgba(124, 58, 237, 0.35);
      color: #e6ecff;
      font-weight: 700;
    }

    body.gamer-mode .sidebar-nav button:hover {
      background: linear-gradient(90deg, rgba(124, 58, 237, 0.28), rgba(0, 245, 255, 0.18));
      border-color: rgba(0, 245, 255, 0.45);
    }

    body.gamer-mode .sidebar-nav button.active {
      background: linear-gradient(120deg, rgba(124, 58, 237, 0.5), rgba(0, 245, 255, 0.35));
      color: #0b0f1f;
      box-shadow: 0 10px 24px rgba(124, 58, 237, 0.25);
      border-color: rgba(0, 245, 255, 0.6);
    }

    body.gamer-mode table thead {
      background: linear-gradient(90deg, rgba(124, 58, 237, 0.1), rgba(0, 245, 255, 0.12));
      color: #e8ecff;
    }

    body.gamer-mode table tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    body.gamer-mode table tbody tr:hover {
      background: rgba(124, 58, 237, 0.08);
    }


    body.gamer-mode .table-wrapper {
      background: linear-gradient(120deg, rgba(12, 15, 30, 0.95), rgba(14, 18, 35, 0.92));
      border-color: rgba(0, 245, 255, 0.3);
    }

    body.gamer-mode table {
      color: #dfe7ff;
      background: transparent;
    }

    body.gamer-mode th,
    body.gamer-mode td {
      color: #dfe7ff;
    }

    body.gamer-mode tbody tr {
      background: rgba(255, 255, 255, 0.01);
    }

    body.gamer-mode tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.03);
    }

    body.gamer-mode tbody tr:hover {
      background: rgba(0, 245, 255, 0.08);
    }

    body.gamer-mode .table-wrapper td button,
    body.gamer-mode .table-wrapper td a {
      color: #0b0f1f;
      background: linear-gradient(135deg, var(--gamer-accent), var(--gamer-primary));
      border: 1px solid rgba(0, 245, 255, 0.6);
      box-shadow: 0 8px 20px rgba(0, 245, 255, 0.2);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.55rem;
    }

    .panel-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--ssu-heading);
    }

    .panel-subtitle {
      font-size: 0.78rem;
      color: var(--ssu-muted);
    }


    body.gamer-mode .stat-card {
      background: linear-gradient(145deg, rgba(24, 29, 62, 0.95), rgba(17, 23, 47, 0.92));
      border: 1px solid rgba(124, 58, 237, 0.45);
      box-shadow: 0 14px 32px rgba(0, 245, 255, 0.18), 0 0 18px rgba(124, 58, 237, 0.22);
      color: #e8ecff;
    }

    body.gamer-mode .stat-value {
      color: #9aefff;
      text-shadow: 0 0 10px rgba(0, 245, 255, 0.35);
      font-weight: 800;
    }

    body.gamer-mode .stat-label {
      color: #d0d8ff;
    }

    body.gamer-mode .table-wrapper {
      border-color: rgba(124, 58, 237, 0.35);
      box-shadow: 0 12px 26px rgba(124, 58, 237, 0.12);
    }

    .panel-header-meta {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.8rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.8rem;
    }

    .grid-responsive {
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 0.9rem;
    }

    .stat-card {
      border-radius: 14px;
      padding: 0.8rem 0.85rem;
      border: 1px solid rgba(209, 213, 219, 0.9);
      background: linear-gradient(145deg, #ffffff, #f9fafb);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--ssu-muted);
    }

    .stat-value {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--ssu-heading);
    }

    .stat-chip {
      font-size: 0.7rem;
      color: var(--ssu-muted);
    }


    .table-wrapper {
      border-radius: 14px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      overflow-x: auto;
      overflow-y: hidden;
      background: #fff;
      -webkit-overflow-scrolling: touch;
    }

    .attendance-row-selected {
      background: rgba(2, 151, 212, 0.12);
    }

    table {
      width: 100%;
      min-width: 640px;
      border-collapse: collapse;
      font-size: 0.83rem;
    }

    thead {
      background: linear-gradient(180deg, #f7f9fb, #f1f5f9);
    }

    th,
    td {
      padding: 0.55rem 0.7rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: middle;
    }

    th {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--ssu-muted);
      cursor: default;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: rgba(2, 151, 212, 0.05);
      transition: background var(--transition-fast);
    }


    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    th.sortable {
      cursor: pointer;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .table-actions {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
    }


    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(2, 151, 212, 0.08), transparent 35%),
        radial-gradient(circle at 80% 30%, rgba(242, 182, 50, 0.08), transparent 38%),
        rgba(6, 12, 24, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      backdrop-filter: blur(6px);
    }

    .modal {
      position: relative;
      background: linear-gradient(145deg, #ffffff, #f7fbff);
      border-radius: 20px;
      max-width: 620px;
      width: 92%;
      padding: 1.25rem 1.35rem 1.3rem;
      box-shadow: 0 22px 60px rgba(6, 12, 24, 0.45);
      border: 1px solid rgba(2, 151, 212, 0.12);
      overflow: hidden;
    }

    .modal::before {
      content: "";
      position: absolute;
      inset: 0 0 auto 0;
      height: 5px;
      background: linear-gradient(90deg, var(--ssu-primary), #03aee0, var(--ssu-accent));
      opacity: 0.9;
    }

    .modal .input {
      border-radius: 12px;
      border-color: rgba(2, 151, 212, 0.35);
      box-shadow: inset 0 1px 2px rgba(2, 151, 212, 0.08);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.65rem;
      gap: 0.4rem;
    }

    .modal-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--ssu-heading);
    }

    .modal-body {
      font-size: 0.9rem;
      max-height: 60vh;
      overflow-y: auto;
      color: var(--ssu-text);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.4rem;
      margin-top: 0.7rem;
    }


    .tutorial-overlay {
      position: fixed;
      inset: 0;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 55;
      padding: 1rem;
    }

    .tutorial-highlight {
      position: absolute;
      border: 2px solid rgba(2, 151, 212, 0.85);
      border-radius: 14px;
      background: rgba(2, 151, 212, 0.08);
      pointer-events: none;
      z-index: 60;
      transition: all var(--transition-fast);
    }
    .tutorial-highlight::after {
      content: "";
      position: fixed;
      inset: 0;
      box-shadow: 0 0 0 9999px rgba(6, 12, 24, 0.55);
      border-radius: inherit;
    }

    .tutorial-pointer {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid var(--ssu-primary);
      box-shadow: 0 0 0 6px rgba(2, 151, 212, 0.15);
      top: -10px;
      left: -10px;
    }

    .tutorial-card {
      background: linear-gradient(145deg, #ffffff, #f7fbff);
      border-radius: 18px;
      width: min(560px, 100%);
      padding: 1.4rem 1.3rem 1.2rem;
      box-shadow: 0 22px 60px rgba(6, 12, 24, 0.45);
      border: 1px solid rgba(2, 151, 212, 0.12);
      position: relative;
    }

    .tutorial-steps {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .tutorial-dots {
      display: flex;
      gap: 0.35rem;
      align-items: center;
      margin-top: 0.4rem;
    }

    .tutorial-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: rgba(2, 151, 212, 0.25);
      transition: transform var(--transition-fast), background var(--transition-fast);
    }

    .tutorial-dot.active {
      background: var(--ssu-primary);
      transform: scale(1.1);
    }

    .tutorial-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      margin-top: 0.8rem;
    }


    .pill-tabs {
      display: inline-flex;
      background: rgba(15, 23, 42, 0.04);
      border-radius: 999px;
      padding: 3px;
      gap: 2px;
    }

    .pill-tabs button {
      border-radius: 999px;
      border: none;
      padding: 0.28rem 0.8rem;
      font-size: 0.8rem;
      background: transparent;
      color: var(--ssu-muted);
    }

    .pill-tabs button.active {
      background: #fff;
      color: var(--ssu-heading);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.15);
    }

    .deadline-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.8rem;
    }

    .deadline-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.4rem;
      padding: 0.35rem 0.45rem;
      border-radius: 10px;
      background: rgba(248, 250, 252, 0.8);
    }

    .announcement-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.8rem;
    }


    .search-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .search-bar input {
      flex: 1;
    }

    .amount-positive {
      color: var(--ssu-primary);
      font-weight: 600;
    }

    .amount-highlight {
      color: #b45309;
      font-weight: 600;
    }

    .status-paid {
      background: rgba(5, 150, 105, 0.06);
      color: var(--ssu-success);
    }

    .status-partial {
      background: rgba(242, 182, 50, 0.15);
      color: #92400e;
    }

    .status-overdue {
      background: rgba(220, 38, 38, 0.06);
      color: var(--ssu-danger);
    }

    .range-switch {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.04);
      padding: 3px;
      gap: 2px;
    }

    .range-switch button {
      border-radius: 999px;
      border: none;
      padding: 0.28rem 0.8rem;
      font-size: 0.8rem;
      background: transparent;
      color: var(--ssu-muted);
    }

    .range-switch button.active {
      background: #fff;
      color: var(--ssu-heading);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.15);
    }


    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .filter-row .input-group {
      margin-bottom: 0;
    }

    .doc-preview {
      border-radius: 12px;
      border: 1px dashed var(--ssu-border);
      padding: 0.6rem 0.7rem;
      font-size: 0.8rem;
      background: rgba(249, 250, 251, 0.8);
      min-height: 120px;
      white-space: pre-wrap;
    }


    @media (max-width: 900px) {
      .auth-shell {
        grid-template-columns: minmax(0, 1fr);
      }

      .auth-brand {
        order: -1;

        min-height: auto;
        padding: 1.4rem 1.2rem;
      }

      .module-shell {
        grid-template-columns: 220px minmax(0, 1fr);
      }

      .module-header-bar {
        flex-direction: column;
        align-items: flex-start;
        padding-inline: 1.2rem;
      }

      .module-header-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .mobile-nav {
        display: flex;
        position: sticky;
        top: var(--header-height);
        z-index: 19;
        background: rgba(245, 247, 250, 0.96);
        padding: 0.65rem 1.2rem 0.35rem;
      }

      .grid-3 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .grid-responsive {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 720px) {
      .module-shell {
        grid-template-columns: minmax(0, 1fr);
      }

      .sidebar {
        display: none;
      }

      .module-header-bar {
        padding-inline: 1rem;
      }

      .module-header-main h2 {
        font-size: 1rem;
      }

      .module-header-main p {
        font-size: 0.78rem;
      }

      .module-body {
        padding: 1rem 1rem 1.2rem;
      }

      .module-header-actions .tag {
        width: 100%;
      }

      .mobile-nav {
        padding-inline: 1rem;
        top: calc(var(--header-height) - 6px);
      }

      table {
        min-width: 480px;
      }

      .grid-3,
      .grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>

<body>
  <!-- AUTHENTICATION CONTAINER -->
  <section id="auth-container">
    <div class="auth-shell">
      <!-- Brand / Visual side -->
      <div class="auth-brand">
        <div class="auth-brand-inner">
          <div>
            <div class="auth-logo-circle"><img src="./images/logo-removebg-preview.png"
                alt="Samar State University campus" class="hero-image" /></div>
            <div style="margin-top: 1.4rem;">
              <h2 class="auth-heading">Samar State University</h2>
              <p class="auth-subtitle" style="margin-top: 0.5rem;">
                A Samar State University Integration System for Teachers, Cashiers, Registrar to collaborate on
                enrollment, grades, notification and payments
              </p>
            </div>

            <!-- Responsive local image placeholder -->
            <div style="margin-top: 1.1rem;">
              <div class="hero-image-wrapper">
                <img src="./images/ssupic.jpg" alt="Samar State University campus" class="hero-image" />
              </div>
            </div>

            <div style="margin-top: 1.2rem;" class="auth-pills">
              <!-- <span class="auth-pill"><span class="auth-pill-dot"></span> Real-time grade visibility</span>
              <span class="auth-pill"><span class="auth-pill-dot"></span> Integrated billing &amp; clearance</span>
              <span class="auth-pill"><span class="auth-pill-dot"></span> Centralized student records</span> -->
            </div>
          </div>

          <div class="auth-meta">
            <span>Campus: <strong>SSU Main</strong></span>
            <span class="text-muted">Powered by <strong>Team Kraeon</strong></span>
          </div>
        </div>
      </div>

      <!-- Forms side -->
      <div class="auth-panel">
        <div class="auth-panel-header">
          <div>
            <h1>Welcome to SSU SYSTEM</h1>
            <p>Sign in to continue or sign up.</p>
          </div>
        </div>

        <div class="auth-switch-row">
          <div class="chip-switch" aria-label="Login or registration selection">
            <button id="chip-login" class="active" type="button">Login</button>
            <button id="chip-register" type="button">Register</button>
          </div>
          <span class="text-muted" style="font-size: 0.75rem;">Use your SSU institutional email or ID</span>
        </div>

        <!-- LOGIN VIEW -->
        <div id="login-view" class="auth-form-card">
          <form id="login-form" novalidate>
            <div id="login-alert" class="alert alert-error hidden">
              <div class="alert-icon">!</div>
              <div><strong>Login failed.</strong> Please check your ID/email and password.</div>
            </div>

            <div class="input-group">
              <label for="login-identifier">Email or ID</label>
              <input id="login-identifier" class="input" type="text" placeholder="e.g. teacher@ssu.edu.ph or 2020-00123"
                required />
            </div>

            <div class="input-group">
              <label for="login-password">Password</label>
              <input id="login-password" class="input" type="password" placeholder="Enter your password" required />
            </div>

            <div class="auth-form-footer">
              <a href="#" id="forgot-password-link">Forgot password?</a>
            </div>

            <div
              style="margin-top: 0.6rem; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
              <button type="submit" class="btn btn-primary">Login to SSU</button>
              <!-- <button type="button" class="btn btn-ghost" id="quick-role-hint">View sample accounts</button> -->
            </div>
          </form>
        </div>

        <!-- REGISTER VIEW -->
        <div id="register-view" class="auth-form-card hidden">
          <form id="register-form" novalidate>
            <div id="register-alert" class="alert alert-error hidden">
              <div class="alert-icon">!</div>
              <div><strong>Registration incomplete.</strong> Please fill all fields and choose a role.</div>
            </div>

            <div class="input-group">
              <label for="reg-name">Full name</label>
              <input id="reg-name" class="input" type="text" placeholder="e.g. Prof. Juan Dela Cruz" required />
            </div>

            <div class="input-group">
              <label for="reg-identifier">Email or ID</label>
              <input id="reg-identifier" class="input" type="text" placeholder="e.g. registrar@ssu.edu.ph" required />
              <div class="helper-text">This will be used to log you in.</div>
            </div>

            <div class="input-group">
              <label>Choose your role</label>
              <div class="role-card-grid" aria-label="Role selection">
                <div class="role-card" data-role="teacher">
                  <span class="role-label">Teacher</span>
                  <span class="role-desc">Manage classes, grades, and attendance.</span>
                  <span class="role-pill"><span class="role-pill-dot-teacher"></span> Classroom &amp; grading</span>
                </div>
                <div class="role-card" data-role="cashier">
                  <span class="role-label">Cashier</span>
                  <span class="role-desc">Handle tuition, fees, and receipts.</span>
                  <span class="role-pill"><span class="role-pill-dot-cashier"></span> Billing &amp; payments</span>
                </div>
                <div class="role-card" data-role="registrar">
                  <span class="role-label">Registrar</span>
                  <span class="role-desc">Oversee student records and enrollment.</span>
                  <span class="role-pill"><span class="role-pill-dot-registrar"></span> Records &amp; clearance</span>
                </div>
              </div>
              <!-- <div class="helper-text">Your dashboard layout and tools will adapt to this role.</div> -->
            </div>

            <div class="grid-2" style="gap: 0.5rem;">
              <div class="input-group" style="margin-bottom: 0;">
                <label for="reg-password">Password</label>
                <input id="reg-password" class="input" type="password" placeholder="Create a password" required />
              </div>
              <div class="input-group" style="margin-bottom: 0;">
                <label for="reg-confirm">Confirm password</label>
                <input id="reg-confirm" class="input" type="password" placeholder="Re-type password" required />
              </div>
            </div>
            <div class="helper-text" style="margin-bottom: 0.6rem;">Use at least 8 characters with a mix of letters and
              numbers.</div>

            <div
              style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; margin-top: 0.4rem;">
              <button type="submit" class="btn btn-accent">Create SSU account</button>
              <span class="text-muted" style="font-size: 0.75rem;">Already have an account? <a href="#"
                  id="back-to-login-link">Login</a></span>
            </div>
          </form>
        </div>

      </div>
    </div>
  </section>

  <!-- TEACHER MODULE -->
  <section id="teacher-module" class="module hidden">
    <div class="module-shell">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo"><img src="./images/logo-removebg-preview.png" alt="Samar State University campus"
              class="hero-image" /></div>
          <div class="sidebar-title">
            <!-- <span>Integration</span> -->
            <span>Teacher Portal</span>
            <span class="sidebar-role" id="teacher-role-label">Teacher</span>
          </div>
        </div>

        <nav class="sidebar-nav" aria-label="Teacher navigation">
          <button class="active" data-module="teacher" data-panel="dashboard"><span class="label">Dashboard</span><span
              class="badge badge-pill-primary">Today</span></button>
          <button data-module="teacher" data-panel="classes"><span class="label">Classes</span></button>
          <button data-module="teacher" data-panel="grades"><span class="label">Grade encoding</span></button>
          <button data-module="teacher" data-panel="attendance"><span class="label">Attendance</span></button>
          <button data-module="teacher" data-panel="announcements"><span class="label">Announcements</span></button>
          <button data-module="teacher" data-panel="profile"><span class="label">Profile</span></button>
        </nav>

        <div class="sidebar-footer">
          <div>Signed in as</div>
          <div class="user-name" id="teacher-user-name">Prof. Sample</div>
          <button id="toggle-classic-teacher" class="btn-ghost btn-sm" type="button">Classic UI</button>
          <button id="logout-teacher" class="btn-ghost btn-sm" type="button">Logout</button>
        </div>
      </aside>

      <div class="module-content">
        <header class="module-header-bar">
          <div class="module-header-main">
            <h2>Teacher dashboard</h2>
            <p>Monitor your classes, grade deadlines, and student attendance.</p>
          </div>
          <div class="module-header-actions">
            <div class="tag"><span class="tag-dot"></span> SY 2024?2025, 2nd Semester</div>
            <button class="btn btn-outline btn-sm" type="button" id="teacher-refresh">Refresh data</button>
          </div>
        </header>

        <div class="mobile-nav" aria-label="Teacher navigation (mobile)">
          <button class="active" data-module="teacher" data-panel="dashboard">Dashboard</button>
          <button data-module="teacher" data-panel="classes">Classes</button>
          <button data-module="teacher" data-panel="grades">Grade encoding</button>
          <button data-module="teacher" data-panel="attendance">Attendance</button>
          <button data-module="teacher" data-panel="announcements">Announcements</button>
          <button data-module="teacher" data-panel="profile">Profile</button>
        </div>

        <main class="module-body">
          <!-- Teacher Dashboard Panel -->
          <section id="teacher-panel-dashboard" class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Today at a glance</div>
                <div class="panel-subtitle">Key teaching metrics across all your sections.</div>
              </div>
            </div>
            <div class="grid-3">
              <div class="stat-card">
                <div class="stat-label">Active classes today</div>
                <div class="stat-value" id="teacher-active-classes">0</div>
                <div class="stat-chip text-muted">BSIT, BSED, BEED</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Pending grade submissions</div>
                <div class="stat-value" id="teacher-pending-grades">0</div>
                <span class="badge badge-pill-accent">Due this week</span>
              </div>
              <div class="stat-card">
                <div class="stat-label">Attendance alerts</div>
                <div class="stat-value" id="teacher-attendance-alerts">0</div>
                <span class="badge badge-pill-danger">At-risk students</span>
              </div>
            </div>

            <div class="grid-responsive" style="margin-top: 0.9rem;">
              <div>
                <div class="panel-header" style="margin-bottom: 0.3rem;">
                  <div>
                    <div class="panel-title">Current classes</div>
                    <div class="panel-subtitle">Click a section to open class tools.</div>
                  </div>
                </div>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Section</th>
                        <th>Course code</th>
                        <th>Schedule</th>
                        <th>Room</th>
                        <th>Pending</th>
                        <th style="width: 1%;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="teacher-dashboard-class-list"></tbody>
                  </table>
                </div>
              </div>

              <div>
                <div class="panel" style="padding: 0.75rem 0.8rem;">
                  <div class="panel-header" style="margin-bottom: 0.35rem;">
                    <div>
                      <div class="panel-title">Upcoming grade deadlines</div>
                      <div class="panel-subtitle">Stay ahead of registrar submissions.</div>
                    </div>
                  </div>
                  <ul class="deadline-list" id="teacher-deadline-list"></ul>
                </div>

                <div class="panel" style="padding: 0.75rem 0.8rem; margin-top: 0.6rem;">
                  <div class="panel-header" style="margin-bottom: 0.35rem;">
                    <div>
                      <div class="panel-title">Recent announcements</div>
                    </div>
                  </div>
                  <ul class="announcement-list" id="teacher-announcement-list"></ul>
                </div>

                <div class="panel" style="padding: 0.75rem 0.8rem; margin-top: 0.6rem;">
                  <div class="panel-header" style="margin-bottom: 0.35rem;">
                    <div>
                      <div class="panel-title">Notifications</div>
                      <div class="panel-subtitle">Latest alerts for teachers.</div>
                    </div>
                  </div>
                  <ul class="announcement-list" id="teacher-notifications-list"></ul>
                </div>
              </div>
            </div>
          </section>

          <!-- Teacher Classes Panel -->
          <section id="teacher-panel-classes" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Class lists</div>
                <div class="panel-subtitle">Browse students per section and open profiles.</div>
              </div>
              <div class="panel-header-meta">
                <div class="pill-tabs" aria-label="Section selection" id="teacher-class-tabs"></div>
              </div>
            </div>

            <div id="teacher-no-students-message" class="alert alert-info hidden" style="margin-bottom: 0.6rem;">
              <div class="alert-icon">!</div>
              <div>
                You currently do not have any students assigned. Registrar will enroll learners to your class once they are ready.
              </div>
            </div>

            <div class="grid-responsive">
              <div>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Program</th>
                        <th>Year</th>
                        <th>Attendance</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="teacher-class-table-body"></tbody>
                  </table>
                </div>
              </div>

              <div>
                <div class="panel" style="padding: 0.75rem 0.85rem;">
                  <div class="panel-header" style="margin-bottom: 0.3rem;">
                    <div>
                      <div class="panel-title">Student preview</div>
                      <div class="panel-subtitle">Quick information from Registrar &amp; Cashier.</div>
                    </div>
                  </div>
                  <div id="teacher-student-preview" style="font-size: 0.82rem;" class="text-muted">
                    Select a student to see profile information such as program, enrollment status,
                    and payment clearance (synced from Registrar &amp; Cashier).
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Teacher Grades Panel -->
          <section id="teacher-panel-grades" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Grade encoding</div>
                <div class="panel-subtitle">Encode and submit grades, synced live with the Registrar.</div>
              </div>
              <div class="panel-header-meta">
                <span class="tag"><span class="tag-dot"></span> IT 321 - Web Development</span>
              </div>
            </div>

            <div id="teacher-grade-alert" class="alert hidden">
              <div class="alert-icon">!</div>
              <div id="teacher-grade-alert-text"></div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Midterm</th>
                    <th>Final</th>
                <th>Remarks</th>
                <th>Action</th>
                  </tr>
                </thead>
                <tbody id="teacher-grades-tbody"></tbody>
              </table>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.7rem;">
              <span class="helper-text">Grades will be visible to Registrar once submitted. Cashier uses final status
                for clearance.</span>
              <div style="display: flex; gap: 0.4rem;">
                <button type="button" class="btn btn-outline btn-sm" id="btn-save-grades">Save draft</button>
                <button type="button" class="btn btn-primary btn-sm" id="btn-submit-grades">Submit grades</button>
              </div>
            </div>

            <div class="panel" style="padding:0.8rem 0.9rem; margin-top:0.8rem;">
              <div class="panel-header" style="margin-bottom:0.35rem;">
                <div>
                  <div class="panel-title">Report card copy request</div>
                  <div class="panel-subtitle">Ask Registrar for a report card copy for a student.</div>
                </div>
              </div>
              <div id="teacher-report-alert" class="alert hidden">
                <div class="alert-icon">!</div>
                <div id="teacher-report-alert-text"></div>
              </div>
              <form id="teacher-report-form">
                <div class="grid-2" style="gap:0.6rem;">
                  <div class="input-group" style="margin-bottom:0;">
                    <label for="teacher-report-student">Student</label>
                    <select id="teacher-report-student">
                      <option value="">Select student</option>
                    </select>
                  </div>
                  <div class="input-group" style="margin-bottom:0;">
                    <label for="teacher-report-reason">Reason / Notes</label>
                    <input id="teacher-report-reason" class="input" type="text" placeholder="e.g. Parent request" />
                  </div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:0.4rem;">
                  <button type="submit" class="btn btn-primary btn-sm">Submit request</button>
                </div>
              </form>
              <div style="margin-top:0.7rem;">
                <div class="panel-title" style="font-size:0.9rem;">Recent requests</div>
                <div class="panel-subtitle" style="font-size:0.78rem;">Latest report card copy requests.</div>
                <ul class="announcement-list" id="teacher-report-list" style="margin-top:0.4rem;"></ul>
              </div>
            </div>
          </section>

          <!-- Teacher Attendance Panel -->
          <section id="teacher-panel-attendance" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Attendance tracking</div>
                <div class="panel-subtitle">Mark daily attendance and flag at-risk students.</div>
              </div>
              <div class="panel-header-meta">
                <span class="tag"><span class="tag-dot"></span> BSIT 3A - IT 321</span>
              </div>
            </div>

            <div id="teacher-attendance-alert" class="alert hidden">
              <div class="alert-icon">!</div>
              <div id="teacher-attendance-alert-text"></div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Remarks</th>
                  </tr>
                </thead>
                <tbody id="teacher-attendance-tbody"></tbody>
              </table>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 0.7rem; gap: 0.4rem;">
              <button type="button" class="btn btn-outline btn-sm" id="btn-flag-attendance">Flag at-risk</button>
              <button type="button" class="btn btn-primary btn-sm" id="btn-save-attendance">Save attendance</button>
            </div>
          </section>

          <!-- Teacher Announcements Panel -->
          <section id="teacher-panel-announcements" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Announcements &amp; messages</div>
                <div class="panel-subtitle">See updates from the Registrar and Cashier.</div>
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>From</th>
                    <th>Module</th>
                    <th>Subject</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody id="teacher-announcements-tbody"></tbody>
              </table>
            </div>
          </section>

          
          <section id="teacher-panel-profile" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Profile</div>
                <div class="panel-subtitle">Update your display name or ID/email.</div>
              </div>
            </div>
            <div id="teacher-profile-alert" class="alert hidden">
              <div class="alert-icon">!</div>
              <div id="teacher-profile-alert-text"></div>
            </div>
            <form id="teacher-profile-form">
              <div class="grid-2" style="gap:0.6rem;">
                <div class="input-group" style="margin-bottom:0;">
                  <label for="teacher-profile-name">Full name</label>
                  <input id="teacher-profile-name" class="input" type="text" placeholder="Your name" />
                </div>
                <div class="input-group" style="margin-bottom:0;">
                  <label for="teacher-profile-id">ID or email</label>
                  <input id="teacher-profile-id" class="input" type="text" placeholder="e.g. teacher@ssu.edu.ph" />
                </div>
              </div>
              <div class="grid-2" style="gap:0.6rem; margin-top:0.5rem;">
                <div class="input-group" style="margin-bottom:0;">
                  <label>Role</label>
                  <input class="input" type="text" value="teacher" disabled />
                </div>
                <div class="input-group" style="margin-bottom:0;">
                  <label for="teacher-profile-auth">Auth email (read-only)</label>
                  <input id="teacher-profile-auth" class="input" type="text" disabled />
                </div>
              </div>
              <div style="display:flex; justify-content:flex-end; gap:0.4rem; margin-top:0.6rem;">
                <button type="submit" class="btn btn-primary btn-sm">Save profile</button>
              </div>
            </form>
          </section>
        </main>
      </div>
    </div>
  </section>


  <section id="cashier-module" class="module hidden">
    <div class="module-shell">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo"><img src="./images/logo-removebg-preview.png" alt="Samar State University campus"
              class="hero-image" /></div>
          <div class="sidebar-title">
            <span>Cashier Portal</span>
            <span class="sidebar-role" id="cashier-role-label">Cashier</span>
          </div>
        </div>

        <nav class="sidebar-nav" aria-label="Cashier navigation">
          <button class="active" data-module="cashier" data-panel="dashboard"><span
              class="label">Dashboard</span></button>
          <button data-module="cashier" data-panel="transactions"><span class="label">Transactions</span></button>
          <button data-module="cashier" data-panel="summaries"><span class="label">Collections summary</span></button>
        </nav>

        <div class="sidebar-footer">
          <div>Signed in as</div>
          <div class="user-name" id="cashier-user-name">Cashier Sample</div>
          <button id="logout-cashier" class="btn-ghost btn-sm" type="button">Logout</button>
        </div>
      </aside>

      <div class="module-content">
        <header class="module-header-bar">
          <div class="module-header-main">
            <h2>Cashier dashboard</h2>
            <p>Search student accounts, process payments, and view summaries.</p>
          </div>
          <div class="module-header-actions">
            <span class="tag"><span class="tag-dot"></span> Window 1 - Main Campus</span>
            <button class="btn btn-outline btn-sm" type="button" id="cashier-refresh">Refresh</button>
          </div>
        </header>

        <div class="mobile-nav" aria-label="Cashier navigation (mobile)">
          <button class="active" data-module="cashier" data-panel="dashboard">Dashboard</button>
          <button data-module="cashier" data-panel="transactions">Transactions</button>
          <button data-module="cashier" data-panel="summaries">Collections summary</button>
        </div>

        <main class="module-body">
          <!-- Cashier Dashboard Panel -->
          <section id="cashier-panel-dashboard" class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Account search</div>
                <div class="panel-subtitle">Find students by ID or name to view balances and history.</div>
              </div>
            </div>

            <div class="search-bar" style="margin-bottom: 0.8rem;">
              <input id="cashier-search-input" class="input" type="text" placeholder="Search by Student ID or name" />
              <button id="cashier-search-btn" class="btn btn-primary btn-sm" type="button">Search</button>
            </div>

            <div id="cashier-search-alert" class="alert hidden">
              <div class="alert-icon">!</div>
              <div id="cashier-search-alert-text"></div>
            </div>

            <div class="grid-responsive">
              <div>
                <div class="panel" style="padding: 0.8rem 0.9rem;">
                  <div class="panel-header" style="margin-bottom: 0.4rem;">
                    <div>
                      <div class="panel-title">Student account</div>
                      <div class="panel-subtitle">Balance and clearance status.</div>
                    </div>
                  </div>
                  <div id="cashier-student-account" style="font-size: 0.82rem;">
                    <div><strong>Name:</strong> <span id="cashier-account-name" class="text-muted">-</span></div>
                    <div><strong>Student ID:</strong> <span id="cashier-account-id" class="text-muted">-</span></div>
                    <div><strong>Balance:</strong> <span id="cashier-account-balance" class="text-muted">-</span></div>
                    <div><strong>Status:</strong> <span id="cashier-account-status" class="text-muted">-</span></div>
                  </div>
                </div>

                <div class="panel" style="padding: 0.8rem 0.9rem; margin-top: 0.7rem;">
                  <div class="panel-header" style="margin-bottom: 0.4rem;">
                    <div>
                      <div class="panel-title">Process payment</div>
                      <div class="panel-subtitle">Tuition and other school fees.</div>
                    </div>
                  </div>
                  <div id="cashier-payment-message" class="alert hidden">
                    <div class="alert-icon">!</div>
                    <div></div>
                  </div>
                  <form id="cashier-payment-form">
                    <div class="grid-2" style="gap: 0.6rem;">
                      <div class="input-group" style="margin-bottom: 0;">
                        <label for="pay-student-id">Student ID</label>
                        <input id="pay-student-id" class="input" type="text" placeholder="Search first to auto-fill" />
                      </div>
                      <div class="input-group" style="margin-bottom: 0;">
                        <label for="pay-student-name">Student name</label>
                        <input id="pay-student-name" class="input" type="text"
                          placeholder="Search first to auto-fill" />
                      </div>
                    </div>
                    <div class="grid-2" style="gap: 0.6rem;">
                      <div class="input-group" style="margin-bottom: 0;">
                        <label for="pay-type">Fee type</label>
                        <select id="pay-type">
                          <option value="tuition">Tuition</option>
                          <option value="misc">Miscellaneous</option>
                          <option value="laboratory">Laboratory</option>
                          <option value="other">Other fees</option>
                        </select>
                      </div>
                      <div class="input-group" style="margin-bottom: 0;">
                        <label for="pay-amount">Amount (PHP)</label>
                        <input id="pay-amount" class="input" type="number" min="0" step="0.01" placeholder="0.00" />
                      </div>
                    </div>
                    <div class="input-group" style="margin-top: 0.4rem; margin-bottom: 0.5rem;">
                      <label for="pay-notes">Notes / OR number</label>
                      <input id="pay-notes" class="input" type="text" placeholder="Optional: OR no., remarks" />
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 0.4rem;">
                      <button type="button" class="btn btn-outline btn-sm" id="btn-clear-payment">Clear</button>
                      <button type="submit" class="btn btn-accent btn-sm">Confirm and generate receipt</button>
                    </div>
                  </form>
                </div>
              </div>

              <div>
                <div class="panel" style="padding: 0.8rem 0.9rem;">
                  <div class="panel-header" style="margin-bottom: 0.4rem;">
                    <div>
                      <div class="panel-title">Recent payments</div>
                      <div class="panel-subtitle">Today&apos;s processed transactions.</div>
                    </div>
                  </div>
                  <div class="table-wrapper">
                    <table>
                      <thead>
                        <tr>
                          <th>Time</th>
                          <th>Student</th>
                          <th>ID</th>
                          <th>Fee</th>
                          <th style="text-align: right;">Amount</th>
                          <th>Status</th>
                          <th>Receipt</th>
                        </tr>
                      </thead>
                      <tbody id="cashier-recent-payments-body"></tbody>
                    </table>
                  </div>
                  <div
                    style="display:flex; justify-content:flex-end; align-items:center; gap:0.4rem; margin-top:0.4rem;">
                    <button type="button" class="btn btn-outline btn-sm" id="cashier-recent-prev">&lt;</button>
                    <span class="text-muted" style="font-size:0.82rem;">Page <span
                        id="cashier-recent-page">1</span></span>
                    <button type="button" class="btn btn-outline btn-sm" id="cashier-recent-next">&gt;</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Cashier Transactions Panel -->
          <section id="cashier-panel-transactions" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Transaction list</div>
                <div class="panel-subtitle">Sortable list of payments with statuses.</div>
              </div>
              <div class="panel-header-meta">
                <select id="cashier-status-filter">
                  <option value="all">All statuses</option>
                  <option value="paid">Paid</option>
                  <option value="partial">Partial</option>
                  <option value="overdue">Overdue</option>
                </select>
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th class="sortable" data-sort-key="id">Student ID</th>
                    <th class="sortable" data-sort-key="name">Name</th>
                    <th class="sortable" data-sort-key="amount" style="text-align: right;">Amount</th>
                    <th>Fee type</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Receipt</th>
                  </tr>
                </thead>
                <tbody id="cashier-transactions-tbody">
                  <!-- Filled by JS with mock data -->
                </tbody>
              </table>
            </div>
            <div style="display:flex; justify-content:flex-end; align-items:center; gap:0.4rem; margin-top:0.4rem;">
              <button type="button" class="btn btn-outline btn-sm" id="cashier-txn-prev">&lt;</button>
              <span class="text-muted" style="font-size:0.82rem;">Page <span id="cashier-txn-page">1</span></span>
              <button type="button" class="btn btn-outline btn-sm" id="cashier-txn-next">&gt;</button>
            </div>

            <div style="margin-top: 0.8rem;">
              <div class="panel-header" style="margin-bottom: 0.3rem;">
                <div>
                  <div class="panel-title" id="cashier-balance-title">Students with remaining balance</div>
                  <div class="panel-subtitle">Loaded on demand from students collection.</div>
                </div>
                <div style="display:flex; gap:0.4rem; flex-wrap:wrap;">
                  <button type="button" class="btn btn-outline btn-sm" id="cashier-load-balances">Students with
                    balance</button>
                  <button type="button" class="btn btn-outline btn-sm" id="cashier-load-paid">Students paid</button>
                </div>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Student ID</th>
                      <th>Name</th>
                      <th>Program</th>
                      <th style="text-align:right;">Balance</th>
                    </tr>
                  </thead>
                  <tbody id="cashier-balance-tbody">
                    <tr>
                      <td colspan="4" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">Click "Students
                        with balance" to load data.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Cashier Summaries Panel -->
          <section id="cashier-panel-summaries" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Collection summary</div>
                <div class="panel-subtitle">High-level view of today, this week, and this month.</div>
              </div>
              <div class="panel-header-meta">
                <div class="range-switch" aria-label="Summary range" id="cashier-range-switch">
                  <button type="button" class="active" data-range="day">Today</button>
                  <button type="button" data-range="week">This week</button>
                  <button type="button" data-range="month">This month</button>
                </div>
              </div>
            </div>

            <div class="grid-3">
              <div class="stat-card">
                <div class="stat-label">Total collection</div>
                <div class="stat-value" id="summary-total">PHP 0.00</div>
                <div class="stat-chip">Includes tuition and other fees.</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Receipts issued</div>
                <div class="stat-value" id="summary-receipts">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Overdue accounts</div>
                <div class="stat-value" id="summary-overdue">0</div>
                <span class="badge badge-pill-danger">Monitor with Registrar</span>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </section>

  <!-- REGISTRAR MODULE -->
  <section id="registrar-module" class="module hidden">
    <div class="module-shell">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo"><img src="./images/logo-removebg-preview.png" alt="Samar State University campus"
              class="hero-image" /></div>
          <div class="sidebar-title">
            <span>Registrar Portal</span>
            <span class="sidebar-role" id="registrar-role-label">Registrar</span>
          </div>
        </div>

        <nav class="sidebar-nav" aria-label="Registrar navigation">
          <button class="active" data-module="registrar" data-panel="dashboard"><span
              class="label">Dashboard</span></button>

          <button data-module="registrar" data-panel="students"><span class="label">Student records</span></button>
          <button data-module="registrar" data-panel="enrollment"><span class="label">Enrollment</span></button>
          <button data-module="registrar" data-panel="approvals"><span class="label">Subject approvals</span></button>
          <button data-module="registrar" data-panel="documents"><span class="label">Documents (COR /
              TOR)</span></button>
          <button data-module="registrar" data-panel="profile"><span class="label">Profile</span></button>
        </nav>

        <div class="sidebar-footer">
          <div>Signed in as</div>
          <div class="user-name" id="registrar-user-name">Registrar Sample</div>
          <button id="logout-registrar" class="btn-ghost btn-sm" type="button">Logout</button>
        </div>
      </aside>

      <div class="module-content">
        <header class="module-header-bar">
          <div class="module-header-main">
            <h2>Registrar dashboard</h2>
            <p>Manage records, enrollment status, and clearance with Teacher and Cashier data.</p>
          </div>
          <div class="module-header-actions">
            <span class="tag"><span class="tag-dot"></span> Records Office - Main Campus</span>
          </div>
        </header>

        <div class="mobile-nav" aria-label="Registrar navigation (mobile)">
          <button class="active" data-module="registrar" data-panel="dashboard">Dashboard</button>
          <button data-module="registrar" data-panel="students">Student records</button>
          <button data-module="registrar" data-panel="enrollment">Enrollment</button>
          <button data-module="registrar" data-panel="approvals">Subject approvals</button>
          <button data-module="registrar" data-panel="documents">Documents (COR / TOR)</button>
          <button data-module="registrar" data-panel="profile">Profile</button>
        </div>

        <main class="module-body">
          <!-- Registrar Dashboard Panel -->
          <section id="registrar-panel-dashboard" class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Today&apos;s overview</div>
                <div class="panel-subtitle">Enrollment and records status.</div>
              </div>
            </div>

            <div class="grid-3">
              <div class="stat-card">
                <div class="stat-label">Students with complete grades</div>
                <div class="stat-value" id="reg-complete-grades">0</div>
                <div class="stat-chip">Synced from Teacher module.</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Cleared payments</div>
                <div class="stat-value" id="reg-cleared-payments">0</div>
                <div class="stat-chip">Synced from Cashier module.</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Pending enrollments</div>
                <div class="stat-value" id="reg-pending-enrollment">0</div>
                <span class="badge badge-pill-accent">Awaiting checks</span>
              </div>
            </div>

            <div class="grid-responsive" style="margin-top: 0.9rem;">
              <div>
                <div class="panel" style="padding: 0.8rem 0.9rem;">
                  <div class="panel-header" style="margin-bottom: 0.4rem;">
                    <div>
                      <div class="panel-title">Pending enrollment checks</div>
                      <div class="panel-subtitle">Requires both grades and payment clearance.</div>
                    </div>
                  </div>

                  <div class="table-wrapper">
                    <table>
                      <thead>
                        <tr>
                          <th>Student</th>
                          <th>Program / Year</th>
                          <th>Grades</th>
                          <th>Payment</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="reg-pending-checks-tbody"></tbody>
                    </table>
                  </div>
                </div>
                <div class="panel" style="padding: 0.8rem 0.9rem; margin-top: 0.6rem;">
                  <div class="panel-header" style="margin-bottom: 0.4rem;">
                    <div>
                      <div class="panel-title">Notifications</div>
                      <div class="panel-subtitle">Latest alerts for registrar.</div>
                    </div>
                  </div>
                  <ul class="announcement-list" id="registrar-notifications-list"></ul>
                </div>
              </div>

              <div>
                <div class="panel" style="padding: 0.8rem 0.9rem;">
                  <div class="panel-header" style="margin-bottom: 0.4rem;">
                    <div>
                      <div class="panel-title">Quick actions</div>
                    </div>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 0.4rem; font-size: 0.85rem;">
                    <button type="button" class="btn btn-primary btn-sm" id="btn-open-student-records">Open student
                      records</button>
                    <button type="button" class="btn btn-outline btn-sm" id="btn-open-approvals">Review subject
                      approvals</button>
                    <button type="button" class="btn btn-outline btn-sm" id="btn-open-documents">Generate COR /
                      TOR</button>
                    <span class="helper-text">These flows will automatically check grades and payment status.</span>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Registrar Enrollment Panel -->
          <section id="registrar-panel-enrollment" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Quick enroll</div>
                <div class="panel-subtitle">Add a student record, choose a class/section, and initialize checks.</div>
              </div>
            </div>
            <div id="reg-enroll-alert" class="alert hidden">
              <div class="alert-icon">!</div>
              <div id="reg-enroll-alert-text"></div>
            </div>
            <form id="reg-enroll-form">
              <div class="grid-2" style="gap: 0.6rem;">
                <div class="input-group" style="margin-bottom: 0;">
                  <label for="reg-enroll-id">Student ID</label>
                  <input id="reg-enroll-id" class="input" type="text" placeholder="e.g. 2024-0001" required />
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                  <label for="reg-enroll-name">Full name</label>
                  <input id="reg-enroll-name" class="input" type="text" placeholder="e.g. Jane Dela Cruz" required />
                </div>
              </div>
              <div class="grid-3" style="gap: 0.6rem; margin-top: 0.5rem;">
                <div class="input-group" style="margin-bottom: 0;">
                  <label for="reg-enroll-teacher">Assign to teacher</label>
                  <select id="reg-enroll-teacher">
                    <option value="">Select teacher</option>
                  </select>
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                  <label for="reg-enroll-class">Class / Section</label>
                  <select id="reg-enroll-class">
                    <option value="">Select class</option>
                  </select>
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                  <label for="reg-enroll-section">Section label (optional override)</label>
                  <input id="reg-enroll-section" class="input" type="text" placeholder="e.g. BSIT 3A" />
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                  <label for="reg-enroll-program">Program</label>
                  <select id="reg-enroll-program">
                    <option value="BSIT">BSIT</option>
                    <option value="BSED">BSED</option>
                    <option value="BEED">BEED</option>
                  </select>
                </div>
                <div class="input-group" style="margin-bottom: 0%;">
                  <label for="reg-enroll-year">Year level</label>
                  <select id="reg-enroll-year">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                  </select>
                </div>
                <div class="input-group" style="margin-bottom: 0%;">
                  <label for="reg-enroll-status">Status</label>
                  <select id="reg-enroll-status">
                    <option value="Enrolled">Enrolled</option>
                    <option value="Pending">Pending</option>
                    <option value="On hold">On hold</option>
                  </select>
                </div>
              </div>
              <div style="display: flex; justify-content: flex-end; gap: 0.4rem; margin-top: 0.6rem;">
                <button type="button" class="btn btn-outline btn-sm" id="reg-enroll-clear">Clear</button>
                <button type="submit" class="btn btn-primary btn-sm">Enroll student</button>
              </div>
            </form>
          </section>

          <!-- Registrar Students Panel -->
          <section id="registrar-panel-students" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Student records</div>
                <div class="panel-subtitle">Browse by program, year level, and search by student.</div>
              </div>
            </div>

            <div class="panel" style="padding: 0.8rem 0.9rem; margin-bottom: 0.6rem;">
              <div class="panel-header" style="margin-bottom: 0.3rem;">
                <div>
                  <div class="panel-title">Enrollment requests</div>
                  <div class="panel-subtitle">Review and approve or reject student enrollment requests.</div>
                </div>
                <div>
                  <!-- <button type="button" class="btn btn-outline btn-sm" id="reg-open-request-cta">Request
                    enrollment</button> -->
                  <button type="button" class="btn btn-outline btn-sm" id="reg-toggle-requests">Show requests</button>
                </div>
              </div>
              <div id="registrar-requests-container" class="hidden">
                <div class="table-wrapper" style="margin-bottom:0.6rem;">
                  <table>
                    <thead>
                      <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Program / Year</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="registrar-requests-tbody">
                      <tr>
                        <td colspan="5" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">Loading
                          requests...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div id="reg-requests-alert" class="alert hidden">
                  <div class="alert-icon">!</div>
                  <div id="reg-requests-alert-text"></div>
                </div>
              </div>
            </div>


            <div class="filter-row">
              <div class="input-group">
                <label for="reg-program-select">Program</label>
                <select id="reg-program-select">
                  <option value="all">All programs</option>
                  <option value="BSIT">BSIT</option>
                  <option value="BSED">BSED</option>
                  <option value="BEED">BEED</option>
                </select>
              </div>
              <div class="input-group">
                <label for="reg-year-select">Year level</label>
                <select id="reg-year-select">
                  <option value="all">All years</option>
                  <option value="1">1st Year</option>
                  <option value="2">2nd Year</option>
                  <option value="3">3rd Year</option>
                  <option value="4">4th Year</option>
                </select>
              </div>
              <div class="input-group" style="flex: 1;">
                <label for="reg-student-search">Student</label>
                <input id="reg-student-search" class="input" type="text" placeholder="Search by ID or name" />
              </div>
            </div>

            <div class="grid-responsive">
              <div>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Program</th>
                        <th>Year</th>
                        <th>Grades</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="registrar-students-tbody">
                      <!-- Filled by JS with mock data -->
                    </tbody>
                  </table>
                </div>
              </div>
              <div>
                <div class="panel" style="padding: 0.8rem 0.9rem;">
                  <div class="panel-header" style="margin-bottom: 0.4rem;">
                    <div>
                      <div class="panel-title">Student profile</div>
                      <div class="panel-subtitle">Record summary across modules.</div>
                    </div>
                  </div>
                  <div id="registrar-student-profile" style="font-size: 0.82rem;" class="text-muted">
                    Select a student on the left to view program, enrollment status, grade completion,
                    and cleared payments.
                  </div>
                  <div style="margin-top:0.6rem;">
                    <div class="panel-title" style="font-size:0.9rem;">Activity timeline</div>
                    <div class="panel-subtitle" style="font-size:0.78rem;">Recent payments, requests, and status
                      updates.</div>
                    <ul class="announcement-list" id="registrar-student-timeline" style="margin-top:0.35rem;"></ul>
                  </div>
                  <div id="registrar-status-actions" class="hidden"
                    style="margin-top: 0.6rem; display: flex; gap: 0.4rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-outline btn-sm" data-status="Pending">Mark Pending</button>
                    <button type="button" class="btn btn-outline btn-sm" data-status="On hold">Mark On hold</button>
                    <button type="button" class="btn btn-primary btn-sm" data-status="Ready">Mark Ready</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="panel" style="padding: 0.8rem 0.9rem; margin-top: 0.6rem;">
              <div class="panel-header" style="margin-bottom: 0.3rem;">
                <div>
                  <div class="panel-title">Report card requests</div>
                  <div class="panel-subtitle">Submitted by teachers; approve when ready.</div>
                </div>
                <div>
                  <button type="button" class="btn btn-outline btn-sm" id="reg-toggle-report">Show requests</button>
                </div>
              </div>
              <div id="reg-report-alert" class="alert hidden">
                <div class="alert-icon">!</div>
                <div id="reg-report-alert-text"></div>
              </div>
              <div id="registrar-report-container" class="hidden">
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Student</th>
                        <th>Class</th>
                        <th>Teacher</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="registrar-report-requests-tbody">
                      <tr>
                        <td colspan="6" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">Loading
                          requests...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- Registrar Approvals Panel -->
          <section id="registrar-panel-approvals" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Subject approvals</div>
                <div class="panel-subtitle">Simulate enrollment subject approvals with simple flows.</div>
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Program</th>
                    <th>Subject</th>
                    <th>Grades</th>
                    <th>Payment</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="registrar-approvals-tbody">
                  <!-- Filled by JS with mock data and approval simulation -->
                </tbody>
              </table>
            </div>
          </section>

          <!-- Registrar Documents Panel -->
          <section id="registrar-panel-documents" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Documents generation</div>
                <div class="panel-subtitle">Generate COR and TOR previews with clearance checks.</div>
              </div>
            </div>

            <div class="grid-responsive">
              <div>
                <div class="input-group">
                  <label for="reg-doc-student">Student ID</label>
                  <input id="reg-doc-student" class="input" type="text" placeholder="e.g. 2020-00123" />
                  <div class="helper-text">For demo, use 2020-00123, 2020-00456, or 2020-00789.</div>
                </div>
                <div class="input-group">
                  <label for="reg-doc-type">Document</label>
                  <select id="reg-doc-type">
                    <option value="cor">Certificate of Registration (COR)</option>
                    <option value="tor">Transcript of Records (TOR)</option>
                  </select>
                </div>
                <div id="registrar-doc-alert" class="alert hidden">
                  <div class="alert-icon">!</div>
                  <div id="registrar-doc-alert-text"></div>
                </div>
                <div style="display: flex; gap: 0.4rem;">
                  <button type="button" class="btn btn-primary btn-sm" id="btn-generate-doc">Generate preview</button>
                  <button type="button" class="btn btn-outline btn-sm" id="btn-clear-doc">Clear</button>
                </div>
              </div>
              <div>
                <div class="doc-preview" id="reg-doc-preview">
                  Document preview will appear here once the system confirms that grades are complete and
                  payments are cleared for the selected student.
                </div>
              </div>
            </div>
          </section>

          <!-- Registrar Profile Panel -->
          <section id="registrar-panel-profile" class="panel hidden">
            <div class="panel-header">
              <div>
                <div class="panel-title">Profile</div>
                <div class="panel-subtitle">Update your display name or ID/email.</div>
              </div>
            </div>
            <div id="registrar-profile-alert" class="alert hidden">
              <div class="alert-icon">!</div>
              <div id="registrar-profile-alert-text"></div>
            </div>
            <form id="registrar-profile-form">
              <div class="grid-2" style="gap:0.6rem;">
                <div class="input-group" style="margin-bottom:0;">
                  <label for="registrar-profile-name">Full name</label>
                  <input id="registrar-profile-name" class="input" type="text" placeholder="Your name" />
                </div>
                <div class="input-group" style="margin-bottom:0;">
                  <label for="registrar-profile-id">ID or email</label>
                  <input id="registrar-profile-id" class="input" type="text" placeholder="e.g. registrar@ssu.edu.ph" />
                </div>
              </div>
              <div class="grid-2" style="gap:0.6rem; margin-top:0.5rem;">
                <div class="input-group" style="margin-bottom:0;">
                  <label>Role</label>
                  <input class="input" type="text" value="registrar" disabled />
                </div>
                <div class="input-group" style="margin-bottom:0;">
                  <label for="registrar-profile-auth">Auth email (read-only)</label>
                  <input id="registrar-profile-auth" class="input" type="text" disabled />
                </div>
              </div>
              <div style="display:flex; justify-content:flex-end; gap:0.4rem; margin-top:0.6rem;">
                <button type="submit" class="btn btn-primary btn-sm">Save profile</button>
              </div>
            </form>
          </section>
        </main>
      </div>
    </div>
  </section>

  <!-- Modal for receipts and generic previews -->
  <div id="modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Modal</div>
        <button type="button" class="btn-ghost btn-sm" id="modal-close-btn">Close</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary btn-sm" id="modal-primary-btn">OK</button>
      </div>
    </div>
  </div>

  <!-- Tutorial overlay -->
  <div id="tutorial-overlay" class="tutorial-overlay hidden" role="dialog" aria-modal="true" aria-label="Tutorial">
    <div class="tutorial-card">
      <div class="panel-header" style="margin-bottom: 0.35rem;">
        <div>
          <div class="panel-title" id="tutorial-title">Welcome</div>
          <div class="panel-subtitle" id="tutorial-desc">Learn how to use the portal.</div>
        </div>
        <button type="button" class="btn-ghost btn-sm" id="tutorial-skip">Skip</button>
      </div>
      <div class="tutorial-steps">
        <div class="panel-subtitle" id="tutorial-body" style="color: var(--ssu-text);"></div>
        <div class="tutorial-dots" id="tutorial-dots"></div>
      </div>
      <div class="tutorial-actions">
        <button type="button" class="btn btn-outline btn-sm" id="tutorial-prev">Back</button>
        <div style="display:flex; gap:0.4rem;">
          <button type="button" class="btn btn-ghost btn-sm" id="tutorial-skip-2">Skip tutorial</button>
          <button type="button" class="btn btn-primary btn-sm" id="tutorial-next">Next</button>
        </div>
      </div>
    </div>
  </div>
  <div id="tutorial-highlight" class="tutorial-highlight hidden">
    <div class="tutorial-pointer"></div>
  </div>

  <!-- Gamer mode prompt -->
  <div id="gamer-overlay" class="tutorial-overlay hidden" role="dialog" aria-modal="true"
    aria-label="Gamer mode prompt">
    <div class="tutorial-card">
      <div class="panel-header" style="margin-bottom: 0.35rem;">
        <div>
          <div class="panel-title">Are you a gamer-teacher?</div>
          <div class="panel-subtitle">Switch to an RGB-inspired layout for your portal.</div>
        </div>
        <button type="button" class="btn-ghost btn-sm" id="gamer-skip">Skip</button>
      </div>
      <div class="panel-subtitle" style="color: var(--ssu-text); margin-bottom: 0.8rem;">
        Turn on gamer mode for neon accents, darker panels, and glow effects. You can change this later.
      </div>
      <div class="tutorial-actions">
        <button type="button" class="btn btn-outline btn-sm" id="gamer-no">No, keep classic</button>
        <div style="display:flex; gap:0.4rem;">
          <button type="button" class="btn btn-primary btn-sm" id="gamer-yes">Yes, enable RGB</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ==========================
    //  Firebase Setup
    // ==========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      sendPasswordResetEmail,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      getDocs,
      collection,
      query,
      where,
      onSnapshot,
      addDoc,
      deleteDoc,
      orderBy,
      limit,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBm63ZpU0mHFy6YKbcnUX1aWzPneD6re_8",
      authDomain: "websystem-8ba26.firebaseapp.com",
      projectId: "websystem-8ba26",
      storageBucket: "websystem-8ba26.appspot.com",
      messagingSenderId: "661733238982",
      appId: "1:661733238982:web:dd29847b51f859d1c20fc7",
      measurementId: "G-W8D0FL4W3N"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const TUTORIAL_KEY = "ssu_tutorial_seen_v1";

    // ==========================
    //  Helpers
    // ==========================
    const byId = (id) => document.getElementById(id);
    const show = (el) => el && el.classList.remove("hidden");
    const hide = (el) => el && el.classList.add("hidden");

    const downloadTextFile = (filename, content, mime = "text/plain") => {
      try {
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error("Download failed:", err);
      }
    };

    // Allow Email or ID for login/registration
    const normalizeIdentifier = (value) => {
      const v = value.trim();
      if (!v) return "";
      if (v.includes("@")) return v.toLowerCase();
      return `${v}@ssu.local`; // map ID -> fake email
    };
    const formatPeso = (amount) => {
      const formatted = Number(amount || 0).toLocaleString("en-PH", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      return "PHP " + formatted;
    };

    let currentUser = null;

    // ==========================
    //  DOM References (Auth)
    // ==========================
    const authContainer = byId("auth-container");

    const chipLogin = byId("chip-login");
    const chipRegister = byId("chip-register");
    const loginView = byId("login-view");
    const registerView = byId("register-view");

    const loginForm = byId("login-form");
    const loginAlert = byId("login-alert");
    const loginIdentifier = byId("login-identifier");
    const loginPassword = byId("login-password");
    const forgotPasswordLink = byId("forgot-password-link");
    const quickRoleHint = byId("quick-role-hint");

    const registerForm = byId("register-form");
    const registerAlert = byId("register-alert");
    const regName = byId("reg-name");
    const regIdentifier = byId("reg-identifier");
    const regPassword = byId("reg-password");
    const regConfirm = byId("reg-confirm");
    const backToLoginLink = byId("back-to-login-link");

    const roleCards = document.querySelectorAll(".role-card");
    let selectedRole = null;

    // ==========================
    //  DOM References (Modules)
    // ==========================
    const modules = {
      teacher: byId("teacher-module"),
      cashier: byId("cashier-module"),
      registrar: byId("registrar-module"),
    };

    const navSelector = (moduleKey, panelKey) =>
      `#${moduleKey}-module .sidebar-nav button[data-panel='${panelKey}'], #${moduleKey}-module .mobile-nav button[data-panel='${panelKey}']`;
    const findNavButton = (moduleKey, panelKey) =>
      moduleKey && panelKey ? document.querySelector(navSelector(moduleKey, panelKey)) : null;
    const findNavButtons = (moduleKey, panelKey) =>
      moduleKey && panelKey ? document.querySelectorAll(navSelector(moduleKey, panelKey)) : [];

    // Teacher DOM/state
    const teacherClassTabs = byId("teacher-class-tabs");
    const teacherClassTableBody = byId("teacher-class-table-body");
    const teacherGradesTbody = byId("teacher-grades-tbody");
    const teacherAttendanceTbody = byId("teacher-attendance-tbody");
    const teacherDeadlineList = byId("teacher-deadline-list");
    const teacherAnnouncementList = byId("teacher-announcement-list");
    const teacherAnnouncementsTable = byId("teacher-announcements-tbody");
    const teacherGradeAlert = byId("teacher-grade-alert");
    const teacherGradeAlertText = byId("teacher-grade-alert-text");
    const teacherAttendanceAlert = byId("teacher-attendance-alert");
    const teacherAttendanceAlertText = byId("teacher-attendance-alert-text");
    const teacherNoStudentsMessage = byId("teacher-no-students-message");
    const teacherRefreshButton = byId("teacher-refresh");
    const teacherNotificationsList = byId("teacher-notifications-list");
    const teacherReportForm = byId("teacher-report-form");
    const teacherReportStudent = byId("teacher-report-student");
    const teacherReportReason = byId("teacher-report-reason");
    const teacherReportList = byId("teacher-report-list");
    const teacherReportAlert = byId("teacher-report-alert");
    const teacherReportAlertText = byId("teacher-report-alert-text");
    const teacherProfileForm = byId("teacher-profile-form");
    const teacherProfileName = byId("teacher-profile-name");
    const teacherProfileId = byId("teacher-profile-id");
    const teacherProfileAuth = byId("teacher-profile-auth");
    const teacherProfileAlert = byId("teacher-profile-alert");
    const teacherProfileAlertText = byId("teacher-profile-alert-text");
    const btnSaveGrades = byId("btn-save-grades");
    const btnSubmitGrades = byId("btn-submit-grades");
    const btnSaveAttendance = byId("btn-save-attendance");
    const btnFlagAttendance = byId("btn-flag-attendance");

    let teacherClasses = [];
    let teacherCurrentClassId = null;
    let teacherStudents = [];
    let teacherGradesMap = {};
    let teacherAttendanceMap = {};
    let teacherEnrollmentChecks = new Map();
    let teacherSelectedStudentId = null;
    let teacherLastAttendanceAlertCount = null;
    let teacherLastAttendanceAlertClassId = null;

    const getClassLabel = (classId) => {
      if (!classId) return "";
      const fromTeacher = teacherClasses.find(c => c.id === classId);
      const fromRegistrar = (registrarClassesCache || []).find(c => c.id === classId);
      const cls = fromTeacher || fromRegistrar;
      if (!cls) return "";
      return cls.section || cls.courseCode || "";
    };

    const getStudentDocId = (student) => (student?.studentId || student?.id || "");


    let teacherNotifBuffers = [[], []];

    // Cashier DOM/state
    const cashierRecentBody = byId("cashier-recent-payments-body");
    const cashierTransactionsBody = byId("cashier-transactions-tbody");
    const cashierBalanceBody = byId("cashier-balance-tbody");
    const cashierLoadBalancesBtn = byId("cashier-load-balances");
    const cashierStatusFilter = byId("cashier-status-filter");
    const cashierRecentPrev = byId("cashier-recent-prev");
    const cashierRecentNext = byId("cashier-recent-next");
    const cashierRecentPage = byId("cashier-recent-page");
    const cashierLoadPaidBtn = byId("cashier-load-paid");
    const cashierBalanceTitle = byId("cashier-balance-title");
    const cashierTxnPrev = byId("cashier-txn-prev");
    const cashierTxnNext = byId("cashier-txn-next");
    const cashierTxnPage = byId("cashier-txn-page");
    let cashierPaymentsCache = [];
    let cashierNotifBuffers = [[], []];
    let cashierRecentCache = [];
    let cashierRecentPageIndex = 0;
    const CASHIER_RECENT_PAGE_SIZE = 10;
    let cashierTxnPageIndex = 0;
    const CASHIER_TXN_PAGE_SIZE = 10;
    const findPaymentById = (id) => {
      if (!id) return null;
      return (
        cashierRecentCache.find((p) => p.id === id) ||
        cashierPaymentsCache.find((p) => p.id === id) ||
        null
      );
    };

    
    const registrarStudentsBody = byId("registrar-students-tbody");
    const registrarStudentProfile = byId("registrar-student-profile");
    const registrarStatusActions = byId("registrar-status-actions");
    const registrarStudentTimeline = byId("registrar-student-timeline");
    const registrarProgramSelect = byId("reg-program-select");
    const registrarYearSelect = byId("reg-year-select");
    const registrarStudentSearch = byId("reg-student-search");
    const registrarApprovalsBody = byId("registrar-approvals-tbody");
    const registrarDocStudent = byId("reg-doc-student");
    const registrarDocType = byId("reg-doc-type");
    const registrarDocPreview = byId("reg-doc-preview");
    const registrarDocAlert = byId("registrar-doc-alert");
    const registrarDocAlertText = byId("registrar-doc-alert-text");
    const appModal = {
      backdrop: byId("modal-backdrop"),
      title: byId("modal-title"),
      body: byId("modal-body"),
      primary: byId("modal-primary-btn"),
      close: byId("modal-close-btn"),
    };

    const tutorialOverlay = byId("tutorial-overlay");
    const tutorialHighlight = byId("tutorial-highlight");
    const tutorialTitle = byId("tutorial-title");
    const tutorialDesc = byId("tutorial-desc");
    const tutorialBody = byId("tutorial-body");
    const tutorialDots = byId("tutorial-dots");
    const tutorialSkip = byId("tutorial-skip");
    const tutorialSkip2 = byId("tutorial-skip-2");
    const tutorialPrev = byId("tutorial-prev");
    const tutorialNext = byId("tutorial-next");
    const tutorialSteps = [
      {
        title: "Welcome to SSU Portal",
        desc: "Unified experience for Teachers, Cashiers, and Registrars.",
        body: "Use your role-based credentials to sign in. If you just registered, your role determines which module opens by default.",
        selector: ".module:not(.hidden) .sidebar",
      },
      {
        title: "Navigation",
        desc: "Left sidebar controls the module sections.",
        body: "Dashboard shows key stats. Classes/Transactions/Students tabs let you work with records. You can always switch panels from the sidebar.",
        selector: ".module:not(.hidden) .sidebar",
      },
      {
        title: "Saving & Sync",
        desc: "Actions auto-sync across modules.",
        body: "Grades save to Registrar, payments to Registrar and Teachers, and enrollment updates propagate to related views.",
        selector: ".module:not(.hidden) .module-header-bar",
      },
      {
        title: "Help & Notifications",
        desc: "Check notifications for cross-module updates.",
        body: "If you get stuck, skip this tutorial anytime and return via the Help/Notifications areas that surface key events.",
        selector: ".module:not(.hidden) .announcement-list, .module:not(.hidden) #teacher-notifications-list",
      },
    ];
    let tutorialIndex = 0;
    // Gamer mode DOM
    const gamerOverlay = byId("gamer-overlay");
    const gamerYes = byId("gamer-yes");
    const gamerNo = byId("gamer-no");
    const gamerSkip = byId("gamer-skip");
    const toggleClassicTeacher = byId("toggle-classic-teacher");
    const showAppModal = (title, html) => {
      if (!appModal.backdrop) return;
      if (appModal.title) appModal.title.textContent = title || "Preview";
      if (appModal.body) appModal.body.innerHTML = html || "";
      appModal.backdrop.classList.remove("hidden");
    };
    if (appModal.close && appModal.backdrop) {
      const hide = () => appModal.backdrop.classList.add("hidden");
      appModal.close.addEventListener("click", hide);
      appModal.primary?.addEventListener("click", hide);
      appModal.backdrop.addEventListener("click", (e) => {
        if (e.target === appModal.backdrop) hide();
      });
    }

    // Tutorial helpers
    const saveTutorialSeen = () => localStorage.setItem(TUTORIAL_KEY, "1");
    const hasSeenTutorial = () => localStorage.getItem(TUTORIAL_KEY) === "1";
    const markTutorialSeenRemote = async () => {
      try {
        if (currentUser) {
          await setDoc(doc(db, "users", currentUser.uid), { tutorialSeen: true }, { merge: true });
        }
      } catch (err) {
        console.error("Error marking tutorial as seen:", err);
      }
    };
    const updateGamerToggleLabel = () => {
      if (!toggleClassicTeacher) return;
      const on = document.body.classList.contains("gamer-mode");
      toggleClassicTeacher.textContent = on ? "Classic UI" : "Gamer UI";
    };
    const applyGamerMode = (on) => {
      document.body.classList.toggle("gamer-mode", !!on);
      updateGamerToggleLabel();
    };
    const saveGamerMode = async (on) => {
      try {
        if (currentUser) {
          await setDoc(doc(db, "users", currentUser.uid), { gamerMode: !!on }, { merge: true });
        }
      } catch (err) {
        console.error("Error saving gamer mode:", err);
      }
    };
    const positionTutorialHighlight = (selector) => {
      if (!tutorialHighlight) return;
      if (!selector) {
        tutorialHighlight.classList.add("hidden");
        return;
      }
      const target = document.querySelector(selector);
      if (!target) {
        tutorialHighlight.classList.add("hidden");
        return;
      }
      target.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
      const rect = target.getBoundingClientRect();
      const pad = 8;
      const top = rect.top + window.scrollY - pad;
      const left = rect.left + window.scrollX - pad;
      tutorialHighlight.style.top = `${top}px`;
      tutorialHighlight.style.left = `${left}px`;
      tutorialHighlight.style.width = `${rect.width + pad * 2}px`;
      tutorialHighlight.style.height = `${rect.height + pad * 2}px`;
      tutorialHighlight.classList.remove("hidden");
    };
    const renderTutorialDots = () => {
      if (!tutorialDots) return;
      tutorialDots.innerHTML = "";
      tutorialSteps.forEach((_, idx) => {
        const dot = document.createElement("div");
        dot.className = "tutorial-dot" + (idx === tutorialIndex ? " active" : "");
        tutorialDots.appendChild(dot);
      });
    };
    const renderTutorialStep = () => {
      const step = tutorialSteps[tutorialIndex];
      if (!step) return;
      if (tutorialTitle) tutorialTitle.textContent = step.title;
      if (tutorialDesc) tutorialDesc.textContent = step.desc;
      if (tutorialBody) tutorialBody.textContent = step.body;
      if (tutorialPrev) tutorialPrev.disabled = tutorialIndex === 0;
      if (tutorialNext) {
        tutorialNext.textContent = tutorialIndex === tutorialSteps.length - 1 ? "Finish" : "Next";
      }
      renderTutorialDots();
      positionTutorialHighlight(step.selector);
    };
    const showTutorial = () => {
      if (!tutorialOverlay) return;
      tutorialIndex = 0;
      renderTutorialStep();
      tutorialOverlay.classList.remove("hidden");
    };
    const hideTutorial = () => {
      if (tutorialOverlay) tutorialOverlay.classList.add("hidden");
      if (tutorialHighlight) tutorialHighlight.classList.add("hidden");
      saveTutorialSeen();
      markTutorialSeenRemote();
    };
    tutorialPrev?.addEventListener("click", () => {
      if (tutorialIndex > 0) {
        tutorialIndex -= 1;
        renderTutorialStep();
      }
    });
    tutorialNext?.addEventListener("click", () => {
      if (tutorialIndex < tutorialSteps.length - 1) {
        tutorialIndex += 1;
        renderTutorialStep();
      } else {
        hideTutorial();
      }
    });
    [tutorialSkip, tutorialSkip2]?.forEach((btn) => {
      if (btn) btn.addEventListener("click", hideTutorial);
    });
    window.addEventListener("resize", () => {
      const step = tutorialSteps[tutorialIndex];
      if (tutorialOverlay && !tutorialOverlay.classList.contains("hidden")) {
        positionTutorialHighlight(step?.selector);
      }
    });
    window.addEventListener("scroll", () => {
      const step = tutorialSteps[tutorialIndex];
      if (tutorialOverlay && !tutorialOverlay.classList.contains("hidden")) {
        positionTutorialHighlight(step?.selector);
      }
    });

    // Ensure toggle label reflects current mode on load
    updateGamerToggleLabel();

    // Gamer mode prompt handlers
    const showGamerPrompt = () => {
      if (gamerOverlay) gamerOverlay.classList.remove("hidden");
    };
    const hideGamerPrompt = () => {
      if (gamerOverlay) gamerOverlay.classList.add("hidden");
    };
    gamerYes?.addEventListener("click", async () => {
      applyGamerMode(true);
      await saveGamerMode(true);
      hideGamerPrompt();
    });
    gamerNo?.addEventListener("click", async () => {
      applyGamerMode(false);
      await saveGamerMode(false);
      hideGamerPrompt();
    });
    gamerSkip?.addEventListener("click", hideGamerPrompt);
    toggleClassicTeacher?.addEventListener("click", async () => {
      const isGamer = document.body.classList.contains("gamer-mode");
      const next = !isGamer;
      applyGamerMode(next);
      await saveGamerMode(next);
      if (next) hideGamerPrompt();
    });
    const teacherNameCache = {};
    const registrarRequestsBody = byId("registrar-requests-tbody");
    const regRequestsAlert = byId("reg-requests-alert");
    const regRequestsAlertText = byId("reg-requests-alert-text");
  const registrarProfileForm = byId("registrar-profile-form");
  const registrarProfileName = byId("registrar-profile-name");
  const registrarProfileId = byId("registrar-profile-id");
  const registrarProfileAuth = byId("registrar-profile-auth");
  const registrarProfileAlert = byId("registrar-profile-alert");
  const registrarProfileAlertText = byId("registrar-profile-alert-text");
  const btnOpenStudentRecords = byId("btn-open-student-records");
  const btnOpenApprovals = byId("btn-open-approvals");
  const btnOpenDocuments = byId("btn-open-documents");
    let publicEnrollForm = byId("public-enroll-form");
    let publicEnrollId = byId("public-enroll-id");
    let publicEnrollName = byId("public-enroll-name");
    let publicEnrollProgram = byId("public-enroll-program");
    let publicEnrollYear = byId("public-enroll-year");
    let publicEnrollReason = byId("public-enroll-reason");
    let publicEnrollAlert = byId("public-enroll-alert");
    let publicEnrollAlertText = byId("public-enroll-alert-text");
    const regOpenRequestBtn = null;
    const regOpenRequestCta = byId("reg-open-request-cta");
    const regToggleRequests = byId("reg-toggle-requests");
    const regRequestsContainer = byId("registrar-requests-container");
    const regRequestModal = document.createElement("div");
    regRequestModal.className = "modal-backdrop hidden";
    regRequestModal.id = "reg-request-backdrop";
    regRequestModal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Submit enrollment request</div>
        <button type="button" class="btn-ghost btn-sm" id="reg-request-close">Close</button>
      </div>
      <div class="modal-body">
        <div id="public-enroll-alert" class="alert hidden">
          <div class="alert-icon">!</div>
          <div id="public-enroll-alert-text"></div>
        </div>
        <form id="public-enroll-form">
          <div class="grid-2" style="gap:0.6rem;">
            <div class="input-group" style="margin-bottom:0;">
              <label for="public-enroll-id">Student ID</label>
              <input id="public-enroll-id" class="input" type="text" placeholder="e.g. 2025-0001" required />
            </div>
            <div class="input-group" style="margin-bottom:0;">
              <label for="public-enroll-name">Full name</label>
              <input id="public-enroll-name" class="input" type="text" placeholder="e.g. Jane Dela Cruz" required />
            </div>
          </div>
          <div class="grid-2" style="gap:0.6rem; margin-top:0.4rem;">
            <div class="input-group" style="margin-bottom:0;">
              <label for="public-enroll-program">Program</label>
              <select id="public-enroll-program">
                <option value="BSIT">BSIT</option>
                <option value="BSED">BSED</option>
                <option value="BEED">BEED</option>
              </select>
            </div>
            <div class="input-group" style="margin-bottom:0;">
              <label for="public-enroll-year">Year level</label>
              <select id="public-enroll-year">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
              </select>
            </div>
          </div>
          <div class="input-group" style="margin-top:0.4rem; margin-bottom:0.4rem;">
            <label for="public-enroll-reason">Reason / Notes</label>
            <input id="public-enroll-reason" class="input" type="text" placeholder="Optional: remarks" />
          </div>
          <div style="display:flex; justify-content:flex-end; gap:0.4rem;">
            <button type="submit" class="btn btn-primary btn-sm">Submit request</button>
          </div>
        </form>
      </div>
    </div>
  `;
    document.body.appendChild(regRequestModal);
    publicEnrollForm = regRequestModal.querySelector("#public-enroll-form");
    publicEnrollId = regRequestModal.querySelector("#public-enroll-id");
    publicEnrollName = regRequestModal.querySelector("#public-enroll-name");
    publicEnrollProgram = regRequestModal.querySelector("#public-enroll-program");
    publicEnrollYear = regRequestModal.querySelector("#public-enroll-year");
    publicEnrollReason = regRequestModal.querySelector("#public-enroll-reason");
    publicEnrollAlert = regRequestModal.querySelector("#public-enroll-alert");
    publicEnrollAlertText = regRequestModal.querySelector("#public-enroll-alert-text");
    let registrarStudentsCache = [];
    let registrarApprovalsUnsub = null;
    let registrarStudentsUnsub = null;
    let registrarRequestsUnsub = null;
    let registrarClassesCache = [];
    let registrarTeachersCache = [];
    let registrarReportUnsub = null;
    const regEnrollForm = byId("reg-enroll-form");
    const regEnrollId = byId("reg-enroll-id");
    const regEnrollName = byId("reg-enroll-name");
    const regEnrollTeacher = byId("reg-enroll-teacher");
    const regEnrollClass = byId("reg-enroll-class");
    const regEnrollSection = byId("reg-enroll-section");
    const regEnrollProgram = byId("reg-enroll-program");
    const regEnrollYear = byId("reg-enroll-year");
    const regEnrollStatus = byId("reg-enroll-status");
    const regEnrollAlert = byId("reg-enroll-alert");
    const regEnrollAlertText = byId("reg-enroll-alert-text");
    const regEnrollClear = byId("reg-enroll-clear");
    const cashierNotificationsList = byId("cashier-notifications-list");
    const registrarNotificationsList = byId("registrar-notifications-list");
    const registrarReportBody = byId("registrar-report-requests-tbody");
    const regReportAlert = byId("reg-report-alert");
    const regReportAlertText = byId("reg-report-alert-text");
    const regToggleReport = byId("reg-toggle-report");
    const regReportContainer = byId("registrar-report-container");
    let registrarNotifBuffers = [[], []];

    // ==========================
    //  Real-time subscriptions
    // ==========================
    let teacherUnsubs = [];
    let teacherStudentsUnsub = null;
    let teacherStudentsFallbackUnsubs = [];
    let teacherGradesUnsub = null;
    let teacherAttendanceUnsub = null;
    let teacherArtifactsUnsub = null;
    let teacherNotifsUnsubs = [];
    let teacherReportUnsub = null;
    let registrarUnsubscribe = null;
    let cashierUnsubscribe = null;
    let registrarNotifsUnsubs = [];
    let cashierNotifsUnsubs = [];

    const clearTeacherSubscription = () => {
      teacherUnsubs.forEach((u) => u && u());
      teacherUnsubs = [];
      if (teacherStudentsUnsub) {
        teacherStudentsUnsub();
        teacherStudentsUnsub = null;
      }
      teacherStudentsFallbackUnsubs.forEach((u) => u && u());
      teacherStudentsFallbackUnsubs = [];
      if (teacherGradesUnsub) {
        teacherGradesUnsub();
        teacherGradesUnsub = null;
      }
      if (teacherAttendanceUnsub) {
        teacherAttendanceUnsub();
        teacherAttendanceUnsub = null;
      }
      if (teacherArtifactsUnsub) {
        teacherArtifactsUnsub();
        teacherArtifactsUnsub = null;
      }
      teacherNotifsUnsubs.forEach((u) => u && u());
      teacherNotifsUnsubs = [];
      if (teacherReportUnsub) {
        teacherReportUnsub();
        teacherReportUnsub = null;
      }
    };
    const clearRegistrarSubscription = () => {
      if (registrarUnsubscribe) {
        registrarUnsubscribe();
        registrarUnsubscribe = null;
      }
      if (registrarApprovalsUnsub) {
        registrarApprovalsUnsub();
        registrarApprovalsUnsub = null;
      }
      if (registrarStudentsUnsub) {
        registrarStudentsUnsub();
        registrarStudentsUnsub = null;
      }
      if (registrarRequestsUnsub) {
        registrarRequestsUnsub();
        registrarRequestsUnsub = null;
      }
      registrarNotifsUnsubs.forEach((u) => u && u());
      registrarNotifsUnsubs = [];
      if (registrarReportUnsub) {
        registrarReportUnsub();
        registrarReportUnsub = null;
      }
    };
    const clearCashierSubscription = () => {
      if (cashierUnsubscribe) {
        cashierUnsubscribe();
        cashierUnsubscribe = null;
      }
      cashierNotifsUnsubs.forEach((u) => u && u());
      cashierNotifsUnsubs = [];
    };

    const hideAllModules = () => {
      clearTeacherSubscription();
      clearRegistrarSubscription();
      clearCashierSubscription();
      Object.values(modules).forEach((m) => hide(m));
    };

    // ==========================
    //  Teacher Dashboard (real-time from "classes")
    // ==========================
    const subscribeTeacherDashboard = (teacherUid) => {
      if (!db || !teacherUid) return;

      clearTeacherSubscription();

      const classesMap = new Map();
      const applyClasses = () => {
        const classes = Array.from(classesMap.values());
        let activeToday = 0;
        let pendingGradeSections = 0;
        let attendanceAlerts = 0;

        classes.forEach((cls) => {
          if (cls.isToday) activeToday++;
          if (cls.hasPendingGrades) pendingGradeSections++;
          if (typeof cls.attendanceAlerts === "number") {
            attendanceAlerts += cls.attendanceAlerts;
          }
        });
        const totalClasses = classes.length;
        // Fallbacks when flags aren?t set in data
        if (activeToday === 0 && totalClasses > 0) {
          activeToday = totalClasses;
        }
        if (pendingGradeSections === 0 && totalClasses > 0) {
          pendingGradeSections = classes.filter(
            (c) => c.hasPendingGrades || c.pendingLabel
          ).length;
        }

        const activeEl = byId("teacher-active-classes");
        const pendingEl = byId("teacher-pending-grades");
        const alertsEl = byId("teacher-attendance-alerts");
        if (activeEl) activeEl.textContent = String(activeToday);
        if (pendingEl) pendingEl.textContent = String(pendingGradeSections);
        if (alertsEl) alertsEl.textContent = String(attendanceAlerts);

        const tbody = byId("teacher-dashboard-class-list");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (classes.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML =
            '<td colspan="6" style="text-align:center; padding:0.8rem; font-size:0.8rem; color:var(--ssu-muted);">No classes assigned yet.</td>';
          tbody.appendChild(tr);
        } else {
          classes.forEach((cls) => {
            const tr = document.createElement("tr");
            tr.dataset.classId = cls.id;
            const pendingHtml = cls.pendingLabel
              ? `<span class="badge badge-pill-accent">${cls.pendingLabel}</span>`
              : "-";
            tr.innerHTML = `
            <td>${cls.section || ""}</td>
            <td>${cls.courseCode || ""}</td>
            <td>${cls.schedule || ""}</td>
            <td>${cls.room || ""}</td>
            <td>${pendingHtml}</td>
            <td>
              <div class="table-actions">
                <button class="btn btn-outline btn-sm" type="button" data-open="teacher-grades" data-class="${cls.id}">Encode</button>
                <button class="btn btn-ghost btn-sm" type="button" data-open="teacher-attendance" data-class="${cls.id}">Attendance</button>
              </div>
            </td>
          `;
            tbody.appendChild(tr);
          });

          // Re-bind quick open buttons inside table rows
          tbody.querySelectorAll("[data-open]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const target = btn.getAttribute("data-open");
              if (!target) return;
              const [moduleKey, panelKey] = target.split("-");
              const classId = btn.getAttribute("data-class");
              if (classId) selectTeacherClass(classId);
              const navBtn = findNavButton(moduleKey, panelKey);
              if (navBtn) navBtn.click();
            });
          });
        }

        teacherClasses = classes;
        renderTeacherClassTabs();
        if (!teacherCurrentClassId && classes.length > 0) {
          selectTeacherClass(classes[0].id);
        }
      };

      const handleSnapshot = (snapshot) => {
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          classesMap.set(docSnap.id, { id: docSnap.id, ...data });
        });
        applyClasses();
      };

      const qPrimary = query(
        collection(db, "classes"),
        where("teacherUid", "==", teacherUid)
      );
      const qSecondary = query(
        collection(db, "classes"),
        where("teacherId", "==", teacherUid)
      );

      teacherUnsubs.push(
        onSnapshot(qPrimary, handleSnapshot, (err) =>
          console.error("Teacher dashboard listener error (teacherUid):", err)
        )
      );
      teacherUnsubs.push(
        onSnapshot(qSecondary, handleSnapshot, (err) =>
          console.error("Teacher dashboard listener error (teacherId):", err)
        )
      );
    };

    // ==========================
    //  Receipt preview helper
    // ==========================
    const buildReceiptHtml = (pay) => {
      if (!pay) return "<div>No receipt data.</div>";
      const ts = pay.timestamp
        ? new Date(pay.timestamp).toLocaleString("en-PH")
        : pay.date || "?";
      return `
      <div style="margin-bottom:0.6rem;">
        <div style="font-weight:700; font-size:1rem;">SSU Official Receipt</div>
        <div style="color:var(--ssu-muted); font-size:0.82rem;">Window 1 - Main Campus</div>
      </div>
      <div><strong>Student:</strong> ${pay.studentName || ""} (${pay.studentId || ""})</div>
      <div><strong>Fee type:</strong> ${pay.feeType || ""}</div>
      <div><strong>Amount:</strong> ${formatPeso(pay.amount)}</div>
      <div><strong>Status:</strong> ${pay.status || "Paid"}</div>
      <div><strong>OR / Notes:</strong> ${pay.notes || "?"}</div>
      <div><strong>Date:</strong> ${ts}</div>
      <div style="margin-top:0.6rem;">
        <button type="button" class="btn btn-primary btn-sm" onclick="window.print()">Print</button>
      </div>
    `;
    };

    // ==========================
    //  Teacher helpers (classes, grades, attendance, announcements)
    // ==========================
    const renderTeacherClassTabs = () => {
      if (!teacherClassTabs) return;
      teacherClassTabs.innerHTML = "";
      if (teacherClasses.length === 0) {
        const span = document.createElement("span");
        span.classList.add("text-muted");
        span.style.padding = "0.2rem 0.6rem";
        span.textContent = "No classes yet";
        teacherClassTabs.appendChild(span);
        return;
      }
      teacherClasses.forEach((cls) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = cls.section || cls.courseCode || cls.id;
        btn.dataset.classId = cls.id;
        if (teacherCurrentClassId === cls.id) btn.classList.add("active");
        btn.addEventListener("click", () => selectTeacherClass(cls.id));
        teacherClassTabs.appendChild(btn);
      });
    };

    const renderTeacherClassTable = () => {
      if (!teacherClassTableBody) return;
      teacherClassTableBody.innerHTML = "";
      if (teacherStudents.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td colspan="5" style="padding:0.7rem; text-align:center; color:var(--ssu-muted); font-size:0.82rem;">No students found for this class.</td>';
        teacherClassTableBody.appendChild(tr);
        return;
      }
      teacherStudents.forEach((student) => {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.dataset.sid = student.id;
        if (teacherSelectedStudentId === student.id) tr.style.background = "#f9fafb";
        const studentKey = getStudentDocId(student) || student.id;
        const attendanceRecord = teacherAttendanceMap[studentKey] || {};
        const attendanceStatus = attendanceRecord.status
          ? attendanceRecord.status.charAt(0).toUpperCase() + attendanceRecord.status.slice(1)
          : "-";
        const attendanceLabel =
          attendanceStatus === "-"
            ? "-"
            : `${attendanceStatus}${attendanceRecord.date ? ` (${attendanceRecord.date})` : ""}`;
        tr.innerHTML = `
        <td>${student.studentId || student.id}</td>
        <td>${student.name || ""}</td>
        <td>${student.program || ""}</td>
        <td>${student.yearLevel || ""}</td>
        <td>${attendanceLabel}</td>
      `;
        tr.addEventListener("click", () => loadTeacherStudentPreview(student, tr));
        teacherClassTableBody.appendChild(tr);
      });
    };

    const renderTeacherGrades = () => {
      if (!teacherGradesTbody) return;
      teacherGradesTbody.innerHTML = "";
      if (teacherStudents.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td colspan="5" style="padding:0.7rem; text-align:center; color:var(--ssu-muted); font-size:0.82rem;">Select a class to load students.</td>';
        teacherGradesTbody.appendChild(tr);
        return;
      }
      teacherStudents.forEach((student) => {
        const docId = getStudentDocId(student) || student.id;
        const grade = teacherGradesMap[docId] || {};
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${student.studentId || student.id}</td>
        <td>${student.name || ""}</td>
        <td><input type="number" min="65" max="99" class="input" style="width: 80px;" data-grade-midterm data-student-id="${docId}" value="${grade.midterm ?? ""}"></td>
        <td><input type="number" min="65" max="99" class="input" style="width: 80px;" data-grade-final data-student-id="${docId}" value="${grade.final ?? ""}"></td>
        <td>
          <select class="input" style="width: 130px;" data-grade-remarks data-student-id="${docId}">
            <option value="" disabled ${grade.remarks ? "" : "selected"}>Select remarks</option>
            <option value="Passed" ${grade.remarks === "Passed" ? "selected" : ""}>Passed</option>
            <option value="Failed" ${grade.remarks === "Failed" ? "selected" : ""}>Failed</option>
          </select>
        </td>
        <td style="text-align:center;">
          <button type="button" class="btn btn-outline btn-sm" data-action="update-grade" data-student-id="${docId}">Update grade</button>
        </td>
      `;
        teacherGradesTbody.appendChild(tr);
        const updateBtn = tr.querySelector("[data-action='update-grade']");
        if (updateBtn) {
          updateBtn.addEventListener("click", () => {
            handleSaveGrades(false, docId);
          });
        }
      });
    };

    const buildFlaggedAttendance = () =>
      teacherStudents
        .map((student) => {
          const record = teacherAttendanceMap[student.id] || {};
          const statusRaw = (record.status || "present").toLowerCase();
          const docId = getStudentDocId(student);
          const check = docId ? teacherEnrollmentChecks.get(docId) : null;
          const isAtRisk = record.isAtRisk || student.isAtRisk || check?.isAtRisk;
          return { student, record, statusRaw, isAtRisk };
        })
        .filter(({ statusRaw, isAtRisk }) => isAtRisk || statusRaw !== "present");

    const updateAttendanceFlagMessage = (flaggedEntries) => {
      if (!teacherAttendanceAlert || !teacherAttendanceAlertText) return;
      if (teacherAttendanceAlert.classList.contains("alert-success")) return;
      if (flaggedEntries.length === 0) {
        teacherAttendanceAlert.classList.add("hidden");
        teacherAttendanceAlert.classList.remove("alert-error");
        teacherAttendanceAlertText.textContent = "";
        return;
      }
      teacherAttendanceAlert.classList.remove("hidden", "alert-success");
      teacherAttendanceAlert.classList.add("alert-error");
      const names = flaggedEntries
        .map(({ student }) => student.name || student.studentId || student.id || "Unknown")
        .join(", ");
      teacherAttendanceAlertText.textContent = `Flagged ${flaggedEntries.length} student${flaggedEntries.length > 1 ? "s" : ""}${
        names ? `: ${names}` : ""
      }.`;
    };

    const selectedAttendanceStudents = new Set();
    const clearAttendanceSelection = () => {
      selectedAttendanceStudents.clear();
      if (teacherAttendanceTbody) {
        teacherAttendanceTbody.querySelectorAll(".attendance-row-selected").forEach((row) => row.classList.remove("attendance-row-selected"));
      }
    };

    const toggleAttendanceSelection = (studentId, rowEl) => {
      if (!rowEl) return;
      if (selectedAttendanceStudents.has(studentId)) {
        selectedAttendanceStudents.delete(studentId);
        rowEl.classList.remove("attendance-row-selected");
      } else {
        selectedAttendanceStudents.add(studentId);
        rowEl.classList.add("attendance-row-selected");
      }
      showSelectionMessage();
    };

    const showSelectionMessage = () => {
      if (!teacherAttendanceAlert || !teacherAttendanceAlertText) return;
      if (selectedAttendanceStudents.size === 0) {
        const flagged = buildFlaggedAttendance();
        updateAttendanceFlagMessage(flagged);
        refreshAttendanceSummary();
        return;
      }
      const names = teacherStudents
        .filter((s) => selectedAttendanceStudents.has(s.id))
        .map((s) => s.name || s.studentId || s.id || "Unknown")
        .join(", ");
      teacherAttendanceAlert.classList.remove("hidden", "alert-success");
      teacherAttendanceAlert.classList.add("alert-error");
      teacherAttendanceAlertText.textContent = `Selected ${selectedAttendanceStudents.size} student${
        selectedAttendanceStudents.size > 1 ? "s" : ""
      } to flag: ${names}.`;
    };

    const markAttendanceAtRisk = async () => {
      if (!teacherCurrentClassId || selectedAttendanceStudents.size === 0 || !db) return;
      const names = [];
      const writes = [];
      selectedAttendanceStudents.forEach((studentId) => {
        const student = teacherStudents.find((s) => s.id === studentId);
        const docId = (student && (student.studentId || student.id)) || studentId;
        const name = student?.name || student?.studentId || student?.id || studentId;
        names.push(name);
        writes.push(
          setDoc(
            doc(db, "enrollmentChecks", docId),
            {
              isAtRisk: true,
              atRiskFlaggedBy: currentUser ? currentUser.uid : null,
              atRiskFlaggedAt: serverTimestamp(),
              status: "On hold",
            },
            { merge: true }
          )
        );
        writes.push(
          setDoc(
            doc(db, "students", docId),
            {
              isAtRisk: true,
              updatedAt: serverTimestamp(),
            },
            { merge: true }
          )
        );
        teacherEnrollmentChecks.set(docId, {
          ...(teacherEnrollmentChecks.get(docId) || {}),
          isAtRisk: true,
        });
      });

      try {
        await Promise.all(writes);
        clearAttendanceSelection();
        refreshAttendanceSummary();
        if (teacherAttendanceAlert && teacherAttendanceAlertText) {
          teacherAttendanceAlert.classList.remove("alert-error", "hidden");
          teacherAttendanceAlert.classList.add("alert-success");
          teacherAttendanceAlertText.textContent = `Flagged ${names.length} student${
            names.length > 1 ? "s" : ""
          } as at-risk. Registrar notified.`;
        }
        await sendNotification({
          toRole: "registrar",
          type: "attendance-flag",
          title: "Attendance flag",
          message: `Teacher flagged ${names.join(", ")} as at-risk.`,
        });
      } catch (err) {
        console.error("Error flagging students:", err);
        if (teacherAttendanceAlert && teacherAttendanceAlertText) {
          teacherAttendanceAlert.classList.remove("alert-success");
          teacherAttendanceAlert.classList.add("alert-error");
          teacherAttendanceAlertText.textContent = "Error flagging students. Please try again.";
        }
      }
    };

    const syncClassAttendanceAlerts = async (count) => {
      if (!db || !teacherCurrentClassId) return;
      if (
        teacherLastAttendanceAlertClassId === teacherCurrentClassId &&
        teacherLastAttendanceAlertCount === count
      ) {
        return;
      }
      teacherLastAttendanceAlertClassId = teacherCurrentClassId;
      teacherLastAttendanceAlertCount = count;
      try {
        await setDoc(
          doc(db, "classes", teacherCurrentClassId),
          {
            attendanceAlerts: count,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
      } catch (err) {
        console.error("Error syncing attendance alert count:", err);
      }
    };

    const refreshAttendanceSummary = () => {
      const alertsEl = byId("teacher-attendance-alerts");
      if (!alertsEl) return;
      const count = buildFlaggedAttendance().length;
      alertsEl.textContent = String(count);
      syncClassAttendanceAlerts(count);
    };

    const updateTeacherNoStudentsMessage = () => {
      if (!teacherNoStudentsMessage) return;
      if (teacherStudents.length === 0) {
        teacherNoStudentsMessage.classList.remove("hidden");
      } else {
        teacherNoStudentsMessage.classList.add("hidden");
      }
    };

    const refreshTeacherEnrollmentChecks = async () => {
      if (!db) return;
      updateTeacherNoStudentsMessage();
      const studentIds = teacherStudents.map(getStudentDocId).filter(Boolean);
      teacherEnrollmentChecks.clear();
      if (studentIds.length === 0) {
        refreshAttendanceSummary();
        const flagged = buildFlaggedAttendance();
        updateAttendanceFlagMessage(flagged);
        return;
      }
      try {
        const snaps = await Promise.all(
          studentIds.map((sid) => getDoc(doc(db, "enrollmentChecks", sid)))
        );
        snaps.forEach((snap) => {
          if (snap.exists()) {
            teacherEnrollmentChecks.set(snap.id, snap.data());
          }
        });
      } catch (err) {
        console.error("Error loading enrollment checks for attendance:", err);
      }
      refreshAttendanceSummary();
      const flagged = buildFlaggedAttendance();
      updateAttendanceFlagMessage(flagged);
    };

    const refreshTeacherData = () => {
      if (!currentUser) return;
      const classId = teacherCurrentClassId;
      subscribeTeacherDashboard(currentUser.uid);
      if (classId) {
        selectTeacherClass(classId);
      }
    };

    const renderTeacherAttendance = () => {
      if (!teacherAttendanceTbody) return;
      teacherAttendanceTbody.innerHTML = "";
      if (teacherStudents.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td colspan="4" style="padding:0.7rem; text-align:center; color:var(--ssu-muted); font-size:0.82rem;">Select a class to load students.</td>';
        teacherAttendanceTbody.appendChild(tr);
        return;
      }
      const today = new Date().toISOString().slice(0, 10);
      teacherStudents.forEach((student) => {
        const latest = teacherAttendanceMap[student.id] || {};
        const statusRaw = (latest.status || "present").toLowerCase();
        const remarks = latest.remarks || "";
        const date = latest.date || today;
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${student.name || ""}</td>
        <td>${date}</td>
        <td>
          <select class="attendance-select input" data-student-id="${student.id}">
            <option value="present" ${statusRaw === "present" ? "selected" : ""}>Present</option>
            <option value="late" ${statusRaw === "late" ? "selected" : ""}>Late</option>
            <option value="absent" ${statusRaw === "absent" ? "selected" : ""}>Absent</option>
          </select>
        </td>
        <td><input type="text" class="input" style="width: 140px;" placeholder="Optional" data-attendance-remarks data-student-id="${student.id}" value="${remarks}"></td>
      `;
        tr.addEventListener("click", (ev) => {
          if (
            ev.target &&
            ["SELECT", "INPUT", "OPTION"].includes(ev.target.tagName)
          ) {
            return;
          }
          toggleAttendanceSelection(student.id, tr);
        });
        teacherAttendanceTbody.appendChild(tr);
      });
      const flagged = buildFlaggedAttendance();
      updateAttendanceFlagMessage(flagged);
    };

    // Teacher student preview loader
    let teacherPreviewUnsubs = [];

    const clearTeacherPreviewSubscriptions = () => {
      teacherPreviewUnsubs.forEach((unsub) => unsub && unsub());
      teacherPreviewUnsubs = [];
    };

    const renderTeacherStudentPreview = (preview, student, stuData = {}, check = {}) => {
      if (!preview || !student) return;
      const sid = student.studentId || student.id;
      const status = stuData.status || check.status || "Unknown";
      const pay = stuData.paymentStatus || check.paymentStatus || "N/A";
      const grades = stuData.gradesStatus || check.gradesStatus || "N/A";
      const balance =
        typeof stuData.balance === "number" ? formatPeso(stuData.balance) : stuData.balance || "-";
      const classLabel = getClassLabel(student.classId) || getClassLabel(stuData.classId);
      const lines = [
        `<div><strong>${stuData.name || student.name || ""}</strong> (${sid})</div>`,
        `<div>${stuData.program || student.program || ""}${stuData.yearLevel || student.yearLevel ? ` - Year ${stuData.yearLevel || student.yearLevel}` : ""}</div>`,
        `<div>Status: ${status}</div>`,
        `<div>Payments: ${pay}${balance ? ` (${balance})` : ""}</div>`,
        `<div>Grades: ${grades}</div>`,
        classLabel ? `<div>Class: ${classLabel}</div>` : "",
      ].filter(Boolean);
      preview.innerHTML = lines.join("");
    };

    const loadTeacherStudentPreview = (student, rowEl) => {
      teacherSelectedStudentId = student.id;
      if (teacherClassTableBody) {
        teacherClassTableBody.querySelectorAll("tr").forEach((tr) => (tr.style.background = ""));
        if (rowEl) rowEl.style.background = "#f9fafb";
      }
      const preview = byId("teacher-student-preview");
      if (preview) {
        preview.textContent = "Loading student details...";
      }
      const sid = student.studentId || student.id;
      clearTeacherPreviewSubscriptions();
      if (!db || !sid) {
        if (preview) {
          preview.innerHTML = `<span style="color:var(--ssu-muted);">Select a student to see profile updates.</span>`;
        }
        return;
      }
      const studentRef = doc(db, "students", sid);
      const checkRef = doc(db, "enrollmentChecks", sid);
      let latestStudent = {};
      let latestCheck = {};
      const render = () => renderTeacherStudentPreview(preview, student, latestStudent, latestCheck);
      teacherPreviewUnsubs.push(
        onSnapshot(
          studentRef,
          (snap) => {
            latestStudent = snap.exists() ? snap.data() : {};
            render();
          },
          (err) => {
            console.error("Student preview listener error:", err);
            if (preview) {
              preview.innerHTML = `<span style="color:var(--ssu-danger);">Error updating preview.</span>`;
            }
          }
        )
      );
      teacherPreviewUnsubs.push(
        onSnapshot(
          checkRef,
          (snap) => {
            latestCheck = snap.exists() ? snap.data() : {};
            render();
          },
          (err) => {
            console.error("Enrollment check preview listener error:", err);
          }
        )
      );
    };

    const updateReportStudentOptions = () => {
      if (!teacherReportStudent) return;
      teacherReportStudent.innerHTML = '<option value="">Select student</option>';
      teacherStudents.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.studentId || s.id;
        opt.textContent = `${s.studentId || s.id} - ${s.name || ""}`;
        teacherReportStudent.appendChild(opt);
      });
      const flagged = buildFlaggedAttendance();
      updateAttendanceFlagMessage(flagged);
      refreshAttendanceSummary();
    };

    const selectTeacherClass = (classId) => {
      teacherEnrollmentChecks.clear();
      teacherLastAttendanceAlertCount = null;
      teacherLastAttendanceAlertClassId = null;
      teacherCurrentClassId = classId;
      if (teacherClassTabs) {
        teacherClassTabs.querySelectorAll("button").forEach((btn) => {
          const activeId = btn.textContent === classId ? classId : btn.dataset.classId;
          if (btn.dataset && btn.dataset.classId === classId) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
      }
      subscribeTeacherClassStudents(classId);
      subscribeTeacherClassGrades(classId);
      subscribeTeacherClassAttendance(classId);
      subscribeTeacherReportRequests(classId);
    };

    const subscribeTeacherClassStudents = (classId) => {
      if (!db || !classId) return;
      if (teacherStudentsUnsub) {
        teacherStudentsUnsub();
        teacherStudentsUnsub = null;
      }
      teacherStudentsFallbackUnsubs.forEach((u) => u && u());
      teacherStudentsFallbackUnsubs = [];

      const classMeta = teacherClasses.find((c) => c.id === classId) || {};
      const docsState = {
        primary: [],
        classId: [],
        section: [],
        clearedClass: [],
        clearedSection: [],
      };

      const teacherUid = currentUser ? currentUser.uid : "";

      const chooseAndRender = () => {
        const merged = new Map();
        [docsState.primary, docsState.classId, docsState.section, docsState.clearedClass, docsState.clearedSection].forEach(
          (arr) => {
            arr.forEach((s) => merged.set(s.id, s));
          }
        );
        teacherStudents = Array.from(merged.values());
        updateTeacherNoStudentsMessage();
        renderTeacherClassTable();
        renderTeacherGrades();
        renderTeacherAttendance();
        updateReportStudentOptions();
        refreshTeacherEnrollmentChecks();
      };

      // Primary: subcollection classes/{classId}/students
      teacherStudentsUnsub = onSnapshot(
        collection(db, "classes", classId, "students"),
        (snapshot) => {
          docsState.primary = snapshot.docs.map((docSnap) => ({
            id: docSnap.id,
            ...docSnap.data(),
          }));
          chooseAndRender();
        },
        (err) => console.error("Teacher students listener error:", err)
      );

      // Fallback 1: top-level students with classId field
      const qStudentsByClass = query(
        collection(db, "students"),
        where("classId", "==", classId),
        ...(teacherUid ? [where("teacherUid", "==", teacherUid)] : [])
      );
      teacherStudentsFallbackUnsubs.push(
        onSnapshot(
          qStudentsByClass,
          (snap) => {
            docsState.classId = snap.docs.map((docSnap) => ({
              id: docSnap.id,
              ...docSnap.data(),
            }));
            chooseAndRender();
          },
          (err) => console.error("Teacher students fallback listener error (classId):", err)
        )
      );

      // Fallback 1b: top-level students with classId + cleared payment
      const qStudentsByClassCleared = query(
        collection(db, "students"),
        where("classId", "==", classId),
        where("paymentStatus", "==", "Cleared"),
        ...(teacherUid ? [where("teacherUid", "==", teacherUid)] : [])
      );
      teacherStudentsFallbackUnsubs.push(
        onSnapshot(
          qStudentsByClassCleared,
          (snap) => {
            docsState.clearedClass = snap.docs.map((docSnap) => ({
              id: docSnap.id,
              ...docSnap.data(),
            }));
            chooseAndRender();
          },
          (err) => console.error("Teacher students fallback listener error (classId cleared):", err)
        )
      );

      // Fallback 2: match by section name if provided
      if (classMeta.section) {
        const qStudentsBySection = query(
          collection(db, "students"),
          where("section", "==", classMeta.section),
          ...(teacherUid ? [where("teacherUid", "==", teacherUid)] : [])
        );
        teacherStudentsFallbackUnsubs.push(
          onSnapshot(
            qStudentsBySection,
            (snap) => {
              docsState.section = snap.docs.map((docSnap) => ({
                id: docSnap.id,
                ...docSnap.data(),
              }));
              chooseAndRender();
            },
            (err) => console.error("Teacher students fallback listener error (section):", err)
          )
        );

        const qStudentsBySectionCleared = query(
          collection(db, "students"),
          where("section", "==", classMeta.section),
          where("paymentStatus", "==", "Cleared"),
          ...(teacherUid ? [where("teacherUid", "==", teacherUid)] : [])
        );
        teacherStudentsFallbackUnsubs.push(
          onSnapshot(
            qStudentsBySectionCleared,
            (snap) => {
              docsState.clearedSection = snap.docs.map((docSnap) => ({
                id: docSnap.id,
                ...docSnap.data(),
              }));
              chooseAndRender();
            },
            (err) => console.error("Teacher students fallback listener error (section cleared):", err)
          )
        );
      }
    };

    const subscribeTeacherClassGrades = (classId) => {
      if (!db || !classId) return;
      if (teacherGradesUnsub) {
        teacherGradesUnsub();
        teacherGradesUnsub = null;
      }
      teacherGradesUnsub = onSnapshot(
        collection(db, "classes", classId, "grades"),
        (snapshot) => {
          teacherGradesMap = {};
          snapshot.forEach((docSnap) => {
            teacherGradesMap[docSnap.id] = docSnap.data();
          });
          renderTeacherGrades();
        },
        (err) => console.error("Teacher grades listener error:", err)
      );
    };

    const subscribeTeacherClassAttendance = (classId) => {
      if (!db || !classId) return;
      if (teacherAttendanceUnsub) {
        teacherAttendanceUnsub();
        teacherAttendanceUnsub = null;
      }
      const qAtt = query(
        collection(db, "classes", classId, "attendance"),
        orderBy("date", "desc"),
        limit(200)
      );
      teacherAttendanceUnsub = onSnapshot(
        qAtt,
        (snapshot) => {
          teacherAttendanceMap = {};
          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            if (data.studentId) teacherAttendanceMap[data.studentId] = data;
          });
          renderTeacherAttendance();
        },
        (err) => console.error("Teacher attendance listener error:", err)
      );
    };

    const handleSaveGrades = async (submit, targetStudentId = null) => {
      if (!teacherCurrentClassId || teacherStudents.length === 0) return;
      if (teacherGradeAlert) {
        teacherGradeAlert.classList.add("hidden");
      }
      try {
        const gradeWrites = [];
        const checkWrites = [];
        teacherStudents.forEach((student) => {
          const studentDocId = getStudentDocId(student) || student.id;
          if (!studentDocId) return;
          if (targetStudentId && targetStudentId !== studentDocId) return;
          const mid = document.querySelector(`input[data-grade-midterm][data-student-id='${studentDocId}']`);
          const fin = document.querySelector(`input[data-grade-final][data-student-id='${studentDocId}']`);
          const rem = document.querySelector(`[data-grade-remarks][data-student-id='${studentDocId}']`);
          const midVal = mid && mid.value ? Number(mid.value) : null;
          const finVal = fin && fin.value ? Number(fin.value) : null;
          const remarks = rem ? rem.value.trim() : "";
          const gradeComplete = Number.isFinite(midVal) && Number.isFinite(finVal);

          gradeWrites.push(
            setDoc(
              doc(db, "classes", teacherCurrentClassId, "grades", studentDocId),
              {
                studentId: student.studentId || student.id,
                studentName: student.name || "",
                midterm: midVal,
                final: finVal,
                remarks,
                submitted: submit,
                teacherUid: currentUser ? currentUser.uid : null,
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            )
          );

          // Keep registrar in sync for this student
          checkWrites.push(
            setDoc(
              doc(db, "enrollmentChecks", student.studentId || student.id),
              {
                studentId: student.studentId || student.id,
                studentName: student.name || "",
                hasCompleteGrades: gradeComplete,
                gradesStatus: gradeComplete ? "Complete" : "In progress",
                status: gradeComplete ? "Ready" : "Pending",
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            )
          );

          // Reflect grade status on student record so registrar list shows it
          checkWrites.push(
            setDoc(
              doc(db, "students", student.studentId || student.id),
              {
                gradesStatus: gradeComplete ? "Complete" : "Pending",
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            )
          );
        });
        await Promise.all([...gradeWrites, ...checkWrites]);
        if (submit) {
          await sendNotification({
            toRole: "registrar",
            type: "grades",
            title: "Grades submitted",
            message: `Grades submitted for ${getClassLabel(teacherCurrentClassId) || "this class"} by the teacher.`,
          });

        }
        if (teacherGradeAlert && teacherGradeAlertText) {
          teacherGradeAlert.classList.remove("alert-error", "hidden");
          teacherGradeAlert.classList.add("alert-success");
          teacherGradeAlertText.textContent = submit
            ? "Grades submitted to Registrar."
            : "Draft saved.";
        }
      } catch (err) {
        console.error(err);
        if (teacherGradeAlert && teacherGradeAlertText) {
          teacherGradeAlert.classList.remove("alert-success", "hidden");
          teacherGradeAlert.classList.add("alert-error");
          teacherGradeAlertText.textContent = "Error saving grades. Please retry.";
        }
      }
    };

    const handleSaveAttendance = async () => {
      if (!teacherCurrentClassId || teacherStudents.length === 0) return;
      if (teacherAttendanceAlert) {
        teacherAttendanceAlert.classList.add("hidden");
      }
      try {
        const today = new Date().toISOString().slice(0, 10);
        const writes = [];
        teacherStudents.forEach((student) => {
          const statusSel = document.querySelector(
            `.attendance-select[data-student-id='${student.id}']`
          );
          const remarksInput = document.querySelector(
            `input[data-attendance-remarks][data-student-id='${student.id}']`
          );
          const status = statusSel ? statusSel.value : "present";
          const remarks = remarksInput ? remarksInput.value.trim() : "";
          writes.push(
            addDoc(collection(db, "classes", teacherCurrentClassId, "attendance"), {
              studentId: student.studentId || student.id,
              studentName: student.name || "",
              status,
              remarks,
              date: today,
              teacherUid: currentUser ? currentUser.uid : null,
              timestamp: serverTimestamp(),
            })
          );
        });
        await Promise.all(writes);
        if (teacherAttendanceAlert && teacherAttendanceAlertText) {
          teacherAttendanceAlert.classList.remove("alert-error", "hidden");
          teacherAttendanceAlert.classList.add("alert-success");
          teacherAttendanceAlertText.textContent = "Attendance saved.";
        }
      } catch (err) {
        console.error(err);
        if (teacherAttendanceAlert && teacherAttendanceAlertText) {
          teacherAttendanceAlert.classList.remove("alert-success", "hidden");
          teacherAttendanceAlert.classList.add("alert-error");
          teacherAttendanceAlertText.textContent = "Error saving attendance. Please retry.";
        }
      }
    };

    const subscribeTeacherArtifacts = () => {
      if (!db) return;
      if (teacherArtifactsUnsub) {
        teacherArtifactsUnsub();
        teacherArtifactsUnsub = null;
      }
      const qArtifacts = query(collection(db, "artifacts"), orderBy("createdAt", "desc"), limit(20));
      teacherArtifactsUnsub = onSnapshot(
        qArtifacts,
        (snapshot) => {
          const announcements = [];
          const deadlines = [];
          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            if (data.type === "announcement") announcements.push(data);
            if (data.type === "deadline") deadlines.push(data);
          });

          if (teacherAnnouncementList) {
            teacherAnnouncementList.innerHTML = "";
            announcements.forEach((a) => {
              const li = document.createElement("li");
              li.innerHTML = `<strong>${a.from || ""}</strong> ${a.subject || ""}`;
              teacherAnnouncementList.appendChild(li);
            });
          }

          if (teacherAnnouncementsTable) {
            teacherAnnouncementsTable.innerHTML = "";
            announcements.forEach((a) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
              <td>${a.from || ""}</td>
              <td>${a.module || ""}</td>
              <td>${a.subject || ""}</td>
              <td>${a.date || ""}</td>
            `;
              teacherAnnouncementsTable.appendChild(tr);
            });
          }

          if (teacherDeadlineList) {
            teacherDeadlineList.innerHTML = "";
            deadlines.forEach((d) => {
              const li = document.createElement("li");
              li.classList.add("deadline-item");
              li.innerHTML = `
              <div>
                <div><strong>${d.title || ""}</strong> ? ${d.scope || ""}</div>
                <div class="text-muted">${d.details || ""}</div>
              </div>
              <span class="badge badge-pill-accent">${d.dueLabel || ""}</span>
            `;
              teacherDeadlineList.appendChild(li);
            });
          }
        },
        (err) => console.error("Teacher artifacts listener error:", err)
      );
    };

    const subscribeTeacherReportRequests = (classId) => {
      if (!db || !currentUser) return;
      if (teacherReportUnsub) {
        teacherReportUnsub();
        teacherReportUnsub = null;
      }
      const qReq = classId
        ? query(
          collection(db, "reportCardRequests"),
          where("teacherUid", "==", currentUser.uid),
          where("classId", "==", classId)
        )
        : query(
          collection(db, "reportCardRequests"),
          where("teacherUid", "==", currentUser.uid)
        );
      teacherReportUnsub = onSnapshot(
        qReq,
        (snap) => {
          if (!teacherReportList) return;
          teacherReportList.innerHTML = "";
          if (snap.empty) {
            teacherReportList.innerHTML =
              '<li style="color:var(--ssu-muted); font-size:0.82rem;">No requests yet.</li>';
            return;
          }
          const items = snap.docs
            .map((d) => ({ id: d.id, ...d.data() }))
            .sort((a, b) => {
              const ta = a.updatedAt?.toMillis?.() || 0;
              const tb = b.updatedAt?.toMillis?.() || 0;
              return tb - ta;
            })
            .slice(0, 10);
          items.forEach((req) => {
            const li = document.createElement("li");
            const name = req.studentName || req.studentId || "";
            const status = req.status || "Pending";
            const detailParts = [status];
            if (req.reason) detailParts.push(req.reason);
            const details = detailParts.join(" - ");
            li.innerHTML = `<strong>${name}</strong><div class="text-muted">${details}</div>`;
            teacherReportList.appendChild(li);
          });
        },
        (err) => console.error("Teacher report requests listener error:", err)
      );
    };

   
    const loadProfile = async (role) => {
      if (!currentUser) return;
      try {
        const snap = await getDoc(doc(db, "users", currentUser.uid));
        if (!snap.exists()) return;
        const data = snap.data();
        if (role === "teacher") {
          if (teacherProfileName) teacherProfileName.value = data.name || "";
          if (teacherProfileId) teacherProfileId.value = data.idOrEmail || "";
          if (teacherProfileAuth) teacherProfileAuth.value = data.authEmail || "";
        } else if (role === "registrar") {
          if (registrarProfileName) registrarProfileName.value = data.name || "";
          if (registrarProfileId) registrarProfileId.value = data.idOrEmail || "";
          if (registrarProfileAuth) registrarProfileAuth.value = data.authEmail || "";
        }
      } catch (err) {
        console.error("Error loading profile:", err);
      }
    };

    const saveProfile = async (role) => {
      if (!currentUser) return;
      const isTeacher = role === "teacher";
      const name = (isTeacher ? teacherProfileName?.value : registrarProfileName?.value) || "";
      const idOrEmail = (isTeacher ? teacherProfileId?.value : registrarProfileId?.value) || "";
      const alertEl = isTeacher ? teacherProfileAlert : registrarProfileAlert;
      const alertText = isTeacher ? teacherProfileAlertText : registrarProfileAlertText;
      try {
        await setDoc(
          doc(db, "users", currentUser.uid),
          {
            name,
            idOrEmail,
            updatedAt: new Date().toISOString(),
          },
          { merge: true }
        );
        if (alertEl && alertText) {
          alertEl.classList.remove("alert-error", "hidden");
          alertEl.classList.add("alert-success");
          alertText.textContent = "Profile updated.";
        }
      } catch (err) {
        console.error("Error saving profile:", err);
        if (alertEl && alertText) {
          alertEl.classList.remove("alert-success", "hidden");
          alertEl.classList.add("alert-error");
          alertText.textContent = "Error saving profile.";
        }
      }
    };

    // Teacher actions
    if (btnSaveGrades) {
      btnSaveGrades.addEventListener("click", () => handleSaveGrades(false));
    }
    if (btnSubmitGrades) {
      btnSubmitGrades.addEventListener("click", () => handleSaveGrades(true));
    }
    if (btnSaveAttendance) {
      btnSaveAttendance.addEventListener("click", () => handleSaveAttendance());
    }
    if (btnFlagAttendance) {
      btnFlagAttendance.addEventListener("click", () => {
        if (selectedAttendanceStudents.size > 0) {
          markAttendanceAtRisk();
          return;
        }
        const flagged = buildFlaggedAttendance();
        updateAttendanceFlagMessage(flagged);
        if (flagged.length === 0 && teacherAttendanceAlert && teacherAttendanceAlertText) {
          teacherAttendanceAlertText.textContent = "All students are currently marked present.";
        }
      });
    }
    if (teacherRefreshButton) {
      teacherRefreshButton.addEventListener("click", refreshTeacherData);
    }
    if (teacherReportForm) {
      teacherReportForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (teacherReportAlert) teacherReportAlert.classList.add("hidden");
        const sid = teacherReportStudent?.value || "";
        const reason = teacherReportReason?.value.trim() || "";
        const student = teacherStudents.find((s) => (s.studentId || s.id) === sid);
        if (!sid || !student || !teacherCurrentClassId || !currentUser) {
          if (teacherReportAlert && teacherReportAlertText) {
            teacherReportAlert.classList.remove("alert-success", "hidden");
            teacherReportAlert.classList.add("alert-error");
            teacherReportAlertText.textContent = "Select a student first.";
          }
          return;
        }
        try {
          const docRef = await addDoc(collection(db, "reportCardRequests"), {
            studentId: student.studentId || student.id,
            studentName: student.name || "",
            classId: teacherCurrentClassId,
            teacherUid: currentUser.uid,
            teacherName:
              (typeof teacherProfileName !== "undefined" && teacherProfileName?.value) ||
              currentUser.displayName ||
              "",
            reason,
            status: "Pending",
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          });
          await sendNotification({
            toRole: "registrar",
            type: "report-card",
            title: "Report card request",
            message: `${student.name || sid} requested by teacher.`,
            requestId: docRef.id,
            studentId: student.studentId || student.id,
            classId: teacherCurrentClassId,
          });
          if (teacherReportAlert && teacherReportAlertText) {
            teacherReportAlert.classList.remove("alert-error", "hidden");
            teacherReportAlert.classList.add("alert-success");
            teacherReportAlertText.textContent = "Request submitted.";
          }
          if (teacherReportReason) teacherReportReason.value = "";
        } catch (err) {
          console.error("Error submitting report card request:", err);
          if (teacherReportAlert && teacherReportAlertText) {
            teacherReportAlert.classList.remove("alert-success", "hidden");
            teacherReportAlert.classList.add("alert-error");
            teacherReportAlertText.textContent = "Error submitting request.";
          }
        }
      });
    }
    if (teacherProfileForm) {
      teacherProfileForm.addEventListener("submit", (e) => {
        e.preventDefault();
        saveProfile("teacher");
      });
    }
    if (registrarProfileForm) {
      registrarProfileForm.addEventListener("submit", (e) => {
        e.preventDefault();
        saveProfile("registrar");
      });
    }

    const triggerRegistrarQuickAction = (panel) => {
      const navBtn = findNavButton("registrar", panel);
      if (navBtn) navBtn.click();
    };
    if (btnOpenStudentRecords) {
      btnOpenStudentRecords.addEventListener("click", () => triggerRegistrarQuickAction("students"));
    }
    if (btnOpenApprovals) {
      btnOpenApprovals.addEventListener("click", () => triggerRegistrarQuickAction("approvals"));
    }
    if (btnOpenDocuments) {
      btnOpenDocuments.addEventListener("click", () => triggerRegistrarQuickAction("documents"));
    }

    // ==========================
    //  Registrar Dashboard (real-time from "enrollmentChecks")
    // ==========================
    const subscribeRegistrarDashboard = () => {
      if (!db) return;

      clearRegistrarSubscription();

      const colRef = collection(db, "enrollmentChecks");

      registrarUnsubscribe = onSnapshot(
        colRef,
        (snapshot) => {
          let completeGrades = 0;
          let clearedPayments = 0;
          let pendingEnrollments = 0;
          const pendingRows = [];

          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            if (data.hasCompleteGrades) completeGrades++;
            if (data.hasClearedPayments) clearedPayments++;
            if (data.isPending) {
              pendingEnrollments++;
              pendingRows.push({ id: docSnap.id, ...data });
            }
          });

          const cgEl = byId("reg-complete-grades");
          const cpEl = byId("reg-cleared-payments");
          const peEl = byId("reg-pending-enrollment");
          if (cgEl) cgEl.textContent = String(completeGrades);
          if (cpEl) cpEl.textContent = String(clearedPayments);
          if (peEl) peEl.textContent = String(pendingEnrollments);

          const tbody = byId("reg-pending-checks-tbody");
          if (!tbody) return;
          tbody.innerHTML = "";

          if (pendingRows.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML =
              '<td colspan="5" style="padding:0.7rem; text-align:center; font-size:0.8rem; color:var(--ssu-muted);">No pending enrollment checks.</td>';
            tbody.appendChild(tr);
            return;
          }

          pendingRows.forEach((row) => {
            const tr = document.createElement("tr");
            const gradeClass =
              row.gradesStatus === "Complete"
                ? "badge-pill-success"
                : "badge-pill-accent";
            const paymentClass =
              row.paymentStatus === "Cleared"
                ? "badge-pill-success"
                : "badge-pill-accent";
            const statusClass =
              row.status === "On hold"
                ? "badge-pill-danger"
                : row.status === "Ready"
                  ? "badge-pill-success"
                  : "badge-pill-accent";

            tr.innerHTML = `
            <td>${row.studentName || ""}</td>
            <td>${row.programYear || ""}</td>
            <td><span class="badge ${gradeClass}">${row.gradesStatus || ""}</span></td>
            <td><span class="badge ${paymentClass}">${row.paymentStatus || ""}</span></td>
            <td><span class="badge ${statusClass}">${row.status || ""}</span></td>
          `;
            tbody.appendChild(tr);
          });
        },
        (err) => console.error("Registrar dashboard listener error:", err)
      );
    };

    const renderRegistrarStudents = () => {
      if (!registrarStudentsBody) return;
      const programFilter = registrarProgramSelect?.value || "all";
      const yearFilter = registrarYearSelect?.value || "all";
      const term = (registrarStudentSearch?.value || "").toLowerCase();

      registrarStudentsBody.innerHTML = "";
      const filtered = registrarStudentsCache.filter((stu) => {
        const matchesProgram = programFilter === "all" || (stu.program || "").toLowerCase() === programFilter.toLowerCase();
        const matchesYear = yearFilter === "all" || String(stu.yearLevel || "") === String(yearFilter);
        const matchesTerm =
          !term ||
          (stu.name || "").toLowerCase().includes(term) ||
          (stu.studentId || stu.id || "").toLowerCase().includes(term);
        return matchesProgram && matchesYear && matchesTerm;
      });

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td colspan="6" style="padding:0.7rem; text-align:center; color:var(--ssu-muted); font-size:0.82rem;">No students match the filters.</td>';
        registrarStudentsBody.appendChild(tr);
        return;
      }

      filtered.forEach((stu) => {
        const tr = document.createElement("tr");
        tr.addEventListener("click", async (evt) => {
          // Ignore clicks on action buttons
          if (evt.target && evt.target.closest("[data-action='delete-student']")) return;
          if (registrarStudentProfile) {
            registrarStudentProfile.innerHTML = `
            <div><strong>${stu.name || ""}</strong> (${stu.studentId || stu.id})</div>
            <div>${stu.program || ""} ? Year ${stu.yearLevel || ""}</div>
            <div>Status: ${stu.status || "Unknown"}</div>
            <div>Payments: ${stu.paymentStatus || "N/A"}</div>
            <div>Grades: ${stu.gradesStatus || "N/A"}</div>
            <div>Loading grade details...</div>
          `;
          }
          if (registrarStatusActions) {
            registrarStatusActions.classList.remove("hidden");
            registrarStatusActions.dataset.studentId = stu.id;
          }

          // Fetch detailed grades from class/grades doc if classId exists
          if (stu.classId) {
            try {
              const gradeDoc = await getDoc(doc(db, "classes", stu.classId, "grades", stu.id));
              if (gradeDoc.exists()) {
                const g = gradeDoc.data();
                const mid = g.midterm ?? "-";
                const fin = g.final ?? "-";
                const rem = g.remarks || "-";
                const gradeComplete = Number.isFinite(Number(mid)) && Number.isFinite(Number(fin));
                const gradeStatusText = gradeComplete ? "Complete" : "Pending";
                if (registrarStudentProfile) {
                  registrarStudentProfile.innerHTML = `
                  <div><strong>${stu.name || ""}</strong> (${stu.studentId || stu.id})</div>
                  <div>${stu.program || ""} - Year ${stu.yearLevel || ""}</div>
                  <div>Status: ${stu.status || "Unknown"}</div>
                  <div>Payments: ${stu.paymentStatus || "N/A"}</div>
                  <div>Grades: ${gradeStatusText}</div>
                  <div><strong>Grade details</strong></div>
                  <div>Midterm: ${mid}</div>
                  <div>Final: ${fin}</div>
                  <div>Remarks: ${rem}</div>
                `;
                }

                // Auto-sync grade status to students + enrollmentChecks
                const studentDocId = stu.studentId || stu.id;
                const updates = [
                  setDoc(
                    doc(db, "students", studentDocId),
                    { gradesStatus: gradeStatusText, updatedAt: serverTimestamp() },
                    { merge: true }
                  ),
                  setDoc(
                    doc(db, "enrollmentChecks", studentDocId),
                    {
                      gradesStatus: gradeStatusText,
                      hasCompleteGrades: gradeComplete,
                      status: gradeComplete ? "Ready" : (stu.status || "Pending"),
                      updatedAt: serverTimestamp(),
                    },
                    { merge: true }
                  ),
                ];
                Promise.all(updates).catch((err) =>
                  console.error("Error syncing grade status to registrar docs:", err)
                );
              } else if (registrarStudentProfile) {
                registrarStudentProfile.innerHTML = `
                <div><strong>${stu.name || ""}</strong> (${stu.studentId || stu.id})</div>
                <div>${stu.program || ""} ? Year ${stu.yearLevel || ""}</div>
                <div>Status: ${stu.status || "Unknown"}</div>
                <div>Payments: ${stu.paymentStatus || "N/A"}</div>
                <div>Grades: ${stu.gradesStatus || "N/A"}</div>
                <div>No grade record found for this class.</div>
              `;
              }
            } catch (err) {
              console.error("Error fetching grade doc for registrar view:", err);
              if (registrarStudentProfile) {
                registrarStudentProfile.innerHTML = `
                <div><strong>${stu.name || ""}</strong> (${stu.studentId || stu.id})</div>
                <div>${stu.program || ""} ? Year ${stu.yearLevel || ""}</div>
                <div>Status: ${stu.status || "Unknown"}</div>
                <div>Payments: ${stu.paymentStatus || "N/A"}</div>
                <div>Grades: ${stu.gradesStatus || "N/A"}</div>
                <div style="color: var(--ssu-danger);">Error loading grade details.</div>
              `;
              }
            }
          }

          loadStudentTimeline(stu.studentId || stu.id, stu.name || "");
        });
        tr.innerHTML = `
        <td>${stu.studentId || stu.id}</td>
        <td>${stu.name || ""}</td>
        <td>${stu.program || ""}</td>
        <td>${stu.yearLevel || ""}</td>
        <td>${stu.gradesStatus || "N/A"}</td>
        <td>${stu.status || ""}</td>
        <td><button class="btn btn-outline btn-sm" data-action="delete-student" data-sid="${stu.studentId || stu.id}" data-class="${stu.classId || ""}">Delete</button></td>
      `;
        registrarStudentsBody.appendChild(tr);

        const delBtn = tr.querySelector("[data-action='delete-student']");
        if (delBtn) {
          delBtn.addEventListener("click", async (ev) => {
            ev.stopPropagation();
            const sid = delBtn.getAttribute("data-sid");
            const classId = delBtn.getAttribute("data-class");
            if (!sid) return;
            const ok = confirm(`Delete student ${sid}? This will remove their record and enrollment checks.`);
            if (!ok) return;
            try {
              await deleteDoc(doc(db, "students", sid));
              await deleteDoc(doc(db, "enrollmentChecks", sid));
              if (classId) {
                await deleteDoc(doc(db, "classes", classId, "students", sid));
                // Clean up grades and attendance for that class
                await deleteDoc(doc(db, "classes", classId, "grades", sid));
                try {
                  const attSnap = await getDocs(
                    query(
                      collection(db, "classes", classId, "attendance"),
                      where("studentId", "==", sid)
                    )
                  );
                  const deletes = attSnap.docs.map((a) => deleteDoc(a.ref));
                  await Promise.all(deletes);
                } catch (err) {
                  console.error("Error removing attendance for deleted student:", err);
                }
                try {
                  const paymentSnap = await getDocs(
                    query(
                      collection(db, "payments"),
                      where("studentId", "==", sid)
                    )
                  );
                  const paymentDeletes = paymentSnap.docs.map((p) => deleteDoc(p.ref));
                  await Promise.all(paymentDeletes);
                } catch (err) {
                  console.error("Error removing payments for deleted student:", err);
                }
              }
            } catch (err) {
              console.error("Error deleting student:", err);
              alert("Error deleting student. Check console for details.");
            }
          });
        }
      });
    };

    const subscribeRegistrarStudents = () => {
      if (!db) return;
      if (registrarStudentsUnsub) {
        registrarStudentsUnsub();
        registrarStudentsUnsub = null;
      }
      registrarStudentsUnsub = onSnapshot(
        collection(db, "students"),
        (snapshot) => {
          registrarStudentsCache = snapshot.docs.map((docSnap) => ({
            id: docSnap.id,
            ...docSnap.data(),
          }));
          renderRegistrarStudents();
        },
        (err) => console.error("Registrar students listener error:", err)
      );
    };

    // ==========================
    //  Notifications (shared)
    // ==========================
    const sendNotification = async ({
      toRole = null,
      toUid = null,
      type = "info",
      title = "",
      message = "",
      requestId = null,
      studentId = null,
      classId = null,
    }) => {
      try {
        await addDoc(collection(db, "notifications"), {
          toRole,
          toUid,
          type,
          title,
          message,
          requestId,
          studentId,
          classId,
          createdAt: serverTimestamp(),
        });
      } catch (err) {
        console.error("Error sending notification:", err);
      }
    };

    const NOTIF_RETENTION_MS = 7 * 24 * 60 * 60 * 1000;

    const tsToMillis = (val) => {
      if (!val) return null;
      if (typeof val === "number") return val;
      if (val.toMillis) return val.toMillis();
      if (val.seconds) return val.seconds * 1000;
      return null;
    };

    const loadStudentTimeline = async (sid, name) => {
      if (!registrarStudentTimeline) return;
      registrarStudentTimeline.innerHTML =
        '<li style="color:var(--ssu-muted); font-size:0.82rem;">Loading timeline...</li>';
      try {
        const [paySnap, reportSnap, reqSnap, checkSnap] = await Promise.all([
          getDocs(query(collection(db, "payments"), where("studentId", "==", sid), orderBy("timestamp", "desc"), limit(10))),
          getDocs(query(collection(db, "reportCardRequests"), where("studentId", "==", sid), orderBy("updatedAt", "desc"), limit(10))),
          getDocs(query(collection(db, "enrollmentRequests"), where("studentId", "==", sid), orderBy("createdAt", "desc"), limit(5))),
          getDoc(doc(db, "enrollmentChecks", sid)),
        ]);

        const events = [];
        paySnap.forEach((d) => {
          const data = d.data();
        events.push({
          ts: tsToMillis(data.timestamp) || Date.now(),
          text: `Payment: ${formatPeso(data.amount)} (${data.feeType || ""}) – ${data.status || "Paid"}`,
        });
        });
        reportSnap.forEach((d) => {
          const data = d.data();
          events.push({
            ts: tsToMillis(data.updatedAt) || Date.now(),
            text: `Report card: ${data.status || "Pending"}${data.reason ? " - " + data.reason : ""}`,
          });
        });
        reqSnap.forEach((d) => {
          const data = d.data();
          events.push({
            ts: tsToMillis(data.createdAt) || Date.now(),
            text: `Enrollment request: ${data.status || "Pending"}`,
          });
        });
        if (checkSnap.exists()) {
          const c = checkSnap.data();
          events.push({
            ts: tsToMillis(c.updatedAt) || Date.now(),
            text: `Enrollment status: ${c.status || "Pending"} - Grades ${c.gradesStatus || "Pending"} - Payment ${c.paymentStatus || "Pending"}`,
          });
        }
        events.sort((a, b) => (b.ts || 0) - (a.ts || 0));
        registrarStudentTimeline.innerHTML = "";
        if (events.length === 0) {
          registrarStudentTimeline.innerHTML =
            '<li style="color:var(--ssu-muted); font-size:0.82rem;">No recent activity for this student.</li>';
          return;
        }
        events.slice(0, 12).forEach((e) => {
          const li = document.createElement("li");
          const when = e.ts ? new Date(e.ts).toLocaleString("en-PH") : "";
          li.innerHTML = `<strong>${when}</strong> – ${e.text}`;
          registrarStudentTimeline.appendChild(li);
        });
      } catch (err) {
        console.error("Error loading student timeline:", err);
        registrarStudentTimeline.innerHTML =
          '<li style="color:var(--ssu-danger); font-size:0.82rem;">Error loading timeline.</li>';
      }
    };

    const subscribeNotifications = (role, uid, listEl, storeArray) => {
      if (!db || !role) return;
      const listeners = [];
      const markNotificationRead = async (id) => {
        try {
          await deleteDoc(doc(db, "notifications", id));
        } catch (err) {
          console.error("Error clearing notification:", err);
        }
      };
      const render = (docs) => {
        if (!listEl) return;
        listEl.innerHTML = "";
        if (docs.length === 0) {
          listEl.innerHTML =
            '<li style="color:var(--ssu-muted); font-size:0.82rem;">No notifications yet.</li>';
          return;
        }
        docs
          .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
          .slice(0, 10)
          .forEach((n) => {
            const li = document.createElement("li");
            li.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between; gap:0.5rem;"><span><strong>${n.title || n.type || "Notice"}:</strong> ${n.message || ""}</span><button class="btn-ghost btn-sm" data-notif-id="${n.id}">Mark Read</button></div>`;
            listEl.appendChild(li);
          });

        listEl.querySelectorAll("button[data-notif-id]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-notif-id");
            if (id) markNotificationRead(id);
          });
        });
      };

      const mergeAndRender = () => {
        const merged = new Map();
        storeArray.forEach((arr) => {
          arr.forEach((n) => merged.set(n.id, n));
        });
        render(Array.from(merged.values()));
      };

      const handleSnap = (idx) => (snap) => {
        const cutoff = Date.now() - NOTIF_RETENTION_MS;
        storeArray[idx] = snap.docs
          .map((d) => {
            const data = d.data();
            const createdMs = data.createdAt && data.createdAt.toMillis ? data.createdAt.toMillis() : Date.now();
            return {
              id: d.id,
              ...data,
              createdAt: createdMs,
            };
          })
          .filter((n) => {
            // purge old notifications
            if (n.createdAt < cutoff) {
              deleteDoc(doc(db, "notifications", n.id)).catch((err) =>
                console.error("Error auto-removing old notification:", err)
              );
              return false;
            }
            return true;
          });
        mergeAndRender();
      };

      listeners.push(
        onSnapshot(
          query(collection(db, "notifications"), where("toRole", "==", role)),
          handleSnap(0),
          (err) => console.error("Notifications listener error (role):", err)
        )
      );
      if (uid) {
        listeners.push(
          onSnapshot(
            query(collection(db, "notifications"), where("toUid", "==", uid)),
            handleSnap(1),
            (err) => console.error("Notifications listener error (uid):", err)
          )
        );
      }
      return listeners;
    };

    const subscribeRegistrarRequests = () => {
      if (!db) return;
      if (registrarRequestsUnsub) {
        registrarRequestsUnsub();
        registrarRequestsUnsub = null;
      }
      if (registrarRequestsBody) {
        registrarRequestsBody.innerHTML =
          '<tr><td colspan="5" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">Loading requests...</td></tr>';
      }
      registrarRequestsUnsub = onSnapshot(
        collection(db, "enrollmentRequests"),
        (snapshot) => {
          if (!registrarRequestsBody) return;
          registrarRequestsBody.innerHTML = "";
          if (snapshot.empty) {
            registrarRequestsBody.innerHTML =
              '<tr><td colspan="5" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">No pending requests.</td></tr>';
            return;
          }
          snapshot.forEach((docSnap) => {
            const req = { id: docSnap.id, ...docSnap.data() };
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${req.studentId || ""}</td>
            <td>${req.name || ""}</td>
            <td>${req.program || ""} ${req.yearLevel ? " / " + req.yearLevel : ""}</td>
            <td>${req.status || "Pending"}</td>
            <td>
              <div class="table-actions">
                <button class="btn btn-primary btn-sm" data-action="approve" data-id="${req.id}">Approve</button>
                <button class="btn btn-outline btn-sm" data-action="reject" data-id="${req.id}">Reject</button>
              </div>
            </td>
          `;
            registrarRequestsBody.appendChild(tr);
          });
          registrarRequestsBody.querySelectorAll("button[data-action]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const action = btn.dataset.action;
              const id = btn.dataset.id;
              const req = snapshot.docs.find((d) => d.id === id)?.data() || {};
              handleEnrollmentRequestAction({ id, ...req }, action === "approve");
            });
          });
        },
        (err) => {
          console.error("Registrar requests listener error:", err);
          if (registrarRequestsBody) {
            registrarRequestsBody.innerHTML =
              '<tr><td colspan="5" style="padding:0.6rem; text-align:center; color:var(--ssu-danger);">Error loading requests.</td></tr>';
          }
        }
      );
    };

    const buildReportCardHtml = (req) => {
      const now = new Date().toLocaleString("en-PH");
      return `
      <div style="margin-bottom:0.6rem;">
        <div style="font-weight:700; font-size:1rem;">SSU Report Card</div>
        <div style="color:var(--ssu-muted); font-size:0.82rem;">Generated: ${now}</div>
      </div>
      <div><strong>Student:</strong> ${req.studentName || req.studentId || ""}</div>
      <div><strong>Class:</strong> ${getClassLabel(req.classId) || "Class not set"}</div>
      <div><strong>Teacher:</strong> ${req.teacherName || "Teacher not set"}</div>
      <div><strong>Status:</strong> ${req.status || "Done"}</div>
      <div style="margin-top:0.6rem;"><strong>Remarks:</strong> ${req.reason || "N/A"}</div>
      <div style="margin-top:0.6rem;">
        <button type="button" class="btn btn-primary btn-sm" onclick="window.print()">Print</button>
      </div>
    `;
    };

    const subscribeRegistrarReportRequests = () => {
      if (!db) return;
      if (registrarReportUnsub) {
        registrarReportUnsub();
        registrarReportUnsub = null;
      }
      if (registrarReportBody) {
        registrarReportBody.innerHTML =
          '<tr><td colspan="6" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">Loading requests...</td></tr>';
      }
      registrarReportUnsub = onSnapshot(
        collection(db, "reportCardRequests"),
        (snap) => {
          if (!registrarReportBody) return;
          registrarReportBody.innerHTML = "";
          if (snap.empty) {
            registrarReportBody.innerHTML =
              '<tr><td colspan="6" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">No requests.</td></tr>';
            return;
          }
          snap.forEach((docSnap) => {
            const req = { id: docSnap.id, ...docSnap.data() };
            const status = req.status || "Pending";
            const teacherUid = req.teacherUid || "";
            const teacherLabel = req.teacherName || teacherNameCache[teacherUid] || "Teacher not set";
            const classLabel = getClassLabel(req.classId) || "Class not set";
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${req.studentName || req.studentId || ""}</td>
            <td>${classLabel}</td>
            <td data-teacher-cell>${teacherLabel}</td>
            <td>${req.reason || ""}</td>
            <td>${status}</td>
            <td>
              <div class="table-actions">
                ${status.toLowerCase() === "pending"
                ? `<button class="btn btn-primary btn-sm" data-action="done" data-id="${req.id}">Mark done</button>
                       <button class="btn btn-outline btn-sm" data-action="reject" data-id="${req.id}">Reject</button>`
                : `<button class="btn btn-outline btn-sm" data-action="view" data-id="${req.id}">View</button>`
              }
              </div>
            </td>
          `;
            registrarReportBody.appendChild(tr);

            // If we don't yet have a readable teacher name, resolve once and update the cell
            if (!req.teacherName && teacherUid && !teacherNameCache[teacherUid]) {
              getDoc(doc(db, "users", teacherUid))
                .then((snapDoc) => {
                  if (snapDoc.exists()) {
                    const data = snapDoc.data();
                    teacherNameCache[teacherUid] = data.name || data.idOrEmail || teacherUid;
                    const cell = tr.querySelector("[data-teacher-cell]");
                    if (cell) cell.textContent = teacherNameCache[teacherUid];
                  }
                })
                .catch((err) => console.error("Error resolving teacher name:", err));
            }
          });
          registrarReportBody.querySelectorAll("button[data-action]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const id = btn.dataset.id;
              const action = btn.dataset.action;
              if (action === "view") {
                const req = snap.docs.find((d) => d.id === id)?.data() || {};
                showAppModal("Report card preview", buildReportCardHtml({ id, ...req }));
                return;
              }
              handleReportRequestAction(id, action === "done");
            });
          });
        },
        (err) => {
          console.error("Registrar report requests listener error:", err);
          if (registrarReportBody) {
            registrarReportBody.innerHTML =
              '<tr><td colspan="6" style="padding:0.6rem; text-align:center; color:var(--ssu-danger);">Error loading requests.</td></tr>';
          }
        }
      );
    };

    const subscribeRegistrarApprovals = () => {
      if (!db) return;
      if (registrarApprovalsUnsub) {
        registrarApprovalsUnsub();
        registrarApprovalsUnsub = null;
      }
      registrarApprovalsUnsub = onSnapshot(
        collection(db, "enrollmentChecks"),
        (snapshot) => {
          if (!registrarApprovalsBody) return;
          registrarApprovalsBody.innerHTML = "";
          if (snapshot.empty) {
            const tr = document.createElement("tr");
            tr.innerHTML =
              '<td colspan="7" style="padding:0.7rem; text-align:center; color:var(--ssu-muted); font-size:0.82rem;">No approvals pending.</td>';
            registrarApprovalsBody.appendChild(tr);
            return;
          }
          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const updated =
              data.updatedAt && data.updatedAt.toDate ? data.updatedAt.toDate() : null;
            const gradeClass =
              data.gradesStatus === "Complete" ? "badge-pill-success" : "badge-pill-accent";
            const paymentClass =
              data.paymentStatus === "Cleared" ? "badge-pill-success" : "badge-pill-accent";
            const statusClass =
              data.status === "Approved"
                ? "badge-pill-success"
                : data.status === "On hold"
                  ? "badge-pill-danger"
                  : "badge-pill-accent";
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${data.studentName || ""}</td>
            <td>${data.program || ""}</td>
            <td>${data.subject || ""}</td>
            <td><span class="badge ${gradeClass}">${data.gradesStatus || ""}</span></td>
            <td><span class="badge ${paymentClass}">${data.paymentStatus || ""}</span></td>
            <td><span class="badge ${statusClass}">${data.status || ""}</span></td>
            <td>${updated ? updated.toLocaleDateString("en-PH") : ""}</td>
          `;
            registrarApprovalsBody.appendChild(tr);
          });
        },
        (err) => console.error("Registrar approvals listener error:", err)
      );
    };

    // Load classes for registrar enroll dropdown
    const loadRegistrarClasses = async (teacherUid = "") => {
      if (!regEnrollClass) return;
      try {
        let q = collection(db, "classes");
        if (teacherUid) {
          q = query(q, where("teacherUid", "==", teacherUid));
        }
        const snap = await getDocs(q);
        registrarClassesCache = snap.docs.map((docSnap) => ({
          id: docSnap.id,
          ...docSnap.data(),
        }));
        regEnrollClass.innerHTML = '<option value="">Select class</option>';
        registrarClassesCache.forEach((cls) => {
          const opt = document.createElement("option");
          opt.value = cls.id;
          opt.textContent = cls.section || cls.id;
          opt.dataset.section = cls.section || "";
          regEnrollClass.appendChild(opt);
        });
      } catch (err) {
        console.error("Error loading classes for registrar:", err);
      }
    };

    // Load teachers for registrar enroll dropdown
    const loadRegistrarTeachers = async () => {
      if (!regEnrollTeacher) return;
      try {
        const snap = await getDocs(
          query(collection(db, "users"), where("role", "==", "teacher"))
        );
        registrarTeachersCache = snap.docs.map((docSnap) => ({
          uid: docSnap.id,
          ...docSnap.data(),
        }));
        regEnrollTeacher.innerHTML = '<option value="">Select teacher</option>';
        registrarTeachersCache.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t.uid;
          opt.textContent = t.name || t.authEmail || t.idOrEmail || t.uid;
          regEnrollTeacher.appendChild(opt);
        });
      } catch (err) {
        console.error("Error loading teachers for registrar:", err);
      }
    };

    const handleEnrollmentRequestAction = async (req, approve) => {
      if (!req || !req.id) return;
      try {
        if (regRequestsAlert) regRequestsAlert.classList.add("hidden");
        const reason = !approve ? prompt("Enter rejection reason (optional):", "") : "";

        if (approve) {
          const sid = req.studentId || req.id;
          const name = req.name || "Student";
          const program = req.program || "BSIT";
          const yearLevel = req.yearLevel || "1";
          const classId = req.classId || "";
          const teacherUid = req.teacherUid || "";
          const section = req.section || req.classSection || "";
          const status = "Pending";

          await setDoc(
            doc(db, "students", sid),
            {
              studentId: sid,
              name,
              program,
              yearLevel,
              status,
              paymentStatus: "With balance",
              balance: req.balance ?? 1500,
              gradesStatus: "Pending",
              classId,
              section,
              teacherUid,
              updatedAt: serverTimestamp(),
              createdAt: serverTimestamp(),
            },
            { merge: true }
          );

          if (classId) {
            await setDoc(
              doc(db, "classes", classId, "students", sid),
              {
                studentId: sid,
                name,
                program,
                yearLevel,
                status,
                paymentStatus: "With balance",
                balance: req.balance ?? 1500,
                gradesStatus: "Pending",
                classId,
                section,
                teacherUid,
                updatedAt: serverTimestamp(),
                createdAt: serverTimestamp(),
              },
              { merge: true }
            );
          }

          await setDoc(
            doc(db, "enrollmentChecks", sid),
            {
              studentId: sid,
              studentName: name,
              program,
              programYear: `${program} ${yearLevel}`,
              hasCompleteGrades: false,
              hasClearedPayments: false,
              gradesStatus: "Pending",
              paymentStatus: "Pending",
              status,
              isPending: true,
              updatedAt: serverTimestamp(),
              createdAt: serverTimestamp(),
            },
            { merge: true }
          );
        }

        await setDoc(
          doc(db, "enrollmentRequests", req.id),
          {
            status: approve ? "Approved" : "Rejected",
            resolvedAt: serverTimestamp(),
            resolvedBy: currentUser ? currentUser.uid : null,
            rejectionReason: approve ? null : reason || "",
          },
          { merge: true }
        );

        if (approve) {
          if (req.teacherUid) {
            await sendNotification({
              toUid: req.teacherUid,
              type: "enrollment",
              title: "Enrollment approved",
              message: `${req.name || "Student"} assigned to your class ${getClassLabel(req.classId) || ""}.`,

            });
          }
          await sendNotification({
            toRole: "registrar",
            type: "enrollment",
            title: "Enrollment approved",
            message: `${req.name || "Student"} approved and added.`,
          });
        } else {
          await sendNotification({
            toRole: "registrar",
            type: "enrollment",
            title: "Enrollment rejected",
            message: `${req.name || "Student"} rejected${reason ? `: ${reason}` : ""}.`,
          });
        }

        if (regRequestsAlert && regRequestsAlertText) {
          regRequestsAlert.classList.remove("alert-error", "hidden");
          regRequestsAlert.classList.add("alert-success");
          regRequestsAlertText.textContent = approve
            ? "Request approved and student enrolled."
            : "Request rejected.";
        }
      } catch (err) {
        console.error("Error handling enrollment request:", err);
        if (regRequestsAlert && regRequestsAlertText) {
          regRequestsAlert.classList.remove("alert-success", "hidden");
          regRequestsAlert.classList.add("alert-error");
          regRequestsAlertText.textContent = "Error processing request. Please retry.";
        }
      }
    };

    const handleReportRequestAction = async (id, done) => {
      if (!id) return;
      try {
        if (regReportAlert) regReportAlert.classList.add("hidden");
        await setDoc(
          doc(db, "reportCardRequests", id),
          {
            status: done ? "Done" : "Rejected",
            updatedAt: serverTimestamp(),
            resolvedBy: currentUser ? currentUser.uid : null,
          },
          { merge: true }
        );
        // Notify the teacher who filed the request
        try {
          const snap = await getDoc(doc(db, "reportCardRequests", id));
          if (snap.exists()) {
            const data = snap.data();
            const targetUid = data.teacherUid;
            const studentId = data.studentId || "";
            const previewClassLabel = getClassLabel(data.classId) || "Class not set";
            const previewTeacherName = data.teacherName || "Teacher not set";
            const previewText = done
              ? `SSU Report Card\n\nStudent: ${data.studentName || data.studentId || ""}\nClass: ${previewClassLabel}\nTeacher: ${previewTeacherName}\nStatus: Done\nGenerated: ${new Date().toLocaleString("en-PH")}\n\nRemarks: ${data.reason || "N/A"}`
              : "";
            if (done) {
              await setDoc(
                doc(db, "reportCardRequests", id),
                { reportText: previewText, updatedAt: serverTimestamp() },
                { merge: true }
              );
              showAppModal("Report card preview", `<pre style="white-space:pre-wrap;">${previewText}</pre>`);
            }
            // Remove registrar-facing notifications for this request
            try {
              const notifSnap = await getDocs(
                query(
                  collection(db, "notifications"),
                  where("toRole", "==", "registrar"),
                  where("type", "==", "report-card"),
                  where("requestId", "==", id)
                )
              );
              for (const docRef of notifSnap.docs) {
                await deleteDoc(docRef.ref);
              }
            } catch (err) {
              console.error("Error clearing report-card notifications:", err);
            }

            if (targetUid) {
              await sendNotification({
                toUid: targetUid,
                type: "report-card",
                title: done ? "Report card ready" : "Report card request rejected",
                message: done
                  ? `Request for ${data.studentName || data.studentId || ""} marked done.`
                  : `Request for ${data.studentName || data.studentId || ""} was rejected.`,
                requestId: id,
                studentId,
                classId: data.classId || "",
              });
            }
          }
        } catch (err) {
          console.error("Error sending teacher notification for report-card:", err);
        }
        if (regReportAlert && regReportAlertText) {
          regReportAlert.classList.remove("alert-error", "hidden");
          regReportAlert.classList.add("alert-success");
          regReportAlertText.textContent = done ? "Marked as done." : "Request rejected.";
        }
      } catch (err) {
        console.error("Error handling report request:", err);
        if (regReportAlert && regReportAlertText) {
          regReportAlert.classList.remove("alert-success", "hidden");
          regReportAlert.classList.add("alert-error");
          regReportAlertText.textContent = "Error updating request.";
        }
      }
    };

    const generateRegistrarDoc = async () => {
      if (!registrarDocStudent || !registrarDocType || !registrarDocPreview) return;
      const id = registrarDocStudent.value.trim();
      if (!id) return;
      try {
        if (registrarDocAlert) registrarDocAlert.classList.add("hidden");
        const [studentSnap, checkSnap] = await Promise.all([
          getDoc(doc(db, "students", id)),
          getDoc(doc(db, "enrollmentChecks", id)),
        ]);
        if (!studentSnap.exists()) {
          if (registrarDocAlert && registrarDocAlertText) {
            registrarDocAlert.classList.remove("hidden");
            registrarDocAlertText.textContent = "Student not found.";
          }
          registrarDocPreview.textContent = "Document preview will appear here.";
          return;
        }
        const student = studentSnap.data();
        const check = checkSnap.exists() ? checkSnap.data() : {};
        const type = registrarDocType.value;
        const okGrades = check.hasCompleteGrades || check.gradesStatus === "Complete";
        const okPayments = check.hasClearedPayments || check.paymentStatus === "Cleared";
        if (!okGrades || !okPayments) {
          if (registrarDocAlert && registrarDocAlertText) {
            registrarDocAlert.classList.remove("hidden");
            registrarDocAlertText.textContent = "Grades or payments not cleared yet.";
          }
        }
        if (type === "cor") {
          registrarDocPreview.textContent = `SSU - Certificate of Registration (COR)\n\nStudent ID: ${id}\nName: ${student.name || ""}\nProgram: ${student.program || ""}\nYear: ${student.yearLevel || ""}\nGrades: ${okGrades ? "Complete" : "Pending"}\nPayments: ${okPayments ? "Cleared" : "Pending"}`;
        } else {
          registrarDocPreview.textContent = `SSU - Transcript of Records (TOR)\n\nStudent ID: ${id}\nName: ${student.name || ""}\nProgram: ${student.program || ""}\n\nStatus: Grades ${okGrades ? "complete" : "pending"}, Payments ${okPayments ? "cleared" : "pending"}.\n\n[Attach official grade rows here from your grades collection.]`;
        }
      } catch (err) {
        console.error(err);
        if (registrarDocAlert && registrarDocAlertText) {
          registrarDocAlert.classList.remove("hidden");
          registrarDocAlertText.textContent = "Error generating document.";
        }
      }
    };

    // ==========================
    //  Cashier Dashboard (real-time from "payments")
    // ==========================
    let cashierSummaryData = {
      day: { total: 0, count: 0, pending: 0 },
      week: { total: 0, count: 0, pending: 0 },
      month: { total: 0, count: 0, pending: 0 },
    };
    let cashierCurrentRange = "day";

    const updateCashierSummary = () => {
      const data = cashierSummaryData[cashierCurrentRange];
      if (!data) return;
      const totalEl = byId("summary-total");
      const countEl = byId("summary-receipts");
      const pendingEl = byId("summary-overdue");
      if (totalEl) totalEl.textContent = formatPeso(data.total);
      if (countEl) countEl.textContent = String(data.count);
      if (pendingEl) pendingEl.textContent = String(data.pending);
    };

    const renderCashierTransactions = () => {
      if (!cashierTransactionsBody) return;
      const filter = cashierStatusFilter?.value || "all";
      cashierTransactionsBody.innerHTML = "";
      if (cashierPaymentsCache.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td colspan="7" style="padding:0.7rem; text-align:center; color:var(--ssu-muted); font-size:0.82rem;">No transactions yet.</td>';
        cashierTransactionsBody.appendChild(tr);
        return;
      }
      const filtered = cashierPaymentsCache.filter((p) => filter === "all" || filter.toLowerCase() === (p.status || "").toLowerCase());
      const start = cashierTxnPageIndex * CASHIER_TXN_PAGE_SIZE;
      const pageItems = filtered.slice(start, start + CASHIER_TXN_PAGE_SIZE);
      if (pageItems.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td colspan="7" style="padding:0.7rem; text-align:center; color:var(--ssu-muted); font-size:0.82rem;">No transactions on this page.</td>';
        cashierTransactionsBody.appendChild(tr);
      } else {
        pageItems.forEach((p) => {
          let statusClass = "status-paid";
          if (p.status === "Partial") statusClass = "status-partial";
          else if (p.status !== "Paid") statusClass = "status-overdue";
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${p.studentId || ""}</td>
          <td>${p.studentName || ""}</td>
          <td style="text-align: right;">${formatPeso(p.amount)}</td>
          <td>${p.feeType || ""}</td>
          <td><span class="badge ${statusClass}">${p.status || ""}</span></td>
          <td>${p.date || ""}</td>
          <td><button class="btn btn-outline btn-sm" data-receipt-id="${p.id || ""}">Print</button></td>
        `;
          cashierTransactionsBody.appendChild(tr);
        });
        cashierTransactionsBody.querySelectorAll("button[data-receipt-id]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-receipt-id");
            const pay = findPaymentById(id);
            showAppModal("Receipt", buildReceiptHtml(pay));
          });
        });
      }
      const maxPage = Math.max(0, Math.floor((filtered.length - 1) / CASHIER_TXN_PAGE_SIZE));
      if (cashierTxnPage) cashierTxnPage.textContent = String(Math.min(cashierTxnPageIndex, maxPage) + 1);
      if (cashierTxnPrev) cashierTxnPrev.disabled = cashierTxnPageIndex === 0;
      if (cashierTxnNext) cashierTxnNext.disabled = cashierTxnPageIndex >= maxPage;
    };

    const renderCashierRecent = () => {
      if (!cashierRecentBody) return;
      const start = cashierRecentPageIndex * CASHIER_RECENT_PAGE_SIZE;
      const pageItems = cashierRecentCache.slice(start, start + CASHIER_RECENT_PAGE_SIZE);
      cashierRecentBody.innerHTML = "";
      if (pageItems.length === 0) {
        cashierRecentBody.innerHTML =
          '<tr><td colspan="6" style="padding:0.7rem; text-align:center; color:var(--ssu-muted); font-size:0.82rem;">No payments yet.</td></tr>';
      } else {
        pageItems.forEach((data) => {
          const tr = document.createElement("tr");
          let statusClass = "status-paid";
          if (data.status === "Partial") statusClass = "status-partial";
          else if (data.status !== "Paid") statusClass = "status-overdue";
          tr.innerHTML = `
          <td>${data.timeText || ""}</td>
          <td>${data.studentName || ""}</td>
          <td>${data.studentId || ""}</td>
          <td>${data.feeType || ""}</td>
          <td class="amount-positive">${formatPeso(data.amount)}</td>
          <td><span class="badge ${statusClass}">${data.status || ""}</span></td>
          <td><button class="btn btn-outline btn-sm" data-receipt-id="${data.id || ""}">Print</button></td>
        `;
          cashierRecentBody.appendChild(tr);
        });
        cashierRecentBody.querySelectorAll("button[data-receipt-id]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-receipt-id");
            const pay = findPaymentById(id);
            showAppModal("Receipt", buildReceiptHtml(pay));
          });
        });
      }
      if (cashierRecentPage) {
        cashierRecentPage.textContent = String(cashierRecentPageIndex + 1);
      }
      if (cashierRecentPrev) {
        cashierRecentPrev.disabled = cashierRecentPageIndex === 0;
      }
      if (cashierRecentNext) {
        cashierRecentNext.disabled = start + CASHIER_RECENT_PAGE_SIZE >= cashierRecentCache.length;
      }
    };

    const subscribeCashierDashboard = () => {
      if (!db) return;

      clearCashierSubscription();

      const paymentsRef = collection(db, "payments");
      const qPayments = query(paymentsRef, orderBy("timestamp", "desc"), limit(100));

      cashierUnsubscribe = onSnapshot(
        qPayments,
        (snapshot) => {
          const now = new Date();
          cashierSummaryData = {
            day: { total: 0, count: 0, pending: 0 },
            week: { total: 0, count: 0, pending: 0 },
            month: { total: 0, count: 0, pending: 0 },
          };
          cashierPaymentsCache = [];
          cashierRecentCache = [];
          cashierRecentPageIndex = 0;
          cashierTxnPageIndex = 0;

          if (cashierRecentBody) cashierRecentBody.innerHTML = "";
          if (cashierTransactionsBody) cashierTransactionsBody.innerHTML = "";

          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const ts = data.timestamp && data.timestamp.toDate
              ? data.timestamp.toDate()
              : new Date();
            const diffMs = now - ts;
            const diffDays = diffMs / (1000 * 60 * 60 * 24);
            const amount = Number(data.amount || 0);
            const status = data.status || "Paid";

            const bump = (range) => {
              const r = cashierSummaryData[range];
              if (!r) return;
              r.total += amount;
              r.count += 1;
              if (status !== "Paid") r.pending += 1;
            };

            if (diffDays < 1) {
              bump("day");
              bump("week");
              bump("month");
            } else if (diffDays < 7) {
              bump("week");
              bump("month");
            } else if (diffDays < 31) {
              bump("month");
            }

            // Recent payments cache
            const timeText = ts.toLocaleTimeString("en-PH", {
              hour: "2-digit",
              minute: "2-digit",
              hour12: true,
            });
            cashierRecentCache.push({
              id: docSnap.id,
              timeText,
              ...data,
              amount,
              status,
              timestamp: ts.getTime(),
            });

            if (cashierTransactionsBody) {
              cashierPaymentsCache.push({
                id: docSnap.id,
                ...data,
                amount,
                status,
                date: ts.toLocaleDateString("en-PH"),
              });
            }
          });

          cashierRecentCache.sort((a, b) => b.timestamp - a.timestamp);
          renderCashierRecent();
          renderCashierTransactions();
          updateCashierSummary();
        },
        (err) => console.error("Cashier dashboard listener error:", err)
      );
    };

    const refreshCashierData = () => {
      subscribeCashierDashboard();
    };

    if (cashierRefreshButton) {
      cashierRefreshButton.addEventListener("click", refreshCashierData);
    }

    // ==========================
    //  Route by role
    // ==========================
    const routeToRole = (role, name, uid, tutorialSeenFlag, gamerModeFlag) => {
      hide(authContainer);
      hideAllModules();

      const safeName = name || "SSU User";
      const userId = uid || (currentUser && currentUser.uid);

      if (role === "cashier" && modules.cashier) {
        show(modules.cashier);
        const el = byId("cashier-user-name");
        if (el) el.textContent = safeName;
        subscribeCashierDashboard();
        cashierNotifsUnsubs = subscribeNotifications("cashier", userId, cashierNotificationsList, cashierNotifBuffers) || [];
      } else if (role === "registrar" && modules.registrar) {
        show(modules.registrar);
        const el = byId("registrar-user-name");
        if (el) el.textContent = safeName;
        subscribeRegistrarDashboard();
        subscribeRegistrarStudents();
        subscribeRegistrarApprovals();
        subscribeRegistrarRequests();
        subscribeRegistrarReportRequests();
        loadRegistrarTeachers();
        loadRegistrarClasses();
        registrarNotifsUnsubs = subscribeNotifications("registrar", userId, registrarNotificationsList, registrarNotifBuffers) || [];
        loadProfile("registrar");
      } else if (modules.teacher) {
        show(modules.teacher);
        const el = byId("teacher-user-name");
        if (el) el.textContent = safeName;
        subscribeTeacherDashboard(userId);
        subscribeTeacherArtifacts();
        teacherNotifsUnsubs = subscribeNotifications("teacher", userId, teacherNotificationsList, teacherNotifBuffers) || [];
        loadProfile("teacher");
      }

      // Apply gamer mode for teachers
      if (role === "teacher") {
        applyGamerMode(!!gamerModeFlag);
        if (typeof gamerModeFlag === "undefined" || gamerModeFlag === null) {
          showGamerPrompt();
        }
      } else {
        applyGamerMode(false);
      }

      // Show tutorial for first-time users (one time per browser)
      if (tutorialSeenFlag === false || (!tutorialSeenFlag && !hasSeenTutorial())) {
        showTutorial();
      }
    };

    // ==========================
    //  Auth tab switching
    // ==========================
    if (chipLogin && chipRegister && loginView && registerView) {
      chipLogin.addEventListener("click", () => {
        chipLogin.classList.add("active");
        chipRegister.classList.remove("active");
        show(loginView);
        hide(registerView);
      });

      chipRegister.addEventListener("click", () => {
        chipRegister.classList.add("active");
        chipLogin.classList.remove("active");
        show(registerView);
        hide(loginView);
      });
    }

    if (backToLoginLink && chipLogin) {
      backToLoginLink.addEventListener("click", (e) => {
        e.preventDefault();
        chipLogin.click();
      });
    }

    roleCards.forEach((card) => {
      card.addEventListener("click", () => {
        roleCards.forEach((c) => c.classList.remove("role-card-selected"));
        card.classList.add("role-card-selected");
        selectedRole = card.getAttribute("data-role");
      });
    });

    if (quickRoleHint) {
      quickRoleHint.addEventListener("click", () => {
        alert(
          "Sample usage:\n- Register once as Teacher, Cashier, or Registrar.\n- Login using the same ID/email + password.\n- The portal opens the module for your role."
        );
      });
    }

    if (forgotPasswordLink) {
      forgotPasswordLink.addEventListener("click", (e) => {
        e.preventDefault();
        const prefill = loginIdentifier?.value.trim() || "";
        showAppModal(
          "Reset password",
          `
        <div style="display:flex; flex-direction:column; gap:0.7rem; padding:0.2rem 0;">
          <p class="helper-text" style="margin:0;">Enter your SSU email or ID. We will email you a reset link.</p>
          <div class="input-group" style="margin-bottom:0;">
            <label for="forgot-email-input">Email or ID</label>
            <input id="forgot-email-input" class="input" type="text" placeholder="e.g. 2020-00123 or teacher@ssu.edu.ph" value="${prefill}" />
          </div>
          <div id="forgot-status" class="helper-text" style="min-height:1.2rem;"></div>
          <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.1rem;">
            <button type="button" class="btn btn-outline btn-sm" id="forgot-cancel">Cancel</button>
            <button type="button" class="btn btn-primary btn-sm" id="forgot-submit">Send reset link</button>
          </div>
        </div>
        `
        );

        const emailInput = document.getElementById("forgot-email-input");
        const statusEl = document.getElementById("forgot-status");
        const submitBtn = document.getElementById("forgot-submit");
        const cancelBtn = document.getElementById("forgot-cancel");

        const setStatus = (msg, ok = false) => {
          if (!statusEl) return;
          statusEl.textContent = msg;
          statusEl.style.color = ok ? "var(--ssu-success)" : "var(--ssu-danger)";
        };

        const closeModal = () => {
          if (appModal.backdrop) appModal.backdrop.classList.add("hidden");
        };

        const handleReset = async () => {
          const raw = emailInput?.value.trim() || "";
          if (!raw) {
            setStatus("Please enter your email or ID.", false);
            return;
          }
          submitBtn.disabled = true;
          setStatus("Sending reset email...", true);
          const authEmail = normalizeIdentifier(raw);
          try {
            // Check if user exists before sending reset (best-effort; falls back if rules block read)
            try {
              const found = await getDocs(
                query(collection(db, "users"), where("authEmail", "==", authEmail), limit(1))
              );
              if (found.empty) {
                setStatus("Email does not exist.", false);
                return;
              }
            } catch (checkErr) {
              console.warn("Skip existence check (permission issue); continuing reset.", checkErr);
            }

            await sendPasswordResetEmail(auth, authEmail);
            setStatus(`Reset link sent to ${authEmail}.`, true);
            setTimeout(closeModal, 1200);
          } catch (error) {
            console.error("Reset error:", error);
            let msg = "Could not send reset email. Please try again.";
            if (error.code === "auth/user-not-found") {
              msg = "Email does not exist.";
            } else if (error.code === "auth/invalid-email") {
              msg = "Email/ID looks invalid.";
            } else if (error.code === "auth/too-many-requests") {
              msg = "Too many attempts. Try again later.";
            }
            setStatus(msg, false);
          } finally {
            submitBtn.disabled = false;
          }
        };

        submitBtn?.addEventListener("click", handleReset);
        cancelBtn?.addEventListener("click", closeModal);
        emailInput?.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter") {
            ev.preventDefault();
            handleReset();
          }
        });
        emailInput?.focus();
      });
    }

    // ==========================
    //  Registration
    // ==========================
    if (registerForm) {
      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (registerAlert) hide(registerAlert);

        const name = regName?.value.trim() || "";
        const idOrEmail = regIdentifier?.value.trim() || "";
        const password = regPassword?.value || "";
        const confirm = regConfirm?.value || "";

        if (!name || !idOrEmail || !password || !confirm || !selectedRole) {
          if (registerAlert) {
            registerAlert.querySelector("div:nth-child(2)").innerHTML =
              "<strong>Registration incomplete.</strong> Please fill all fields and choose a role.";
            show(registerAlert);
          }
          return;
        }

        if (password !== confirm) {
          if (registerAlert) {
            registerAlert.querySelector("div:nth-child(2)").innerHTML =
              "<strong>Password mismatch.</strong> Make sure both passwords match.";
            show(registerAlert);
          }
          return;
        }

        const authEmail = normalizeIdentifier(idOrEmail);

        try {
          const cred = await createUserWithEmailAndPassword(auth, authEmail, password);
          const user = cred.user;

          await setDoc(doc(db, "users", user.uid), {
            name,
            idOrEmail,
            authEmail,
            role: selectedRole,
            gamerMode: null,
            tutorialSeen: false,
            createdAt: new Date().toISOString(),
          });

          // Auto-create a starter class for teachers so they see a class without manual UID wiring
          if (selectedRole === "teacher") {
            const classId = `class-${user.uid}-${Date.now()}`;
            await setDoc(
              doc(db, "classes", classId),
              {
                teacherUid: user.uid,
                section: "Section A",
                courseCode: "SIA101",
                schedule: "8:00AM TO 10:00AM",
                room: "NCAS 13",
                pendingLabel: "",
                isToday: false,
                hasPendingGrades: false,
                attendanceAlerts: 0,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            );
          }

          alert(
            `Account registered as ${selectedRole.toUpperCase()}.\nYou can now login using "${idOrEmail}" and your password.`
          );

          if (chipLogin) chipLogin.click();
          if (loginIdentifier) loginIdentifier.value = idOrEmail;
          if (loginPassword) loginPassword.value = "";
        } catch (error) {
          console.error(error);
          let msg = "Registration failed. Please try again.";
          if (error.code === "auth/email-already-in-use") {
            msg = "This ID/email is already registered.";
          } else if (error.code === "auth/weak-password") {
            msg = "Password is too weak. Use at least 6 characters.";
          }
          if (registerAlert) {
            registerAlert.querySelector("div:nth-child(2)").innerHTML =
              `<strong>Registration error.</strong> ${msg}`;
            show(registerAlert);
          }
        }
      });
    }

    // ==========================
    //  Login
    // ==========================
    if (loginForm) {
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (loginAlert) hide(loginAlert);

        const idOrEmail = loginIdentifier?.value.trim() || "";
        const password = loginPassword?.value || "";
        if (!idOrEmail || !password) {
          if (loginAlert) show(loginAlert);
          return;
        }

        const authEmail = normalizeIdentifier(idOrEmail);

        try {
          const cred = await signInWithEmailAndPassword(auth, authEmail, password);
          const user = cred.user;
          const snap = await getDoc(doc(db, "users", user.uid));
          if (!snap.exists()) {
            if (loginAlert) {
              loginAlert.querySelector("div:nth-child(2)").innerHTML =
                "<strong>Profile not found.</strong> Contact administrator.";
              show(loginAlert);
            }
            return;
          }
          const data = snap.data();
          currentUser = user;
          routeToRole(data.role || "teacher", data.name || "SSU User", user.uid, data.tutorialSeen, data.gamerMode);
        } catch (error) {
          console.error(error);
          if (loginAlert) {
            loginAlert.querySelector("div:nth-child(2)").innerHTML =
              "<strong>Login failed.</strong> Please check your ID/email and password.";
            show(loginAlert);
          }
        }
      });
    }

    // ==========================
    //  Logout
    // ==========================
    const setupLogout = (id) => {
      const btn = byId(id);
      if (!btn) return;
      btn.addEventListener("click", async () => {
        await signOut(auth);
        hideAllModules();
        show(authContainer);
        if (loginPassword) loginPassword.value = "";
      });
    };
    setupLogout("logout-teacher");
    setupLogout("logout-cashier");
    setupLogout("logout-registrar");

    // ==========================
    //  Sidebar navigation per module
    // ==========================
    const setupModuleNav = (moduleKey) => {
      const moduleEl = modules[moduleKey];
      if (!moduleEl) return;
      const buttons = moduleEl.querySelectorAll(".sidebar-nav button, .mobile-nav button");
      const panels = moduleEl.querySelectorAll("section.panel");

      const activatePanel = (panelKey) => {
        if (!panelKey) return;
        buttons.forEach((b) => {
          const isActive = b.getAttribute("data-panel") === panelKey;
          b.classList.toggle("active", isActive);
        });
        panels.forEach((p) => {
          const wantedId = `${moduleKey}-panel-${panelKey}`;
          if (p.id === wantedId) show(p);
          else hide(p);
        });
      };

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          activatePanel(btn.getAttribute("data-panel"));
        });
      });

      const initial = moduleEl.querySelector(".sidebar-nav button.active, .mobile-nav button.active");
      if (initial) activatePanel(initial.getAttribute("data-panel"));
    };
    ["teacher", "cashier", "registrar"].forEach(setupModuleNav);

    // Quick shortcuts e.g. data-open="teacher-grades"
    document.querySelectorAll("[data-open]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-open");
        if (!target) return;
        const [moduleKey, panelKey] = target.split("-");
        const navBtn = findNavButton(moduleKey, panelKey);
        if (navBtn) navBtn.click();
      });
    });

    // ==========================
    //  Cashier search & payment (now with Firestore)
    // ==========================
    const cashierSearchInput = byId("cashier-search-input");
    const cashierSearchBtn = byId("cashier-search-btn");
    const cashierAccountName = byId("cashier-account-name");
    const cashierAccountId = byId("cashier-account-id");
    const cashierAccountBalance = byId("cashier-account-balance");
    const cashierAccountStatus = byId("cashier-account-status");
    const cashierSearchAlert = byId("cashier-search-alert");
    const cashierSearchAlertText = byId("cashier-search-alert-text");

    const showCashierSearchAlert = (message, type = "error") => {
      if (!cashierSearchAlert || !cashierSearchAlertText) return;
      cashierSearchAlert.classList.remove("alert-success", "alert-error", "hidden");
      cashierSearchAlert.classList.add(type === "success" ? "alert-success" : "alert-error");
      cashierSearchAlertText.textContent = message;
    };

    const hideCashierSearchAlert = () => {
      cashierSearchAlert?.classList.add("hidden");
    };

    if (cashierSearchBtn) {
      cashierSearchBtn.addEventListener("click", async () => {
        const term = cashierSearchInput?.value.trim();
        if (!term) {
          showCashierSearchAlert("Enter a Student ID to search.", "error");
          return;
        }
        try {
          // Simple version: student doc ID = Student ID
          const snap = await getDoc(doc(db, "students", term));
          if (!snap.exists()) {
          showCashierSearchAlert("No student found with that ID.", "error");
          return;
        }
        const data = snap.data();

        if (cashierAccountName) cashierAccountName.textContent = data.name || "(No name)";
        if (cashierAccountId) cashierAccountId.textContent = data.studentId || term;
        if (cashierAccountBalance)
          cashierAccountBalance.textContent = formatPeso(data.balance || 0);
        if (cashierAccountStatus)
          cashierAccountStatus.textContent = data.status || "Unknown";

        // Optional: prefill payment form
        const payId = byId("pay-student-id");
        const payName = byId("pay-student-name");
        if (payId) payId.value = data.studentId || term;
        if (payName) payName.value = data.name || "";
        showCashierSearchAlert("Student account loaded.", "success");
      } catch (err) {
        console.error(err);
        showCashierSearchAlert("Error searching student account.", "error");
      }
    });
  }

    const cashierPaymentForm = byId("cashier-payment-form");
    const cashierPaymentMessage = byId("cashier-payment-message");
    const cashierRefreshButton = byId("cashier-refresh");
    if (cashierPaymentForm && cashierPaymentMessage) {
      cashierPaymentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        cashierPaymentMessage.classList.remove("alert-success", "alert-error");

        const id = byId("pay-student-id")?.value.trim();
        const name = byId("pay-student-name")?.value.trim();
        const type = byId("pay-type")?.value;
        const amountStr = byId("pay-amount")?.value;
        const notes = byId("pay-notes")?.value.trim() || "";

        const amount = parseFloat(amountStr || "0");
        let stuData = null;
        if (!id || !name || !type || !amount || isNaN(amount)) {
          cashierPaymentMessage.classList.add("alert-error");
          cashierPaymentMessage.innerHTML =
            '<div class="alert-icon">!</div><div><strong>Missing or invalid information.</strong> Please complete all required fields.</div>';
          show(cashierPaymentMessage);
          return;
        }

        try {
          // Fetch current balance to compute clearance
          let currentBalance = 0;
          try {
            const stuSnap = await getDoc(doc(db, "students", id));
            if (stuSnap.exists()) {
              stuData = stuSnap.data();
              currentBalance = Number(stuData.balance || 0);
            }
          } catch (err) {
            console.error("Error reading student balance:", err);
          }

          await addDoc(collection(db, "payments"), {
            studentId: id,
            studentName: name,
            feeType: type,
            amount,
            notes,
            status: "Paid",
            cashierUid: currentUser ? currentUser.uid : null,
            timestamp: serverTimestamp(),
          });
          const newBalance = Math.max(currentBalance - amount, 0);
          const cleared = newBalance <= 0;

          // Update student + enrollment check so Registrar sees clearance
          await Promise.all([
            setDoc(
              doc(db, "students", id),
              {
                balance: newBalance,
                paymentStatus: cleared ? "Cleared" : "With balance",
                status: cleared ? "Enrolled" : "Pending",
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            ),
            setDoc(
              doc(db, "enrollmentChecks", id),
              {
                studentId: id,
                studentName: name,
                hasClearedPayments: cleared,
                paymentStatus: cleared ? "Cleared" : "Pending",
                status: cleared ? "Ready" : "Awaiting payment",
                isPending: !cleared,
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            ),
          ]);

          // Notify registrar + teacher (if student has teacherUid) of payment update
          await Promise.all([
            sendNotification({
              toRole: "registrar",
              type: "payment",
              title: "Payment posted",
              message: `${name} (${id}) paid ${formatPeso(amount)} (${type}). Balance now ${formatPeso(newBalance)}.`,
            }),
            stuData?.teacherUid
              ? sendNotification({
                toUid: stuData.teacherUid,
                type: "payment",
                title: "Payment posted",
                message: `${name} (${id}) paid ${formatPeso(amount)}. Balance now ${formatPeso(newBalance)}.`,
              })
              : Promise.resolve(),
          ]);

          cashierPaymentMessage.classList.add("alert-success");
          cashierPaymentMessage.innerHTML =
            `<div class="alert-icon">!</div><div><strong>Payment posted.</strong> Receipt generated for ${name} (${id}).</div>`;
          show(cashierPaymentMessage);
          cashierPaymentForm.reset();
        } catch (err) {
          console.error(err);
          cashierPaymentMessage.classList.add("alert-error");
          cashierPaymentMessage.innerHTML =
            '<div class="alert-icon">!</div><div><strong>Error posting payment.</strong> Please try again.</div>';
          show(cashierPaymentMessage);
          // Notify Registrar and Teacher about the failed payment attempt
          try {
            const failMsg = `${name || "Student"} (${id || "N/A"}) payment of ${formatPeso(
              amount || 0
            )} for ${type || "Payment"} failed.`;
            const notifyOps = [
              sendNotification({
                toRole: "registrar",
                type: "payment-failure",
                title: "Payment failed",
                message: failMsg,
              }),
            ];
            if (stuData?.teacherUid) {
              notifyOps.push(
                sendNotification({
                  toUid: stuData.teacherUid,
                  type: "payment-failure",
                  title: "Payment failed",
                  message: failMsg,
                })
              );
            }
            await Promise.all(notifyOps);
          } catch (notifyErr) {
            console.error("Error sending payment failure notification:", notifyErr);
          }
        }
      });
    }

    const cashierRangeSwitch = byId("cashier-range-switch");
    if (cashierRangeSwitch) {
      const buttons = cashierRangeSwitch.querySelectorAll("button[data-range]");
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          buttons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          cashierCurrentRange = btn.dataset.range || "day";
          updateCashierSummary();
        });
      });
    }
    if (cashierStatusFilter) {
      cashierStatusFilter.addEventListener("change", () => {
        cashierTxnPageIndex = 0;
        renderCashierTransactions();
      });
    }
    if (cashierRecentPrev) {
      cashierRecentPrev.addEventListener("click", () => {
        if (cashierRecentPageIndex > 0) {
          cashierRecentPageIndex -= 1;
          renderCashierRecent();
        }
      });
    }
    if (cashierRecentNext) {
      cashierRecentNext.addEventListener("click", () => {
        const maxPage = Math.floor((cashierRecentCache.length - 1) / CASHIER_RECENT_PAGE_SIZE);
        if (cashierRecentPageIndex < maxPage) {
          cashierRecentPageIndex += 1;
          renderCashierRecent();
        }
      });
    }
    if (cashierTxnPrev) {
      cashierTxnPrev.addEventListener("click", () => {
        if (cashierTxnPageIndex > 0) {
          cashierTxnPageIndex -= 1;
          renderCashierTransactions();
        }
      });
    }
    if (cashierTxnNext) {
      cashierTxnNext.addEventListener("click", () => {
        const maxPage = Math.floor((cashierPaymentsCache.filter((p) => {
          const filter = cashierStatusFilter?.value || "all";
          return filter === "all" || filter.toLowerCase() === (p.status || "").toLowerCase();
        }).length - 1) / CASHIER_TXN_PAGE_SIZE);
        if (cashierTxnPageIndex < maxPage) {
          cashierTxnPageIndex += 1;
          renderCashierTransactions();
        }
      });
    }
    const loadStudentsWithBalance = async () => {
      if (!cashierBalanceBody) return;
      cashierBalanceBody.innerHTML =
        '<tr><td colspan="4" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">Loading...</td></tr>';
      if (cashierBalanceTitle) cashierBalanceTitle.textContent = "Students with remaining balance";
      try {
        const snap = await getDocs(collection(db, "students"));
        const rows = [];
        snap.forEach((docSnap) => {
          const s = docSnap.data();
          const rawBalance = s.balance ?? 0;
          const balNum =
            typeof rawBalance === "string"
              ? parseFloat(String(rawBalance).replace(/[^0-9.-]/g, ""))
              : Number(rawBalance || 0);
          const hasBalance = Number.isFinite(balNum) && balNum > 0;
          const statusText = (s.paymentStatus || s.status || "").toLowerCase();
          const statusBalance =
            statusText.includes("balance") || statusText.includes("pending") || statusText.includes("hold");

          if (hasBalance || statusBalance) {
            rows.push({
              id: s.studentId || docSnap.id,
              name: s.name || "",
              program: s.program || "",
              balance: Number.isFinite(balNum) && balNum > 0 ? balNum : 0,
            });
          }
        });
        cashierBalanceBody.innerHTML = "";
        if (rows.length === 0) {
          cashierBalanceBody.innerHTML =
            '<tr><td colspan="4" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">No students with remaining balance.</td></tr>';
          return;
        }
        rows.forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.name}</td>
          <td>${s.program}</td>
          <td style="text-align:right;">${formatPeso(s.balance || 0)}</td>
        `;
          tr.style.cursor = "pointer";
          tr.addEventListener("click", () => {
            const payId = byId("pay-student-id");
            const payName = byId("pay-student-name");
            const payAmount = byId("pay-amount");
            const dashboardBtn = findNavButton("cashier", "dashboard");
            if (payId) payId.value = s.id;
            if (payName) payName.value = s.name || "";
            if (payAmount && s.balance) payAmount.value = s.balance;
            if (dashboardBtn) dashboardBtn.click();
            const form = byId("cashier-payment-form");
            if (form && form.scrollIntoView) form.scrollIntoView({ behavior: "smooth", block: "center" });
          });
          cashierBalanceBody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading students with balance:", err);
        cashierBalanceBody.innerHTML =
          '<tr><td colspan="4" style="padding:0.6rem; text-align:center; color:var(--ssu-danger);">Error loading balances.</td></tr>';
      }
    };
    const loadStudentsPaid = async () => {
      if (!cashierBalanceBody) return;
      cashierBalanceBody.innerHTML =
        '<tr><td colspan="4" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">Loading...</td></tr>';
      if (cashierBalanceTitle) cashierBalanceTitle.textContent = "Students paid";
      try {
        const snap = await getDocs(collection(db, "students"));
        const rows = [];
        snap.forEach((docSnap) => {
          const s = docSnap.data();
          const balNum = Number(s.balance || 0);
          const cleared = (s.paymentStatus || "").toLowerCase() === "cleared" || balNum <= 0;
          if (cleared) {
            rows.push({
              id: s.studentId || docSnap.id,
              name: s.name || "",
              program: s.program || "",
              balance: balNum,
            });
          }
        });
        cashierBalanceBody.innerHTML = "";
        if (rows.length === 0) {
          cashierBalanceBody.innerHTML =
            '<tr><td colspan="4" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">No paid students found.</td></tr>';
          return;
        }
        rows.forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.name}</td>
          <td>${s.program}</td>
          <td style="text-align:right;">${formatPeso(s.balance || 0)}</td>
        `;
          cashierBalanceBody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading paid students:", err);
        cashierBalanceBody.innerHTML =
          '<tr><td colspan="4" style="padding:0.6rem; text-align:center; color:var(--ssu-danger);">Error loading paid students.</td></tr>';
      }
    };
    if (cashierLoadBalancesBtn) {
      cashierLoadBalancesBtn.addEventListener("click", loadStudentsWithBalance);
    }
    if (cashierLoadPaidBtn) {
      cashierLoadPaidBtn.addEventListener("click", loadStudentsPaid);
    }
    // Auto-load when opening the Cashier Transactions panel
    findNavButtons("cashier", "transactions").forEach((btn) => {
      btn.addEventListener("click", () => {
        // clear table until user chooses a view
        if (cashierBalanceBody) {
          cashierBalanceBody.innerHTML =
            '<tr><td colspan="4" style="padding:0.6rem; text-align:center; color:var(--ssu-muted);">Click "Students with balance" or "Students paid" to load data.</td></tr>';
        }
        if (cashierBalanceTitle) cashierBalanceTitle.textContent = "Students with remaining balance";
      });
    });

    // ==========================
    //  Registrar document preview (Firestore-backed)
    // ==========================
    const btnGenerateDoc = byId("btn-generate-doc");
    const btnClearDoc = byId("btn-clear-doc");
    if (btnGenerateDoc) {
      btnGenerateDoc.addEventListener("click", generateRegistrarDoc);
    }
    if (btnClearDoc && registrarDocPreview) {
      btnClearDoc.addEventListener("click", () => {
        if (registrarDocStudent) registrarDocStudent.value = "";
        registrarDocPreview.textContent = "Document preview will appear here.";
        if (registrarDocAlert) registrarDocAlert.classList.add("hidden");
      });
    }

    if (registrarProgramSelect) registrarProgramSelect.addEventListener("change", renderRegistrarStudents);
    if (registrarYearSelect) registrarYearSelect.addEventListener("change", renderRegistrarStudents);
    if (registrarStudentSearch) registrarStudentSearch.addEventListener("input", renderRegistrarStudents);

    // Registrar enroll student
    const handleRegistrarEnroll = async (e) => {
      e.preventDefault();
      if (!regEnrollId || !regEnrollName || !regEnrollProgram || !regEnrollYear) return;
      const id = regEnrollId.value.trim();
      const name = regEnrollName.value.trim();
      const classId = regEnrollClass?.value || "";
      const teacherUid = regEnrollTeacher?.value || "";
      const clsMeta = registrarClassesCache.find((c) => c.id === classId) || {};
      const sectionOverride = regEnrollSection?.value.trim() || "";
      const section = sectionOverride || clsMeta.section || "";
      const program = regEnrollProgram.value;
      const yearLevel = regEnrollYear.value;
      const status = "Pending"; // auto-pending on enrollment
      if (!id || !name || !classId || !teacherUid) {
        if (regEnrollAlert && regEnrollAlertText) {
          regEnrollAlert.classList.remove("alert-success", "hidden");
          regEnrollAlert.classList.add("alert-error");
          regEnrollAlertText.textContent = "Student ID, name, teacher, and class are required.";
        }
        return;
      }

      try {
        if (regEnrollAlert) regEnrollAlert.classList.add("hidden");

        await setDoc(doc(db, "students", id), {
          studentId: id,
          name,
          program,
          yearLevel,
          status,
          paymentStatus: "With balance",
          balance: 1500,
          gradesStatus: "Pending",
          classId,
          section,
          teacherUid,
          updatedAt: serverTimestamp(),
          createdAt: serverTimestamp(),
        }, { merge: true });

        if (classId) {
          await setDoc(doc(db, "classes", classId, "students", id), {
            studentId: id,
            name,
            program,
            yearLevel,
            status,
            paymentStatus: "With balance",
            balance: 1500,
            gradesStatus: "Pending",
            classId,
            section,
            teacherUid,
            updatedAt: serverTimestamp(),
            createdAt: serverTimestamp(),
          }, { merge: true });
        }

        await setDoc(doc(db, "enrollmentChecks", id), {
          studentId: id,
          studentName: name,
          program,
          programYear: `${program} ${yearLevel}`,
          hasCompleteGrades: false,
          hasClearedPayments: false,
          gradesStatus: "Pending",
          paymentStatus: "Pending",
          status: status === "Enrolled" ? "Ready" : status,
          isPending: true,
          updatedAt: serverTimestamp(),
          createdAt: serverTimestamp(),
        }, { merge: true });

        // Notify teacher that an enrollment was added and is pending
        if (teacherUid) {
          await sendNotification({
            toUid: teacherUid,
            type: "enrollment",
            title: "Enrollment added",
            message: `${name} (${id}) added to your class ${getClassLabel(classId) || ""} - status set to Pending.`,
          });
        }

        if (regEnrollAlert && regEnrollAlertText) {
          regEnrollAlert.classList.remove("alert-error", "hidden");
          regEnrollAlert.classList.add("alert-success");
          regEnrollAlertText.textContent = `Enrolled ${name} (${id}).`;
        }
        regEnrollForm?.reset();
      } catch (err) {
        console.error(err);
        if (regEnrollAlert && regEnrollAlertText) {
          regEnrollAlert.classList.remove("alert-success", "hidden");
          regEnrollAlert.classList.add("alert-error");
          regEnrollAlertText.textContent = "Error enrolling student. Please retry.";
        }
      }
    };

    if (regEnrollForm) regEnrollForm.addEventListener("submit", handleRegistrarEnroll);
    if (regEnrollClear) {
      regEnrollClear.addEventListener("click", () => {
        regEnrollForm?.reset();
        if (regEnrollAlert) regEnrollAlert.classList.add("hidden");
      });
    }
    if (regEnrollTeacher) {
      regEnrollTeacher.addEventListener("change", (e) => {
        const teacherUid = e.target.value || "";
        loadRegistrarClasses(teacherUid);
        if (regEnrollClass) regEnrollClass.value = "";
      });
    }

    // Registrar: update enrollment status (Pending/On hold/Ready)
    const handleRegistrarStatusUpdate = async (status) => {
      if (!registrarStatusActions) return;
      const sid = registrarStatusActions.dataset.studentId;
      if (!sid) return;
      try {
        const checkRef = doc(db, "enrollmentChecks", sid);
        const studentRef = doc(db, "students", sid);
        const checkSnap = await getDoc(checkRef);
        const stuSnap = await getDoc(studentRef);
        const studentData = stuSnap.exists() ? stuSnap.data() : {};
        const teacherUid =
          studentData.teacherUid ||
          (checkSnap.exists() && checkSnap.data().teacherUid) ||
          "";
        const studentName =
          studentData.name ||
          (checkSnap.exists() && checkSnap.data().studentName) ||
          sid;

        await setDoc(
          checkRef,
          {
            status,
            isPending: status !== "Ready",
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
        // Also reflect on student doc if present
        await setDoc(
          studentRef,
          {
            status,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );

        // Notify teacher if we know who owns the class
        if (teacherUid) {
          await sendNotification({
            toUid: teacherUid,
            type: "enrollment-status",
            title: "Enrollment status updated",
            message: `${studentName} (${sid}) is now "${status}".`,
          });
        }
      } catch (err) {
        console.error("Error updating enrollment status:", err);
      }
    };

    if (registrarStatusActions) {
      registrarStatusActions.querySelectorAll("button[data-status]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const status = btn.getAttribute("data-status");
          handleRegistrarStatusUpdate(status);
        });
      });
    }

    if ((regOpenRequestBtn || regOpenRequestCta) && regRequestModal) {
      const closeBtn = regRequestModal.querySelector("#reg-request-close");
      const hideModal = () => regRequestModal.classList.add("hidden");
      const openModal = () => regRequestModal.classList.remove("hidden");
      if (regOpenRequestBtn) regOpenRequestBtn.addEventListener("click", openModal);
      if (regOpenRequestCta) regOpenRequestCta.addEventListener("click", openModal);
      if (closeBtn) closeBtn.addEventListener("click", hideModal);
      regRequestModal.addEventListener("click", (e) => {
        if (e.target === regRequestModal) hideModal();
      });
    }
    if (regToggleRequests && regRequestsContainer) {
      regToggleRequests.addEventListener("click", () => {
        const hidden = regRequestsContainer.classList.contains("hidden");
        if (hidden) {
          regRequestsContainer.classList.remove("hidden");
          regToggleRequests.textContent = "Hide requests";
        } else {
          regRequestsContainer.classList.add("hidden");
          regToggleRequests.textContent = "Show requests";
        }
      });
    }
    if (regToggleReport && regReportContainer) {
      regToggleReport.addEventListener("click", () => {
        const hidden = regReportContainer.classList.contains("hidden");
        if (hidden) {
          regReportContainer.classList.remove("hidden");
          regToggleReport.textContent = "Hide requests";
        } else {
          regReportContainer.classList.add("hidden");
          regToggleReport.textContent = "Show requests";
        }
      });
    }

    // Enrollment request submitter (inside Registrar area)
    if (publicEnrollForm) {
      publicEnrollForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (publicEnrollAlert) publicEnrollAlert.classList.add("hidden");
        const id = publicEnrollId?.value.trim();
        const name = publicEnrollName?.value.trim();
        const program = publicEnrollProgram?.value || "BSIT";
        const yearLevel = publicEnrollYear?.value || "1";
        const reason = publicEnrollReason?.value.trim() || "";
        if (!id || !name) {
          if (publicEnrollAlert && publicEnrollAlertText) {
            publicEnrollAlert.classList.remove("alert-success", "hidden");
            publicEnrollAlert.classList.add("alert-error");
            publicEnrollAlertText.textContent = "Student ID and name are required.";
          }
          return;
        }
        try {
          await addDoc(collection(db, "enrollmentRequests"), {
            studentId: id,
            name,
            program,
            yearLevel,
            reason,
            status: "Pending",
            createdAt: serverTimestamp(),
          });
          if (publicEnrollAlert && publicEnrollAlertText) {
            publicEnrollAlert.classList.remove("alert-error", "hidden");
            publicEnrollAlert.classList.add("alert-success");
            publicEnrollAlertText.textContent = "Enrollment request submitted.";
          }
          publicEnrollForm.reset();
          regRequestModal.classList.add("hidden");
        } catch (err) {
          console.error("Error submitting enrollment request:", err);
          if (publicEnrollAlert && publicEnrollAlertText) {
            publicEnrollAlert.classList.remove("alert-success", "hidden");
            publicEnrollAlert.classList.add("alert-error");
            publicEnrollAlertText.textContent = "Error submitting request.";
          }
        }
      });
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        hideAllModules();
        show(authContainer);
        return;
      }
      try {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists()) {
          const data = snap.data();
          routeToRole(data.role || "teacher", data.name || "SSU User", user.uid, data.tutorialSeen, data.gamerMode);
        } else {
          await signOut(auth);
          hideAllModules();
          show(authContainer);
        }
      } catch (err) {
        console.error(err);
        hideAllModules();
        show(authContainer);
      }
    });

    hideAllModules();
    show(authContainer);
  </script>

</body>

</html>
